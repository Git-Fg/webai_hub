(function(){"use strict";function u(o){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler("automationBridge",o)}function E(o,t,e=!1){try{const n=o.split(":contains")[0],l=document.querySelectorAll(n||"*");for(const r of l){const s=r.textContent||"",c=e?s:s.toLowerCase(),a=e?t:t.toLowerCase();if(c.includes(a))return r}}catch{}return null}function d(o,t=1e4){return new Promise((e,n)=>{let r=0;const s=setInterval(()=>{for(const c of o){let a=null;if(c.includes(":contains(")){const i=c.match(/^(.+):contains\(['"](.+)['"]\)$/);i&&i[1]&&i[2]&&(a=E(i[1],i[2]))}else try{a=document.querySelector(c),!a&&r===0&&console.log(`[waitForElement] Selector "${c}" not found on first attempt`)}catch(i){console.warn(`[waitForElement] Invalid selector "${c}":`,i);continue}if(a){console.log(`[waitForElement] Found element with selector "${c}"`),clearInterval(s),e(a);return}}r+=300,r>=t&&(clearInterval(s),n(new Error(`None of the selectors [${o.join(", ")}] found within ${t}ms`)))},300)})}const h=["ms-incognito-mode-toggle > button","button.runsettings-toggle-button","button.model-selector-card","ms-chunk-input textarea"],w="ms-chunk-input textarea",y="ms-run-button > button",m='mat-icon[data-mat-icon-name="stop"]',S='ms-chat-turn[data-turn-role="Model"]',T='ms-chat-turn .turn-footer button[iconname="thumb_up"]',A="span.v3-token-count-value",I=["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']","textarea[placeholder*='typing a prompt']","input[placeholder*='Start typing a prompt']","input[placeholder*='typing a prompt']","textarea[placeholder*='prompt']","input[placeholder*='prompt']","input-area","textarea[aria-label*='prompt']","textarea[name*='prompt']","textarea[id*='prompt']",".ql-editor","div[contenteditable='true']","textarea","input[type='text']"],O=['ms-run-button > button[aria-label="Run"]',"ms-run-button > button",'button[aria-label="Run"]','button[aria-label*="Run"]','button[aria-label*="Append to prompt and run"]','button[aria-label*="Append to Prompt and run"]','button[aria-label*="run"]','send-button[variant="primary"]','button[aria-label*="Send"]','button:contains("Run")',".send-button button",'button[type="submit"]',"button"],N=['mat-icon[data-mat-icon-name="stop"]',"ms-thought-chunk .thinking-progress-icon.in-progress","ms-thought-chunk",".generating-indicator",".loading-indicator","[data-testid*='generating']",".spinner",".loading-spinner",".thinking-indicator"];function R(){const o=window.location.href.toLowerCase();if(o.includes("accounts.google.com")||o.includes("/signin"))return!0;const t=document.querySelector('input[placeholder*="Email or phone"], input[type="email"]'),e=document.body?.innerText?.includes("Sign in")||document.body?.innerText?.includes("Use your Google Account");return t&&e?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}function x(){const o=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]')),t=Array.from(document.querySelectorAll("button"));console.log("[AI Studio] Found inputs:",o.map(e=>({tag:e.tagName,type:e.getAttribute("type"),placeholder:e.getAttribute("placeholder"),ariaLabel:e.getAttribute("aria-label"),id:e.id,className:e.className,contentEditable:e.contentEditable}))),console.log("[AI Studio] Found buttons:",t.slice(0,10).map(e=>({tag:e.tagName,ariaLabel:e.getAttribute("aria-label"),text:e.innerText?.substring(0,50),id:e.id,className:e.className,type:e.getAttribute("type")})))}function v(o){const t=o.cloneNode(!0);t.querySelector(".turn-footer")?.remove(),t.querySelector(".author-label")?.remove(),t.querySelector(".actions-container")?.remove(),t.querySelector("ms-thought-chunk")?.remove(),t.querySelectorAll('button, nav, [role="button"], [aria-label*="Edit"], [aria-label*="Rerun"], [aria-label*="Good"], [aria-label*="Bad"], [aria-label*="More"], .scrollbar-item, .navigation, [data-testid*="button"]').forEach(l=>l.remove());let n=(t.textContent||t.innerText||"").trim();return n=n.replace(/\n{3,}/g,`

`),n=n.replace(/^\s+|\s+$/gm,""),n}const g={waitForReady:async()=>{await d(h,2e4),console.log("[AI Studio] UI is ready.")},sendPrompt:async o=>{if(console.log("[AI Studio] Starting automation with prompt:",o.substring(0,50)),R()){console.log("[AI Studio] Login page detected. Pausing automation."),u({type:"LOGIN_REQUIRED",location:"sendPrompt",payload:"User needs to sign in to Google Account"});return}x(),console.log("[AI Studio] Waiting for input area...");const t=await d([w,...I]);if(console.log("[AI Studio] Found input area:",t.tagName,t.className),t.tagName==="TEXTAREA"||t.tagName==="INPUT"){const n=t;n.value=o,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}else if(t instanceof HTMLElement&&t.contentEditable==="true"){const n=t;n.innerText=o,t.dispatchEvent(new Event("input",{bubbles:!0}))}else{const n=t;n.click(),await new Promise(r=>setTimeout(()=>r(),500));const l=n;l.value!==void 0&&(l.value=o)}await new Promise(n=>{const l=()=>{const s=document.querySelector(A)?.textContent?.trim();s&&!s.startsWith("0")?(console.log("[AI Studio] Token count updated."),n()):setTimeout(l,100)};l()}),console.log("[AI Studio] Waiting for send button...");const e=await d([y,...O]);console.log("[AI Studio] Found send button:",e.tagName,e.className,e.getAttribute("aria-label")),e.click(),console.log("[AI Studio] Clicked send button");try{await d([m,...N],1e4),console.log("[AI Studio] Generation started, observing for completion...")}catch{console.log("[AI Studio] Generation indicator not found, assuming generation is fast and complete."),u({type:"GENERATION_COMPLETE"});return}await new Promise(n=>{const l=new MutationObserver(()=>{document.querySelector(m)||(console.log("[AI Studio] Generation indicator disappeared."),u({type:"GENERATION_COMPLETE"}),l.disconnect(),clearTimeout(r),n())});l.observe(document.body,{childList:!0,subtree:!0});const r=setTimeout(()=>{console.warn("[AI Studio] Generation observer timed out."),u({type:"GENERATION_COMPLETE"}),l.disconnect(),n()},6e4)})},extractResponse:async()=>{console.log("[AI Studio] Starting extraction...");try{await d([T],3e3),console.log("[AI Studio] Response footer detected, response is stable.")}catch{console.log("[AI Studio] Footer not found, assuming response is ready.")}const o=document.querySelectorAll(S);if(console.log(`[AI Studio] Found ${o.length} model turn(s)`),o.length===0)throw new Error("No model turns found on the page.");const t=o[o.length-1],e=v(t);if(!e)throw new Error("Extraction resulted in an empty string after cleaning.");return console.log("[AI Studio] Returning value:",`"${e.substring(0,100)}..."`,"with type:",typeof e),e}},_={"https://aistudio.google.com/prompts/new_chat":g};function b(){const o=window.location.href;if(o.startsWith("file://")||document.querySelector("ms-chunk-input textarea")!==null||document.querySelector("h1")?.textContent?.includes("High-Fidelity Sandbox"))return console.log("[Engine] Local sandbox detected. Using AI Studio chatbot module for testing."),g;for(const[e,n]of Object.entries(_))if(o.startsWith(e))return console.log(`[Engine] Matched site: ${e}. Using corresponding chatbot module.`),n;return console.error(`[Engine] No chatbot module found for current URL: ${o}`),null}window.startAutomation=async function(o){const t=b();if(!t){u({type:"AUTOMATION_FAILED",errorCode:"UNSUPPORTED_SITE",payload:"This site is not supported."});return}try{console.log("[Engine] Waiting for chatbot page to be ready..."),await t.waitForReady(),console.log("[Engine] Page is ready. Sending prompt..."),await t.sendPrompt(o),console.log("[Engine] Prompt sent and generation completed successfully.")}catch(e){const n=e instanceof Error?e.message:String(e);throw u({type:"AUTOMATION_FAILED",errorCode:"AUTOMATION_EXECUTION_FAILED",location:"startAutomation",payload:n}),e}},window.extractFinalResponse=async function(){const o=b();if(!o){const t="This site is not supported for extraction.";throw u({type:"AUTOMATION_FAILED",errorCode:"UNSUPPORTED_SITE",payload:t}),new Error(t)}try{return await o.extractResponse()}catch(t){const e=t instanceof Error?t.message:String(t);throw u({type:"AUTOMATION_FAILED",errorCode:"RESPONSE_EXTRACTION_FAILED",location:"extractFinalResponse",payload:e}),t}};function p(o,t=document){try{const e=t.querySelector(o);if(e)return e;const n=t.querySelectorAll("*");for(const l of n)if(l.shadowRoot){const r=p(o,l.shadowRoot);if(r)return r}}catch{}return null}window.inspectDOMForSelectors=function(){const o={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},t=document.querySelectorAll("*");for(const a of t)if(a.shadowRoot){o.shadowDOMDetected=!0;break}const e=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],n={};for(const a of e)try{n[a]=document.querySelector(a),n[a]||(n[`${a} (shadow)`]=p(a))}catch{n[a]=null}o.allSelectorsTested.promptInput=n;const l=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],r={};for(const a of l)try{r[a]=document.querySelector(a),r[a]||(r[`${a} (shadow)`]=p(a))}catch{r[a]=null}o.allSelectorsTested.sendButton=r;const s=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));o.inputs=s.map(a=>{const i=a;return{tag:a.tagName.toLowerCase(),type:i.getAttribute("type")||"",placeholder:i.getAttribute("placeholder")||"",ariaLabel:i.getAttribute("aria-label")||"",id:a.id||"",className:a.className||"",contentEditable:i.contentEditable,visible:i.offsetParent!==null,inShadowDOM:!1}});const c=Array.from(document.querySelectorAll("button"));return o.buttons=c.map(a=>{const i=a;return{tag:a.tagName.toLowerCase(),ariaLabel:i.getAttribute("aria-label")||"",text:(i.innerText||"").substring(0,100),id:a.id||"",className:a.className||"",type:i.getAttribute("type")||"",visible:i.offsetParent!==null,inShadowDOM:!1}}),o};function L(){const o=window;if(o.flutter_inappwebview)try{o.flutter_inappwebview.callHandler("bridgeReady"),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(t){console.warn("[Engine] Failed to send bridge ready signal:",t)}}function f(o=100,t=300){if(o<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview?L():setTimeout(()=>f(o-1,t),t)}console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),console.log("[Engine] startAutomation available:",typeof window.startAutomation),console.log("[Engine] extractFinalResponse available:",typeof window.extractFinalResponse),console.log("[Engine] window.flutter_inappwebview available:",typeof window.flutter_inappwebview),console.log("[Engine] Document ready state:",document.readyState),console.log("[Engine] Document body exists:",!!document.body),f()})();
