(function(){"use strict";const F="automationBridge",H="bridgeReady",W="NEW_RESPONSE_DETECTED",q="LOGIN_REQUIRED",L="AUTOMATION_FAILED",V="AUTOMATION_RETRY_REQUIRED";function I(a){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler(F,a)}function A(a){const t=window.__AI_TIMEOUT_MODIFIER__??1;return a*t}const N=1e4,G=300,M=2,Y=300,K=2e3;function X(){return{url:window.location.href,readyState:document.readyState,visibleElementsCount:document.querySelectorAll("*").length}}function $(a,t,n,e="waitForElement"){const r=X();return`${e} failed: None of the selectors [${a.join(", ")}] found within ${t}ms
Context: URL=${r.url}, Timeout=${t}ms, Elapsed=${n}ms
Page State: Ready=${r.readyState}, VisibleElements=${r.visibleElementsCount}`}function B(a,t,n){for(let e=0;e<a.length;e++){const r=a[e];if(!r)continue;let o=null;try{t?o=t.querySelector(r):o=document.querySelector(r)}catch(s){console.warn(`[${n}] Invalid selector "${r}" (index ${e}):`,s);continue}if(o)return o}return null}async function v(a,t,n="waitForElement",e){return new Promise((r,o)=>{const s=Date.now();let g=0,E=null,i=null,l=null,c=!1;console.log(`[${n}] Starting search for selectors: [${a.join(", ")}] (timeout: ${t}ms)`);const u=()=>{E&&(E.disconnect(),E=null),i!==null&&(clearTimeout(i),i=null),l!==null&&(clearInterval(l),l=null)},f=()=>{const d=Date.now()-s;d-g>=K&&(console.log(`[${n}] Still searching... (elapsed: ${d}ms, remaining: ${t-d}ms)`),g=d),c||(B(a,e,n)||console.log(`[${n}] Selectors not found on first attempt`),c=!0);const S=B(a,e,n);if(S){const w=Date.now()-s,m=a.find(b=>{if(!b)return!1;try{return e?e.querySelector(b)===S:document.querySelector(b)===S}catch{return!1}});console.log(`[${n}] Found element with selector "${m||"unknown"}" after ${w}ms`),u(),r(S);return}if(d>=t){u();const w=$(a,t,d,n);o(new Error(w))}};if(typeof MutationObserver<"u"){E=new MutationObserver(()=>{f()});const d=e||document.body;E.observe(d,{childList:!0,subtree:!0}),f()}else console.warn(`[${n}] MutationObserver not available, using polling fallback`),l=window.setInterval(f,G),f();i=window.setTimeout(()=>{u();const d=Date.now()-s,S=$(a,t,d,n);o(new Error(S))},t)})}function O(a,t=N,n=M){const e=A(t);return D(()=>v(a,e,"waitForElement"),n,"waitForElement")}function Z(a,t,n=N,e=M){const r=A(n);return D(()=>v(t,r,"waitForElementWithin",a),e,"waitForElementWithin")}function P(a,t,n=N,e=M){const r=A(n);return D(()=>j(a,t,r),e,"waitForElementByText")}async function j(a,t,n){return new Promise((e,r)=>{const o=Date.now();let s=null,g=null;const E=()=>{s&&(s.disconnect(),s=null),g!==null&&(clearTimeout(g),g=null)},i=()=>{const l=document.querySelectorAll(a);for(const u of l)if(u.textContent?.includes(t)){const f=Date.now()-o;console.log(`[waitForElementByText] Found element with text "${t}" after ${f}ms`),E(),e(u);return}Date.now()-o>=n&&(E(),r(new Error(`Element with selector "${a}" containing text "${t}" not found within ${n}ms`)))};if(typeof MutationObserver<"u")s=new MutationObserver(()=>{i()}),s.observe(document.body,{childList:!0,subtree:!0}),i();else{console.warn("[waitForElementByText] MutationObserver not available, using polling fallback");const l=window.setInterval(i,G);i(),g=window.setTimeout(()=>{clearInterval(l),E(),r(new Error(`Element with selector "${a}" containing text "${t}" not found within ${n}ms`))},n)}})}async function D(a,t,n){let e=null;for(let r=0;r<=t;r++)try{return await a()}catch(o){if(e=o instanceof Error?o:new Error(String(o)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors"))||r>=t)throw e;const g=Y*Math.pow(2,r);console.log(`[${n}] Retry ${r+1}/${t} after ${g}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(E=>setTimeout(E,g))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}const z=1e4,Q=2,U=1e3,J=2e3;function tt(a){return a.isConnected===!0}function et(a){if(typeof a.checkVisibility=="function")try{return a.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}catch{}return a.offsetParent!==null}async function nt(a,t=U){try{const n=a.getAnimations();if(n.length===0)return!0;const e=n.map(o=>o.finished);return await Promise.race([Promise.all(e),new Promise(o=>setTimeout(o,t))]),a.getAnimations().length===0}catch{return!0}}function ot(a){if(a.disabled===!0||a.getAttribute("aria-disabled")==="true"||a.hasAttribute("inert"))return!1;let n=a.parentElement;for(;n;){if(n.hasAttribute("inert"))return!1;n=n.parentElement}return!0}function it(a){try{const t=a.getBoundingClientRect(),n=t.left+t.width/2,e=t.top+t.height/2,r=document.elementFromPoint(n,e);return r?a.contains(r)||r===a:!1}catch{return!0}}async function k(a,t=U){const n=a,e={attached:!1,visible:!1,stable:!1,enabled:!1,unoccluded:!1,details:{}};if(e.attached=tt(a),e.details.isConnected=a.isConnected,!e.attached)return{actionable:!1,diagnostics:e};e.visible=et(n);try{typeof n.checkVisibility=="function"&&(e.details.checkVisibilityResult=n.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0}))}catch{}if(e.details.offsetParent=n.offsetParent,!e.visible)return{actionable:!1,diagnostics:e};e.stable=await nt(n,t);try{const o=n.getAnimations();e.details.animationsCount=o.length}catch{}if(!e.stable)return{actionable:!1,diagnostics:e};if(e.enabled=ot(n),e.details.disabled=n.disabled,e.details.ariaDisabled=n.getAttribute("aria-disabled"),e.details.inert=n.hasAttribute("inert"),!e.enabled)return{actionable:!1,diagnostics:e};if(e.unoccluded=it(n),!e.unoccluded)try{const o=n.getBoundingClientRect(),s=o.left+o.width/2,g=o.top+o.height/2;e.details.occludingElement=document.elementFromPoint(s,g)}catch{}return{actionable:e.attached&&e.visible&&e.stable&&e.enabled&&e.unoccluded,diagnostics:e}}function rt(a,t,n,e="element"){const r=[];n.attached||r.push("not attached to DOM"),n.visible||r.push("not visible"),n.stable||r.push("has ongoing animations"),n.enabled||r.push("disabled or inert"),n.unoccluded||r.push("occluded by another element");const o={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};return`${e} is not actionable: ${r.join(", ")}
Selectors: [${a.join(", ")}]
Timeout: ${t}ms
Diagnostics: ${JSON.stringify(n.details,null,2)}
Page State: URL=${o.url}, ReadyState=${o.readyState}, VisibleElements=${o.visibleElements}`}async function at(a,t,n,e){const r=Date.now();let o=0;return console.log(`[waitForActionableElement] Starting search for actionable ${t} with selectors: [${a.join(", ")}] (timeout: ${n}ms)`),new Promise((s,g)=>{let E=null,i=null,l=null;const c=()=>{E&&(E.disconnect(),E=null),i!==null&&(clearTimeout(i),i=null),l!==null&&(clearInterval(l),l=null)},u=async()=>{const f=Date.now()-r;f-o>=J&&(console.log(`[waitForActionableElement] Still checking actionability for ${t}... (elapsed: ${f}ms)`),o=f);for(const d of a){if(!d)continue;let S=null;try{e||(S=document.querySelector(d))}catch(w){console.warn(`[waitForActionableElement] Invalid selector "${d}":`,w);continue}if(S){const{actionable:w,diagnostics:m}=await k(S);if(w){const b=Date.now()-r;console.log(`[waitForActionableElement] Found actionable ${t} with selector "${d}" after ${b}ms`),c(),s(S);return}else console.log(`[waitForActionableElement] Element found but not actionable: ${JSON.stringify(m.details)}`)}}if(f>=n){c();let d=null;for(const S of a)try{if(e||(d=document.querySelector(S)),d)break}catch{}if(d){const{diagnostics:S}=await k(d);g(new Error(rt(a,n,S,t)))}else g(new Error(`waitForActionableElement failed: None of the selectors [${a.join(", ")}] found within ${n}ms`))}};if(typeof MutationObserver<"u"){E=new MutationObserver(()=>{u()});const f=document.body;E.observe(f,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","inert","style","class"]}),u()}else console.warn("[waitForActionableElement] MutationObserver not available, using polling fallback"),l=window.setInterval(u,100),u();i=window.setTimeout(()=>{c(),u()},n)})}function p(a,t="element",n=z,e=Q){const r=A(n);return st(()=>at(a,t,r),e,`waitForActionableElement(${t})`)}async function st(a,t,n){let e=null;const r=300;for(let o=0;o<=t;o++)try{return await a()}catch(s){if(e=s instanceof Error?s:new Error(String(s)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors")||e.message.includes("not actionable"))||o>=t)throw e;const E=r*Math.pow(2,o);console.log(`[${n}] Retry ${o+1}/${t} after ${E}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(i=>setTimeout(i,E))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}function h(a,t,n="DOM assertion"){if(!a)throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but the element is null.`);if(!(a instanceof t))throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but got ${a.constructor.name}.`);return a}const y=1e4,_={READINESS_CHECK_INTERVAL_MS:100,TOKEN_COUNT_UPDATE_TIMEOUT_MS:1e4,TOKEN_COUNT_CHECK_INTERVAL_MS:100,UI_STABILIZE_AFTER_TOKEN_COUNT_MS:30,FINALIZED_TURN_TIMEOUT_MS:15e3,FINALIZED_TURN_CHECK_INTERVAL_MS:1e3,EDIT_BUTTON_WAIT_TIMEOUT_MS:2e3,TEXTAREA_APPEAR_TIMEOUT_MS:5e3,UI_STABILIZE_DELAY_MS:150,PANEL_ANIMATION_MS:250,POLL_INTERVAL_MS:100,POLL_TIMEOUT_MS:5e3},T={NEW_CHAT_BUTTON:'a[href="/prompts/new_chat"]',RUN_SETTINGS_TOGGLE_MOBILE:"button.runsettings-toggle-button",MODEL_SELECTOR_DESKTOP:"button.model-selector-card",PROMPT_INPUTS:["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']"],SEND_BUTTONS:['ms-run-button > button[aria-label="Run"]','ms-run-button > button[type="submit"]','button[aria-label="Run"]',"ms-run-button > button"],TOKEN_COUNT:"span.v3-token-count-value",EDIT_BUTTON:['button[aria-label="Edit"]','button[aria-label*="edit" i]','button:has([aria-label*="edit" i])'],EDIT_TEXTAREA:["textarea",'div[contenteditable="true"]','[contenteditable="true"]'],STOP_EDITING_BUTTON:'button[aria-label="Stop editing"]',CHAT_TURN:['[id^="turn-"]',"ms-chat-turn"],SETTINGS_PANEL_MOBILE_TOGGLE:['button[aria-label="Toggle run settings panel"]',"button.runsettings-toggle-button"],SETTINGS_PANEL_CLOSE_BUTTON:'ms-run-settings button[iconname="close"]',MODEL_SELECTOR_CARD:"button.model-selector-card",MODEL_CATEGORIES_ALL_BUTTON:"button[data-test-category-button]",MODEL_CAROUSEL_BUTTON:"ms-model-carousel-row button.content-button",MODEL_TITLE_TEXT:"span.model-title-text",SYSTEM_PROMPT_CARD:"button[data-test-system-instructions-card]",SYSTEM_PROMPT_TEXTAREA:"ms-system-instructions textarea",DIALOG_CLOSE_BUTTON:"mat-dialog-container button[data-test-close-button]",MODEL_DIALOG_CONTAINER:"mat-dialog-container",ADVANCED_SETTINGS_TOGGLE:"div.settings-item",THINKING_TOGGLE:'mat-slide-toggle[data-test-toggle="enable-thinking"] button',MANUAL_BUDGET_TOGGLE:'mat-slide-toggle[data-test-toggle="manual-budget"] button',BUDGET_INPUT:'div[data-test-id="user-setting-budget-animation-wrapper"] input',TOOLS_TOGGLE_SELECTOR:"div.settings-item",WEB_SEARCH_TOGGLE:'div[data-test-id="searchAsAToolTooltip"] button',URL_CONTEXT_TOGGLE:'div[data-test-id="browseAsAToolTooltip"] button'},R={SCREEN_WIDTH_BREAKPOINT_PX:960,LOG_PREVIEW_LENGTH:50};class lt{getPageStateContext(){const t=document.querySelectorAll("*").length;return`URL=${window.location.href}, ReadyState=${document.readyState}, VisibleElements=${t}`}createErrorWithContext(t,n,e){const r=this.getPageStateContext(),o=e?`${r}, ${e}`:r;return new Error(`${t} failed: ${n}
Context: ${o}`)}async retryOperation(t,n,e=2,r=300){let o=null;for(let s=0;s<=e;s++)try{return await t()}catch(g){if(o=g instanceof Error?g:new Error(String(g)),s>=e)throw this.createErrorWithContext(n,o.message,`Retries=${e}, Attempt=${s+1}`);const E=r*Math.pow(2,s);console.log(`[AI Studio LOG] ${n} failed, retrying ${s+1}/${e} after ${E}ms. Error: ${o.message.split(`
`)[0]}`),await new Promise(i=>setTimeout(i,E))}throw o||new Error(`${n} failed after ${e} retries`)}isLoginPage(){const t=window.location.href.toLowerCase();if(t.includes("accounts.google.com")||t.includes("/signin"))return!0;const n=document.querySelector('input[type="email"]'),e=document.body?.innerText?.includes("Sign in");return n&&e?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}async openSettingsPanel(){if(window.innerWidth<=R.SCREEN_WIDTH_BREAKPOINT_PX){if(document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel is already open.");return}try{const t=await p(Array.isArray(T.SETTINGS_PANEL_MOBILE_TOGGLE)?T.SETTINGS_PANEL_MOBILE_TOGGLE:[T.SETTINGS_PANEL_MOBILE_TOGGLE],"Settings panel toggle button",A(y),2);h(t,HTMLButtonElement,"Settings panel toggle button").click(),await new Promise(r=>setTimeout(r,_.PANEL_ANIMATION_MS)),document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)||(console.warn("[AI Studio LOG] Settings panel may not have opened properly. Retrying..."),await new Promise(r=>setTimeout(r,_.PANEL_ANIMATION_MS))),console.log("[AI Studio LOG] Settings panel opened successfully.")}catch(t){throw this.createErrorWithContext("openSettingsPanel",`Failed to open settings panel: ${t instanceof Error?t.message:String(t)}`)}}}async closeSettingsPanel(){if(window.innerWidth<=R.SCREEN_WIDTH_BREAKPOINT_PX){if(!document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel appears to be already closed.");return}try{const t=await p([T.SETTINGS_PANEL_CLOSE_BUTTON],"Settings panel close button",A(2e3),0);h(t,HTMLButtonElement,"Settings panel close button").click(),await new Promise(e=>setTimeout(e,_.PANEL_ANIMATION_MS)),console.log("[AI Studio LOG] Settings panel closed successfully.")}catch(t){console.warn("[AI Studio LOG] Could not close settings panel, but continuing:",t)}}}async setSliderValueByLabel(t,n){try{const e=await P("h3",t);if(!e)throw this.createErrorWithContext("setSliderValueByLabel",`Could not find '${t}' label in settings panel.`);const r=e.closest(".settings-item-column");if(!r)throw this.createErrorWithContext("setSliderValueByLabel",`Could not find parent container for '${t}' label.`);const o=r.querySelector("input[type=number]");if(!o)throw this.createErrorWithContext("setSliderValueByLabel",`Found '${t}' label but could not find its input field.`);if(o.offsetParent===null||o.disabled)throw this.createErrorWithContext("setSliderValueByLabel",`Input field for '${t}' is not actionable (visible: ${o.offsetParent!==null}, disabled: ${o.disabled})`);o.value=n.toString(),o.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set ${t} to ${n} successfully.`)}catch(e){throw this.createErrorWithContext("setSliderValueByLabel",`Failed to set ${t}: ${e instanceof Error?e.message:String(e)}`,`LabelName=${t}, Value=${n}`)}}async _setModel(t){return console.log(`[AI Studio LOG] Setting model to: "${t}"`),this.retryOperation(async()=>{const n=await p([T.MODEL_SELECTOR_CARD],"Model selector card",A(y),2),e=h(n,HTMLButtonElement,"Model selector card"),r=e.querySelector("span.title");if(r&&r.textContent?.trim()===t){console.log(`[AI Studio LOG] Model "${t}" is already selected. Skipping.`);return}e.click(),await O([T.MODEL_DIALOG_CONTAINER],A(3e3));let o=null;try{o=await p([T.MODEL_CATEGORIES_ALL_BUTTON],"Model categories all button",A(y),2)}catch(i){if((i instanceof Error?i.message:String(i)).includes("occluded")){console.log("[AI Studio LOG] Element found but occluded. Waiting longer and attempting click anyway..."),await new Promise(u=>setTimeout(u,_.PANEL_ANIMATION_MS));const c=document.querySelector(T.MODEL_CATEGORIES_ALL_BUTTON);if(c&&c.offsetParent!==null)o=c,console.log("[AI Studio LOG] Found element despite occlusion, will attempt click.");else throw i}else throw i}const s=h(o,HTMLButtonElement,"Model categories all button");s.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise(i=>setTimeout(i,_.UI_STABILIZE_DELAY_MS)),s.click(),await new Promise(i=>setTimeout(i,_.UI_STABILIZE_DELAY_MS));const g=Array.from(document.querySelectorAll(T.MODEL_CAROUSEL_BUTTON)),E=g.find(i=>{const l=i.textContent?.trim()||"";return(i.querySelector(T.MODEL_TITLE_TEXT)?.textContent?.trim()||"")===t||l.startsWith(t)});if(E){if(E.offsetParent===null)throw this.createErrorWithContext("_setModel",`Model button for "${t}" is not visible`);E.click(),console.log(`[AI Studio LOG] Success: Clicked model button for "${t}".`),await new Promise(i=>setTimeout(i,_.PANEL_ANIMATION_MS))}else{const i=g.map(l=>l.querySelector(T.MODEL_TITLE_TEXT)?.textContent?.trim()||l.textContent?.trim()||"unknown").join(", ");throw this.createErrorWithContext("_setModel",`Model button for "${t}" not found.`,`AvailableModels=[${i}]`)}if(document.querySelector("mat-dialog-container"))try{const i=await p([T.DIALOG_CLOSE_BUTTON],"Dialog close button",A(2e3),0);h(i,HTMLButtonElement,"Dialog close button").click(),await new Promise(c=>setTimeout(c,_.PANEL_ANIMATION_MS))}catch{console.log("[AI Studio LOG] Model dialog seems to have closed automatically.")}},"_setModel",2,300)}async _setTemperature(t){console.log(`[AI Studio LOG] Setting Temperature to: ${t}`),await this.setSliderValueByLabel("Temperature",t)}async _setTopP(t){console.log(`[AI Studio LOG] Setting Top-P to: ${t}`);const e=(await P("p","Advanced settings")).closest(T.ADVANCED_SETTINGS_TOGGLE);e&&!e.classList.contains("expanded")&&(e.click(),await new Promise(r=>setTimeout(r,_.PANEL_ANIMATION_MS))),await this.setSliderValueByLabel("Top P",t)}async _setThinkingBudget(t){console.log(`[AI Studio LOG] Configuring thinking budget. Provided value: ${t}`);const n=await O([T.THINKING_TOGGLE]),e=h(n,HTMLButtonElement,"Thinking toggle"),r=e.getAttribute("aria-checked")==="true";t!=null&&!r&&(e.click(),console.log('[AI Studio LOG] Enabled "thinking" feature.'),await new Promise(E=>setTimeout(E,_.PANEL_ANIMATION_MS)));const o=await O([T.MANUAL_BUDGET_TOGGLE]),s=h(o,HTMLButtonElement,"Manual budget toggle"),g=s.getAttribute("aria-checked")==="true";if(t!=null){g||(s.click(),console.log('[AI Studio LOG] Enabled "manual budget".'),await new Promise(l=>setTimeout(l,_.PANEL_ANIMATION_MS)));const E=await O([T.BUDGET_INPUT]),i=h(E,HTMLInputElement,"Budget input");i.value=t.toString(),i.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`[AI Studio LOG] Success: Set budget input to ${t}.`)}else g&&(s.click(),console.log('[AI Studio LOG] Success: Disabled "manual budget" as no value was provided.'))}async _setAdvancedOptions(t,n){if(console.log("[AI Studio LOG] Setting advanced options:",t),t.disableThinking!==void 0)if(n?.toLowerCase()==="gemini-2.5-pro")console.log('[AI Studio LOG] Skipping "disableThinking" toggle as it is not applicable for gemini-2.5-pro.');else{const r=await O([T.THINKING_TOGGLE]),o=h(r,HTMLButtonElement,"Thinking toggle"),s=o.getAttribute("aria-checked")==="true",g=!t.disableThinking;g!==s&&(o.click(),console.log(`[AI Studio LOG] Toggled thinking to: ${g?"enabled":"disabled"}`))}if(t.useWebSearch!==void 0||t.urlContext!==void 0){const r=(await P("p","Tools")).closest(T.TOOLS_TOGGLE_SELECTOR);if(r&&!r.classList.contains("expanded")&&(r.click(),await new Promise(o=>setTimeout(o,_.PANEL_ANIMATION_MS))),t.useWebSearch!==void 0){const o=await O([T.WEB_SEARCH_TOGGLE]),s=h(o,HTMLButtonElement,"Web search toggle");t.useWebSearch!==(s.getAttribute("aria-checked")==="true")&&(s.click(),console.log(`[AI Studio LOG] Toggled web search to: ${t.useWebSearch}`))}if(t.urlContext!==void 0){const o=await O([T.URL_CONTEXT_TOGGLE]),s=h(o,HTMLButtonElement,"URL context toggle");t.urlContext!==(s.getAttribute("aria-checked")==="true")&&(s.click(),console.log(`[AI Studio LOG] Toggled URL context to: ${t.urlContext}`))}}}async resetState(){console.log("[AI Studio] Preparing to reset UI state...");try{const t=Array.isArray(T.SETTINGS_PANEL_MOBILE_TOGGLE)?T.SETTINGS_PANEL_MOBILE_TOGGLE[0]:T.SETTINGS_PANEL_MOBILE_TOGGLE,n=t?document.querySelector(t):null,e=document.querySelector(T.NEW_CHAT_BUTTON);if(!e||e.offsetParent===null){console.warn('[AI Studio] "New Chat" button not found, assuming clean state and proceeding.'),await this.waitForReady();return}if(e.click(),console.log('[AI Studio] "New Chat" clicked. Waiting for UI transition...'),n){const r=A(5e3),o=Date.now();for(;document.body.contains(n);){if(Date.now()-o>r)throw this.createErrorWithContext("resetState","Old settings button did not disappear within timeout.",`Timeout=${r}ms`);await new Promise(s=>setTimeout(s,50))}console.log("[AI Studio] Old UI elements have been removed.")}await this.waitForReady(),console.log("[AI Studio] State reset completed successfully.")}catch(t){console.error("[AI Studio] A non-critical error occurred during state reset. Continuing under assumption that UI is ready.",t),await this.waitForReady()}}async waitForReady(){await p(T.PROMPT_INPUTS,"Prompt Input Area"),console.log("[AI Studio] UI is fully actionable and ready (prompt input is available).")}async setSystemPrompt(t){if(t){console.log("[AI Studio LOG] Setting system prompt."),await this.openSettingsPanel();try{const n=await O([T.SYSTEM_PROMPT_CARD]);h(n,HTMLButtonElement,"System prompt card").click(),await new Promise(E=>setTimeout(E,_.PANEL_ANIMATION_MS));const r=await O([T.SYSTEM_PROMPT_TEXTAREA]),o=h(r,HTMLTextAreaElement,"System prompt textarea");o.value=t,o.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[AI Studio LOG] Success: System prompt entered.");const s=await O([T.DIALOG_CLOSE_BUTTON]);h(s,HTMLButtonElement,"Dialog close button").click(),await new Promise(E=>setTimeout(E,_.PANEL_ANIMATION_MS))}finally{await this.closeSettingsPanel()}}}async applyAllSettings(t){if(!(t.model||t.temperature!==void 0||t.topP!==void 0||t.thinkingBudget!==void 0||t.useWebSearch!==void 0||t.disableThinking!==void 0||t.urlContext!==void 0)){console.log("[AI Studio LOG] No settings to apply. Skipping panel.");return}await this.openSettingsPanel();try{t.model&&await this._setModel(t.model),t.temperature!==void 0&&await this._setTemperature(t.temperature),t.topP!==void 0&&await this._setTopP(t.topP),t.thinkingBudget!==void 0&&await this._setThinkingBudget(t.thinkingBudget);const e={useWebSearch:t.useWebSearch,disableThinking:t.disableThinking,urlContext:t.urlContext};Object.values(e).some(r=>r!==void 0)&&await this._setAdvancedOptions(e,t.model)}finally{await this.closeSettingsPanel()}}async sendPrompt(t){if(console.log("[AI Studio LOG] Starting automation with prompt:",t.substring(0,R.LOG_PREVIEW_LENGTH)),this.isLoginPage())return console.log("[AI Studio LOG] Login page detected. Notifying Dart."),I({type:q,location:"sendPrompt",payload:"User needs to sign in to Google Account"}),new Promise(()=>{});try{const n=await p(T.PROMPT_INPUTS,"Prompt input area",A(y),2);if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.log("[AI Studio LOG] Prompt entered into input area, waiting for token count update...");else{const e=n?n.constructor.name:"null";throw this.createErrorWithContext("sendPrompt","Input area is not a valid textarea or input element.",`ElementType=${e}`)}return await new Promise((e,r)=>{const o=A(_.TOKEN_COUNT_UPDATE_TIMEOUT_MS),s=Date.now(),g=()=>{if(Date.now()-s>o){r(new Error(`Token count did not update within ${o}ms.`));return}const l=document.querySelector(T.TOKEN_COUNT)?.textContent?.trim();l&&!l.startsWith("0")?(console.log(`[AI Studio LOG] Token count updated: ${l}`),e()):setTimeout(g,_.TOKEN_COUNT_CHECK_INTERVAL_MS)};g()}),await new Promise(e=>setTimeout(e,_.UI_STABILIZE_AFTER_TOKEN_COUNT_MS)),console.log("[AI Studio LOG] UI stabilized after token count, proceeding to send."),await this.closeSettingsPanel(),this.retryOperation(async()=>{const e=await p(T.SEND_BUTTONS,"Send button",A(y),2);h(e,HTMLElement,"Send button").click(),console.log("[AI Studio LOG] Send button clicked successfully.")},"sendPrompt (click send button)",2,300)}catch(n){throw this.createErrorWithContext("sendPrompt",`Failed to send prompt: ${n instanceof Error?n.message:String(n)}`,`PromptLength=${t.length}`)}}findTurnContainerFromEditButton(t){const n=Array.isArray(T.CHAT_TURN)?T.CHAT_TURN.join(","):T.CHAT_TURN;return t.closest(n)}async extractResponse(){console.log(`[AI Studio LOG] Starting extraction process... (timeout: ${_.FINALIZED_TURN_TIMEOUT_MS}ms)`);const t=(s=_.FINALIZED_TURN_TIMEOUT_MS)=>new Promise((g,E)=>{const i=Array.isArray(T.EDIT_BUTTON)?T.EDIT_BUTTON.join(","):T.EDIT_BUTTON;let l=null,c=null;const u=()=>{l&&l.disconnect(),c&&clearTimeout(c)},f=()=>{const d=document.querySelectorAll(i);if(d.length===0)return;const S=d[d.length-1],w=this.findTurnContainerFromEditButton(S);w&&!w.querySelector('button[aria-label="Stop editing"]')&&S.offsetParent!==null&&!S.disabled&&(console.log("[AI Studio LOG] Found finalized turn via MutationObserver check."),u(),g({turn:w,editButton:S}))};l=new MutationObserver(f),l.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-label","disabled"]}),c=window.setTimeout(()=>{u();const S=`Extraction timed out. Final state: ${document.querySelectorAll(i).length} edit buttons found. The last response may still be generating or the UI has changed.`;console.error(`[AI Studio LOG] ${S}`),E(new Error(S))},s),f()}),{turn:n,editButton:e}=await t();console.log("[AI Studio LOG] Finalized turn found, clicking edit button..."),e.click(),console.log("[AI Studio LOG] Waiting for textarea to appear...");const r=await Z(n,T.EDIT_TEXTAREA,_.TEXTAREA_APPEAR_TIMEOUT_MS);console.log("[AI Studio LOG] Textarea appeared, waiting for UI to stabilize..."),await new Promise(s=>setTimeout(s,_.UI_STABILIZE_DELAY_MS));const o=(r.value??r.innerText??"").trim();if(!o){const s="Textarea was found but it was empty.";throw console.error(`[AI Studio LOG] ${s}`),this.createErrorWithContext("extractResponse",s,"Textarea was found but contained no content")}console.log(`[AI Studio LOG] Extracted ${o.length} chars successfully.`);try{const s=n.querySelector(T.STOP_EDITING_BUTTON);s&&(s.click(),console.log("[AI Studio LOG] Exited edit mode successfully."))}catch(s){console.warn("[AI Studio LOG] Could not exit edit mode, but extraction was successful. This is non-critical.",s)}return o}}const ct=100,ut=300,dt=250,Et=0,Tt=100;function x(){if(window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function")try{window.flutter_inappwebview.callHandler(H),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(a){console.warn("[Engine] Failed to send bridge ready signal:",a)}}document.addEventListener("flutterInAppWebViewPlatformReady",()=>{console.log("[Engine] Received flutterInAppWebViewPlatformReady event"),x()});function C(a=ct,t=ut){if(a<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function"?x():setTimeout(()=>C(a-1,t),t)}if(window.__AI_HYBRID_HUB_INITIALIZED__&&(console.log("[Engine] Bridge script already initialized. Checking if functions exist..."),typeof window.startAutomation<"u"&&typeof window.extractFinalResponse<"u"&&typeof window.inspectDOMForSelectors<"u"?(console.log("[Engine] Functions exist, signaling ready."),C()):(console.warn("[Engine] Flag set but functions missing! Force re-initialization."),delete window.__AI_HYBRID_HUB_INITIALIZED__)),!window.__AI_HYBRID_HUB_INITIALIZED__){let a=function(){const i=window.location.href;for(const[l,c]of Object.entries(s))if(i.startsWith(l))return console.log(`[Engine] Matched site: ${l}. Using corresponding chatbot module.`),c;return console.error(`[Engine] No chatbot module found for current URL: ${i}`),null},t=function(i,l=document){try{const c=l.querySelector(i);if(c)return c;const u=l.querySelectorAll("*");for(const f of u)if(f.shadowRoot){const d=t(i,f.shadowRoot);if(d)return d}}catch{}return null},n=function(){E&&clearTimeout(E),E=window.setTimeout(()=>{const i=document.querySelector(".model-error mat-icon");if(i&&i.textContent?.trim()==="error"&&!window.__hasAttemptedRetry){window.__hasAttemptedRetry=!0,console.warn("[Observer] Detected transient model error. Requesting retry from Dart."),I({type:V}),o();return}const l='[id^="turn-"], ms-chat-turn',c='button[aria-label="Edit"]',u=document.querySelectorAll(l);if(u.length===0)return;const f=u[u.length-1],d=f.querySelector(c);if(!d)return;const w=Array.from(f.querySelectorAll('textarea, [contenteditable="true"]')).filter(gt=>gt.closest("ms-chunk-input")===null).length===0,m=d.offsetParent!==null,b=!d.disabled&&!d.hasAttribute("inert");w&&m&&b&&(console.log("[Observer] Detected finalized response in the last chat turn. Notifying Dart that UI is ready for refinement."),I({type:W}),o())},dt)},e=function(i){if(i.type!=="childList"||i.addedNodes.length===0)return!1;for(let l=0;l<i.addedNodes.length;l++){const c=i.addedNodes[l];if(c&&c.nodeType===Node.ELEMENT_NODE){const u=c;if(u.tagName==="BUTTON"||u.querySelector("button"))return!0}}return!1},r=function(){g&&o();let i=document.querySelector("ms-chat-session");i||(console.warn("[Observer] Specific container (ms-chat-session) not found, falling back to body"),i=document.body),g=new MutationObserver(l=>{l.filter(e).length>0&&n()}),g.observe(i,{childList:!0,subtree:!0}),console.log(`[Observer] Started observing DOM for new responses (target: ${i.tagName}${i.id?"#"+i.id:""}).`)},o=function(){g&&(g.disconnect(),g=null,console.log("[Observer] Stopped observing DOM.")),E&&(clearTimeout(E),E=null)};window.__AI_HYBRID_HUB_INITIALIZED__=!0,window.__processedFootersCount=Et;const s={"https://aistudio.google.com":new lt};window.startAutomation=async function(i){console.log("[Engine LOG] >>> Full automation cycle started by Dart. Options:",JSON.stringify(i,null,2)),window.__hasAttemptedRetry=!1,window.__AI_TIMEOUT_MODIFIER__=i.timeoutModifier??1,console.log(`[Engine] Using timeout modifier: ${window.__AI_TIMEOUT_MODIFIER__}x`);const l=a();if(!l){I({type:L,errorCode:"UNSUPPORTED_SITE",payload:"This site is not supported."});return}const c=Date.now();let u="Initialization";try{l.resetState&&(u="Phase 1: Resetting UI state",console.log(`[Engine LOG] ${u}...`),await l.resetState()),u="Phase 2: Waiting for UI to be ready",console.log(`[Engine LOG] ${u}...`),await l.waitForReady(),u="Phase 3: Applying configurations",console.log(`[Engine LOG] ${u}...`),i.systemPrompt&&l.setSystemPrompt&&(console.log(`[Engine LOG] Setting system prompt (length: ${i.systemPrompt.length})`),await l.setSystemPrompt(i.systemPrompt)),l.applyAllSettings&&await l.applyAllSettings(i),u="Phase 4: Entering and sending prompt",console.log(`[Engine LOG] ${u}...`),await l.sendPrompt(i.prompt),u="Phase 5: Starting response observer",console.log(`[Engine LOG] ${u}...`),r();const f=Date.now()-c;console.log(`[Engine LOG] Full automation cycle initiated successfully in ${f}ms. Now observing for response.`)}catch(f){const d=f instanceof Error?f.message:String(f),S=Date.now()-c,w={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};console.error(`[Engine LOG] Full automation cycle failed in ${u} after ${S}ms!`,f);const m={phase:u,elapsedTimeMs:S,url:w.url,readyState:w.readyState,visibleElements:w.visibleElements,timestamp:new Date().toISOString()};throw(d.includes("Selector")||d.includes("selector"))&&(m.selectorContext="Error message contains selector information"),I({type:L,errorCode:"FULL_CYCLE_FAILED",location:"startAutomation",payload:d,diagnostics:m}),f}},window.extractFinalResponse=async function(){console.log("[Engine LOG] extractFinalResponse called");const i=a();if(!i){const c="This site is not supported for extraction.";throw console.error("[Engine LOG] No chatbot found for extraction"),I({type:L,errorCode:"UNSUPPORTED_SITE",payload:c}),new Error(c)}const l=Date.now();console.log(`[Engine LOG] Starting extraction with chatbot: ${i.constructor.name}`);try{console.log("[Engine LOG] [ENHANCED] DOM state before extraction:",{url:window.location.href,readyState:document.readyState,title:document.title,timestamp:new Date().toISOString()});const c=await i.extractResponse(),u=Date.now()-l;return console.log(`[Engine LOG] Extraction completed successfully in ${u}ms, extracted ${c.length} chars`),console.log("[Engine LOG] [ENHANCED] Extraction result details:",{success:!0,resultLength:c.length,resultPreview:c.substring(0,100)+(c.length>100?"...":""),elapsedTime:u}),c}catch(c){const u=c instanceof Error?c.message:String(c),f=Date.now()-l;console.error("[Engine LOG] [ENHANCED] Extraction failed with details:",{success:!1,errorMessage:u,errorType:c instanceof Error?c.constructor.name:typeof c,elapsedTime:f,timestamp:new Date().toISOString(),domState:{url:window.location.href,readyState:document.readyState,title:document.title,editButtons:document.querySelectorAll('button[aria-label="Edit"]').length,textareas:document.querySelectorAll('textarea, [contenteditable="true"]').length}});const d=`Extraction failed: ${u} (Type: ${c instanceof Error?c.constructor.name:typeof c}, Time: ${f}ms)`;throw console.error(`[Engine LOG] ${d}`),I({type:L,errorCode:"EXTRACTION_FAILED",payload:d}),c}},window.inspectDOMForSelectors=function(){const i={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},l=document.querySelectorAll("*");for(const m of l)if(m.shadowRoot){i.shadowDOMDetected=!0;break}const c=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],u={};for(const m of c)try{u[m]=document.querySelector(m),u[m]||(u[`${m} (shadow)`]=t(m))}catch{u[m]=null}i.allSelectorsTested.promptInput=u;const f=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],d={};for(const m of f)try{d[m]=document.querySelector(m),d[m]||(d[`${m} (shadow)`]=t(m))}catch{d[m]=null}i.allSelectorsTested.sendButton=d;const S=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));i.inputs=S.map(m=>{const b=m;return{tag:m.tagName.toLowerCase(),type:b.getAttribute("type")||"",placeholder:b.getAttribute("placeholder")||"",ariaLabel:b.getAttribute("aria-label")||"",id:m.id||"",className:m.className||"",contentEditable:b.contentEditable,visible:b.offsetParent!==null,inShadowDOM:!1}});const w=Array.from(document.querySelectorAll("button"));return i.buttons=w.map(m=>{const b=m;return{tag:m.tagName.toLowerCase(),ariaLabel:b.getAttribute("aria-label")||"",text:(b.innerText||"").substring(0,Tt),id:m.id||"",className:m.className||"",type:b.getAttribute("type")||"",visible:b.offsetParent!==null,inShadowDOM:!1}}),i};let g=null,E=null;console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),C()}})();
