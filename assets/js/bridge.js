(function(){"use strict";const b=["textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']","textarea[placeholder*='typing a prompt']","input[placeholder*='Start typing a prompt']","input[placeholder*='typing a prompt']","textarea[placeholder*='prompt']","input[placeholder*='prompt']","input-area","textarea[aria-label*='prompt']","textarea[name*='prompt']","textarea[id*='prompt']",".ql-editor","div[contenteditable='true']","textarea","input[type='text']"],f=['button[aria-label="Run"]','button[aria-label*="Run"]','button[aria-label*="Append to prompt and run"]','button[aria-label*="Append to Prompt and run"]','button[aria-label*="run"]','send-button[variant="primary"]','button[aria-label*="Send"]','button:contains("Run")',".send-button button",'button[type="submit"]',"button"],y=['ms-chat-turn[data-turn-role="Model"] ms-cmark-node','ms-chat-turn[data-turn-role="Model"] .response-content','ms-chat-turn[data-turn-role="Model"]',".response-content","response-container",".response-message",".message-response",".markdown","[data-testid*='response']",".message-content"],w=["ms-thought-chunk","ms-thought-chunk .thinking-progress-icon.in-progress",'mat-icon[data-mat-icon-name="stop"]',".generating-indicator",".loading-indicator","[data-testid*='generating']",".spinner",".loading-spinner",".thinking-indicator"];function h(e,t,n=!1){try{const o=e.split(":contains")[0],r=document.querySelectorAll(o||"*");for(const s of r){const a=s.textContent||"",i=n?a:a.toLowerCase(),c=n?t:t.toLowerCase();if(i.includes(c))return s}}catch{}return null}function d(e,t=1e4){return new Promise((n,o)=>{let s=0;const a=setInterval(()=>{for(const i of e){let c=null;if(i.includes(":contains(")){const l=i.match(/^(.+):contains\(['"](.+)['"]\)$/);l&&l[1]&&l[2]&&(c=h(l[1],l[2]))}else try{c=document.querySelector(i),!c&&s===0&&console.log(`[waitForElement] Selector "${i}" not found on first attempt`)}catch(l){console.warn(`[waitForElement] Invalid selector "${i}":`,l);continue}if(c){console.log(`[waitForElement] Found element with selector "${i}"`),clearInterval(a),n(c);return}}s+=300,s>=t&&(clearInterval(a),o(new Error(`None of the selectors [${e.join(", ")}] found within ${t}ms`)))},300)})}function u(e){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler("automationBridge",e)}function E(){const e=window.location.href.toLowerCase();if(e.includes("accounts.google.com")||e.includes("/signin"))return!0;const t=document.querySelector('input[placeholder*="Email or phone"], input[type="email"]'),n=document.body?.innerText?.includes("Sign in")||document.body?.innerText?.includes("Use your Google Account");return t&&n?(console.log("[isLoginPage] Login page detected via DOM elements"),!0):!1}function A(){return{documentReadyState:document.readyState,hasFlutterBridge:!!window.flutter_inappwebview,hasStartAutomation:typeof window.startAutomation<"u",hasExtractFinalResponse:typeof window.extractFinalResponse<"u",url:window.location.href,timestamp:new Date().toISOString()}}function T(){const e=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]')),t=Array.from(document.querySelectorAll("button"));console.log("[DEBUG] Found inputs:",e.map(n=>({tag:n.tagName,type:n.getAttribute("type"),placeholder:n.getAttribute("placeholder"),ariaLabel:n.getAttribute("aria-label"),id:n.id,className:n.className,contentEditable:n.contentEditable}))),console.log("[DEBUG] Found buttons:",t.slice(0,10).map(n=>({tag:n.tagName,ariaLabel:n.getAttribute("aria-label"),text:n.innerText?.substring(0,50),id:n.id,className:n.className,type:n.getAttribute("type")})))}window.startAutomation=async function(e){try{if(console.log("[startAutomation] Starting automation with prompt:",e.substring(0,50)),E()){console.log("[startAutomation] Login page detected. Pausing automation."),u({type:"LOGIN_REQUIRED",location:"startAutomation",payload:"User needs to sign in to Google Account"});return}T(),console.log("[startAutomation] Waiting for input area...");const t=await d(b);if(console.log("[startAutomation] Found input area:",t.tagName,t.className),t.tagName==="TEXTAREA"||t.tagName==="INPUT"){const o=t;o.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}else if(t instanceof HTMLElement&&t.contentEditable==="true"){const o=t;o.innerText=e,t.dispatchEvent(new Event("input",{bubbles:!0}))}else{const o=t;o.click(),await new Promise(s=>setTimeout(()=>s(),500));const r=o;r.value!==void 0&&(r.value=e)}await new Promise(o=>setTimeout(o,200)),console.log("[startAutomation] Waiting for send button...");const n=await d(f);console.log("[startAutomation] Found send button:",n.tagName,n.className,n.getAttribute("aria-label")),n.click(),console.log("[startAutomation] Clicked send button"),await new Promise(o=>setTimeout(o,300));try{const o=await d(w,5e3);console.log("[startAutomation] Generation indicator found. Observing for changes..."),await new Promise(r=>{const s=w[0];if(!s){console.warn("[Observer] No selector available, forcing completion."),u({type:"GENERATION_COMPLETE"}),r();return}const a=new MutationObserver((c,l)=>{const g=document.querySelector(s);g&&g.style.display!=="none"&&window.getComputedStyle(g).display!=="none"||(console.log("[Observer] Generation indicator has disappeared."),u({type:"GENERATION_COMPLETE"}),l.disconnect(),clearTimeout(i),r())});a.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]});const i=setTimeout(()=>{console.warn("[Observer] Fallback timeout reached. Forcing completion."),u({type:"GENERATION_COMPLETE"}),a.disconnect(),r()},45e3)})}catch{console.log("[startAutomation] Generation indicator not found, assuming generation is fast and complete."),u({type:"GENERATION_COMPLETE"})}}catch(t){const n=t instanceof Error?t.message:String(t),o={...A(),promptLength:e.length,promptPreview:e.length>50?e.substring(0,50)+"...":e};throw t instanceof Error&&t.message.includes("not found within")&&(o.errorType="ELEMENT_NOT_FOUND",o.timeoutReached=!0),u({type:"AUTOMATION_FAILED",payload:n,errorCode:"AUTOMATION_EXECUTION_FAILED",location:"startAutomation",diagnostics:o}),t}},window.extractFinalResponse=async function(){console.log("[extractFinalResponse] Starting extraction...");try{let e=[];for(const r of y){const s=Array.from(document.querySelectorAll(r));s.length>0&&(console.log(`[extractFinalResponse] Found ${s.length} element(s) with selector: ${r}`),e.push(...s))}if(e.length===0){console.warn("[extractFinalResponse] No elements found with any of the primary selectors. Using fallback.");const r=(document.body?.innerText||"").trim();if(!r)throw new Error("No response elements found and body is empty.");return console.log("[extractFinalResponse] Returning fallback body text."),r}const t=e.filter(r=>r.offsetParent!==null);if(t.length===0)throw new Error("Response elements were found but none are visible.");const n=t[t.length-1];if(!n)throw new Error("No visible response element found after filtering.");const o=(n.innerText||"").trim();return console.log("[extractFinalResponse] Returning value:",`"${o.substring(0,50)}..."`,"with type:",typeof o),o}catch(e){const t=e instanceof Error?e.message:String(e);throw console.error("[extractFinalResponse] CRITICAL ERROR during extraction:",t),u({type:"AUTOMATION_FAILED",payload:t,errorCode:"RESPONSE_EXTRACTION_FAILED",location:"extractFinalResponse"}),e}};function S(){const e=window;if(e.flutter_inappwebview)try{e.flutter_inappwebview.callHandler("bridgeReady")}catch(t){console.warn("Failed to signal bridge ready:",t)}}function m(e=100,t=300){if(e<=0){console.warn("Bridge ready signal: max retries reached, giving up");return}if(window.flutter_inappwebview)try{S(),console.log("Bridge ready signal sent successfully")}catch(o){console.warn("Error sending bridge ready signal:",o),setTimeout(()=>m(e-1,t),t)}else setTimeout(()=>m(e-1,t),t)}function p(e,t=document){try{const n=t.querySelector(e);if(n)return n;const o=t.querySelectorAll("*");for(const r of o)if(r.shadowRoot){const s=p(e,r.shadowRoot);if(s)return s}}catch{}return null}window.inspectDOMForSelectors=function(){const e={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},t=document.querySelectorAll("*");for(const a of t)if(a.shadowRoot){e.shadowDOMDetected=!0;break}const n={};for(const a of b)try{n[a]=document.querySelector(a),n[a]||(n[`${a} (shadow)`]=p(a))}catch{n[a]=null}e.allSelectorsTested.promptInput=n;const o={};for(const a of f)try{o[a]=document.querySelector(a),o[a]||(o[`${a} (shadow)`]=p(a))}catch{o[a]=null}e.allSelectorsTested.sendButton=o;const r=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));e.inputs=r.map(a=>{const i=a;return{tag:a.tagName.toLowerCase(),type:i.getAttribute("type")||"",placeholder:i.getAttribute("placeholder")||"",ariaLabel:i.getAttribute("aria-label")||"",id:a.id||"",className:a.className||"",contentEditable:i.contentEditable,visible:i.offsetParent!==null,inShadowDOM:!1}});const s=Array.from(document.querySelectorAll("button"));return e.buttons=s.map(a=>{const i=a;return{tag:a.tagName.toLowerCase(),ariaLabel:i.getAttribute("aria-label")||"",text:(i.innerText||"").substring(0,100),id:a.id||"",className:a.className||"",type:a.getAttribute("type")||"",visible:i.offsetParent!==null,inShadowDOM:!1}}),e},console.log("[Bridge] Script injected and functions attached to window."),console.log("[Bridge] startAutomation available:",typeof window.startAutomation),console.log("[Bridge] extractFinalResponse available:",typeof window.extractFinalResponse),console.log("[Bridge] window.flutter_inappwebview available:",typeof window.flutter_inappwebview),console.log("[Bridge] Document ready state:",document.readyState),console.log("[Bridge] Document body exists:",!!document.body),console.log("[Bridge] Prompt input element:",document.querySelector("#prompt-input")?"FOUND":"NOT FOUND"),console.log("[Bridge] Send button element:",document.querySelector("#send-button")?"FOUND":"NOT FOUND"),m()})();
