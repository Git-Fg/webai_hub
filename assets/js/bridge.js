(function(){"use strict";const F="automationBridge",H="bridgeReady",W="NEW_RESPONSE_DETECTED",q="LOGIN_REQUIRED",L="AUTOMATION_FAILED";function I(r){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler(F,r)}function A(r){const t=window.__AI_TIMEOUT_MODIFIER__??1;return r*t}const N=1e4,G=300,M=2,V=300,Y=2e3;function X(){return{url:window.location.href,readyState:document.readyState,visibleElementsCount:document.querySelectorAll("*").length}}function R(r,t,n,e="waitForElement"){const o=X();return`${e} failed: None of the selectors [${r.join(", ")}] found within ${t}ms
Context: URL=${o.url}, Timeout=${t}ms, Elapsed=${n}ms
Page State: Ready=${o.readyState}, VisibleElements=${o.visibleElementsCount}`}function v(r,t,n){for(let e=0;e<r.length;e++){const o=r[e];if(!o)continue;let i=null;try{t?i=t.querySelector(o):i=document.querySelector(o)}catch(a){console.warn(`[${n}] Invalid selector "${o}" (index ${e}):`,a);continue}if(i)return i}return null}async function B(r,t,n="waitForElement",e){return new Promise((o,i)=>{const a=Date.now();let T=0,d=null,s=null,u=null,l=!1;console.log(`[${n}] Starting search for selectors: [${r.join(", ")}] (timeout: ${t}ms)`);const c=()=>{d&&(d.disconnect(),d=null),s!==null&&(clearTimeout(s),s=null),u!==null&&(clearInterval(u),u=null)},g=()=>{const E=Date.now()-a;E-T>=Y&&(console.log(`[${n}] Still searching... (elapsed: ${E}ms, remaining: ${t-E}ms)`),T=E),l||(v(r,e,n)||console.log(`[${n}] Selectors not found on first attempt`),l=!0);const S=v(r,e,n);if(S){const w=Date.now()-a,m=r.find(b=>{if(!b)return!1;try{return e?e.querySelector(b)===S:document.querySelector(b)===S}catch{return!1}});console.log(`[${n}] Found element with selector "${m||"unknown"}" after ${w}ms`),c(),o(S);return}if(E>=t){c();const w=R(r,t,E,n);i(new Error(w))}};if(typeof MutationObserver<"u"){d=new MutationObserver(()=>{g()});const E=e||document.body;d.observe(E,{childList:!0,subtree:!0}),g()}else console.warn(`[${n}] MutationObserver not available, using polling fallback`),u=window.setInterval(g,G),g();s=window.setTimeout(()=>{c();const E=Date.now()-a,S=R(r,t,E,n);i(new Error(S))},t)})}function O(r,t=N,n=M){const e=A(t);return D(()=>B(r,e,"waitForElement"),n,"waitForElement")}function K(r,t,n=N,e=M){const o=A(n);return D(()=>B(t,o,"waitForElementWithin",r),e,"waitForElementWithin")}function P(r,t,n=N,e=M){const o=A(n);return D(()=>Z(r,t,o),e,"waitForElementByText")}async function Z(r,t,n){return new Promise((e,o)=>{const i=Date.now();let a=null,T=null;const d=()=>{a&&(a.disconnect(),a=null),T!==null&&(clearTimeout(T),T=null)},s=()=>{const u=document.querySelectorAll(r);for(const c of u)if(c.textContent?.includes(t)){const g=Date.now()-i;console.log(`[waitForElementByText] Found element with text "${t}" after ${g}ms`),d(),e(c);return}Date.now()-i>=n&&(d(),o(new Error(`Element with selector "${r}" containing text "${t}" not found within ${n}ms`)))};if(typeof MutationObserver<"u")a=new MutationObserver(()=>{s()}),a.observe(document.body,{childList:!0,subtree:!0}),s();else{console.warn("[waitForElementByText] MutationObserver not available, using polling fallback");const u=window.setInterval(s,G);s(),T=window.setTimeout(()=>{clearInterval(u),d(),o(new Error(`Element with selector "${r}" containing text "${t}" not found within ${n}ms`))},n)}})}async function D(r,t,n){let e=null;for(let o=0;o<=t;o++)try{return await r()}catch(i){if(e=i instanceof Error?i:new Error(String(i)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors"))||o>=t)throw e;const T=V*Math.pow(2,o);console.log(`[${n}] Retry ${o+1}/${t} after ${T}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(d=>setTimeout(d,T))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}const j=1e4,z=2,U=1e3,J=2e3;function Q(r){return r.isConnected===!0}function tt(r){if(typeof r.checkVisibility=="function")try{return r.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}catch{}return r.offsetParent!==null}async function et(r,t=U){try{const n=r.getAnimations();if(n.length===0)return!0;const e=n.map(i=>i.finished);return await Promise.race([Promise.all(e),new Promise(i=>setTimeout(i,t))]),r.getAnimations().length===0}catch{return!0}}function nt(r){if(r.disabled===!0||r.getAttribute("aria-disabled")==="true"||r.hasAttribute("inert"))return!1;let n=r.parentElement;for(;n;){if(n.hasAttribute("inert"))return!1;n=n.parentElement}return!0}function ot(r){try{const t=r.getBoundingClientRect(),n=t.left+t.width/2,e=t.top+t.height/2,o=document.elementFromPoint(n,e);return o?r.contains(o)||o===r:!1}catch{return!0}}async function k(r,t=U){const n=r,e={attached:!1,visible:!1,stable:!1,enabled:!1,unoccluded:!1,details:{}};if(e.attached=Q(r),e.details.isConnected=r.isConnected,!e.attached)return{actionable:!1,diagnostics:e};e.visible=tt(n);try{typeof n.checkVisibility=="function"&&(e.details.checkVisibilityResult=n.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0}))}catch{}if(e.details.offsetParent=n.offsetParent,!e.visible)return{actionable:!1,diagnostics:e};e.stable=await et(n,t);try{const i=n.getAnimations();e.details.animationsCount=i.length}catch{}if(!e.stable)return{actionable:!1,diagnostics:e};if(e.enabled=nt(n),e.details.disabled=n.disabled,e.details.ariaDisabled=n.getAttribute("aria-disabled"),e.details.inert=n.hasAttribute("inert"),!e.enabled)return{actionable:!1,diagnostics:e};if(e.unoccluded=ot(n),!e.unoccluded)try{const i=n.getBoundingClientRect(),a=i.left+i.width/2,T=i.top+i.height/2;e.details.occludingElement=document.elementFromPoint(a,T)}catch{}return{actionable:e.attached&&e.visible&&e.stable&&e.enabled&&e.unoccluded,diagnostics:e}}function it(r,t,n,e="element"){const o=[];n.attached||o.push("not attached to DOM"),n.visible||o.push("not visible"),n.stable||o.push("has ongoing animations"),n.enabled||o.push("disabled or inert"),n.unoccluded||o.push("occluded by another element");const i={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};return`${e} is not actionable: ${o.join(", ")}
Selectors: [${r.join(", ")}]
Timeout: ${t}ms
Diagnostics: ${JSON.stringify(n.details,null,2)}
Page State: URL=${i.url}, ReadyState=${i.readyState}, VisibleElements=${i.visibleElements}`}async function rt(r,t,n,e){const o=Date.now();let i=0;return console.log(`[waitForActionableElement] Starting search for actionable ${t} with selectors: [${r.join(", ")}] (timeout: ${n}ms)`),new Promise((a,T)=>{let d=null,s=null,u=null;const l=()=>{d&&(d.disconnect(),d=null),s!==null&&(clearTimeout(s),s=null),u!==null&&(clearInterval(u),u=null)},c=async()=>{const g=Date.now()-o;g-i>=J&&(console.log(`[waitForActionableElement] Still checking actionability for ${t}... (elapsed: ${g}ms)`),i=g);for(const E of r){if(!E)continue;let S=null;try{e||(S=document.querySelector(E))}catch(w){console.warn(`[waitForActionableElement] Invalid selector "${E}":`,w);continue}if(S){const{actionable:w,diagnostics:m}=await k(S);if(w){const b=Date.now()-o;console.log(`[waitForActionableElement] Found actionable ${t} with selector "${E}" after ${b}ms`),l(),a(S);return}else console.log(`[waitForActionableElement] Element found but not actionable: ${JSON.stringify(m.details)}`)}}if(g>=n){l();let E=null;for(const S of r)try{if(e||(E=document.querySelector(S)),E)break}catch{}if(E){const{diagnostics:S}=await k(E);T(new Error(it(r,n,S,t)))}else T(new Error(`waitForActionableElement failed: None of the selectors [${r.join(", ")}] found within ${n}ms`))}};if(typeof MutationObserver<"u"){d=new MutationObserver(()=>{c()});const g=document.body;d.observe(g,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","inert","style","class"]}),c()}else console.warn("[waitForActionableElement] MutationObserver not available, using polling fallback"),u=window.setInterval(c,100),c();s=window.setTimeout(()=>{l(),c()},n)})}function p(r,t="element",n=j,e=z){const o=A(n);return st(()=>rt(r,t,o),e,`waitForActionableElement(${t})`)}async function st(r,t,n){let e=null;const o=300;for(let i=0;i<=t;i++)try{return await r()}catch(a){if(e=a instanceof Error?a:new Error(String(a)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors")||e.message.includes("not actionable"))||i>=t)throw e;const d=o*Math.pow(2,i);console.log(`[${n}] Retry ${i+1}/${t} after ${d}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(s=>setTimeout(s,d))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}function h(r,t,n="DOM assertion"){if(!r)throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but the element is null.`);if(!(r instanceof t))throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but got ${r.constructor.name}.`);return r}const y=1e4,_={READINESS_CHECK_INTERVAL_MS:100,TOKEN_COUNT_UPDATE_TIMEOUT_MS:5e3,TOKEN_COUNT_CHECK_INTERVAL_MS:100,FINALIZED_TURN_TIMEOUT_MS:15e3,FINALIZED_TURN_CHECK_INTERVAL_MS:1e3,EDIT_BUTTON_WAIT_TIMEOUT_MS:2e3,TEXTAREA_APPEAR_TIMEOUT_MS:5e3,UI_STABILIZE_DELAY_MS:300,PANEL_ANIMATION_MS:400,POLL_INTERVAL_MS:100,POLL_TIMEOUT_MS:5e3},f={RUN_SETTINGS_TOGGLE_MOBILE:"button.runsettings-toggle-button",MODEL_SELECTOR_DESKTOP:"button.model-selector-card",PROMPT_INPUTS:["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']"],SEND_BUTTONS:['ms-run-button > button[aria-label="Run"]','ms-run-button > button[type="submit"]','button[aria-label="Run"]',"ms-run-button > button"],TOKEN_COUNT:"span.v3-token-count-value",EDIT_BUTTON:['button[aria-label="Edit"]','button[aria-label*="edit" i]','button:has([aria-label*="edit" i])'],EDIT_TEXTAREA:["textarea",'div[contenteditable="true"]','[contenteditable="true"]'],STOP_EDITING_BUTTON:'button[aria-label="Stop editing"]',CHAT_TURN:['[id^="turn-"]',"ms-chat-turn"],SETTINGS_PANEL_MOBILE_TOGGLE:['button[aria-label="Toggle run settings panel"]',"button.runsettings-toggle-button"],SETTINGS_PANEL_CLOSE_BUTTON:'ms-run-settings button[iconname="close"]',MODEL_SELECTOR_CARD:"button.model-selector-card",MODEL_CATEGORIES_ALL_BUTTON:"button[data-test-category-button]",MODEL_CAROUSEL_BUTTON:"ms-model-carousel-row button.content-button",MODEL_TITLE_TEXT:"span.model-title-text",SYSTEM_PROMPT_CARD:"button[data-test-system-instructions-card]",SYSTEM_PROMPT_TEXTAREA:"ms-system-instructions textarea",DIALOG_CLOSE_BUTTON:"mat-dialog-container button[data-test-close-button]",ADVANCED_SETTINGS_TOGGLE:"div.settings-item",THINKING_TOGGLE:'mat-slide-toggle[data-test-toggle="enable-thinking"] button',MANUAL_BUDGET_TOGGLE:'mat-slide-toggle[data-test-toggle="manual-budget"] button',BUDGET_INPUT:'div[data-test-id="user-setting-budget-animation-wrapper"] input',TOOLS_TOGGLE_SELECTOR:"div.settings-item",WEB_SEARCH_TOGGLE:'div[data-test-id="searchAsAToolTooltip"] button',URL_CONTEXT_TOGGLE:'div[data-test-id="browseAsAToolTooltip"] button'},$={SCREEN_WIDTH_BREAKPOINT_PX:960,LOG_PREVIEW_LENGTH:50};class lt{getPageStateContext(){const t=document.querySelectorAll("*").length;return`URL=${window.location.href}, ReadyState=${document.readyState}, VisibleElements=${t}`}createErrorWithContext(t,n,e){const o=this.getPageStateContext(),i=e?`${o}, ${e}`:o;return new Error(`${t} failed: ${n}
Context: ${i}`)}async retryOperation(t,n,e=2,o=300){let i=null;for(let a=0;a<=e;a++)try{return await t()}catch(T){if(i=T instanceof Error?T:new Error(String(T)),a>=e)throw this.createErrorWithContext(n,i.message,`Retries=${e}, Attempt=${a+1}`);const d=o*Math.pow(2,a);console.log(`[AI Studio LOG] ${n} failed, retrying ${a+1}/${e} after ${d}ms. Error: ${i.message.split(`
`)[0]}`),await new Promise(s=>setTimeout(s,d))}throw i||new Error(`${n} failed after ${e} retries`)}isLoginPage(){const t=window.location.href.toLowerCase();if(t.includes("accounts.google.com")||t.includes("/signin"))return!0;const n=document.querySelector('input[type="email"]'),e=document.body?.innerText?.includes("Sign in");return n&&e?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}async openSettingsPanel(){if(window.innerWidth<=$.SCREEN_WIDTH_BREAKPOINT_PX){if(document.querySelector(f.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel is already open.");return}try{const t=await p(Array.isArray(f.SETTINGS_PANEL_MOBILE_TOGGLE)?f.SETTINGS_PANEL_MOBILE_TOGGLE:[f.SETTINGS_PANEL_MOBILE_TOGGLE],"Settings panel toggle button",A(y),2);h(t,HTMLButtonElement,"Settings panel toggle button").click(),await new Promise(o=>setTimeout(o,_.PANEL_ANIMATION_MS)),document.querySelector(f.SETTINGS_PANEL_CLOSE_BUTTON)||(console.warn("[AI Studio LOG] Settings panel may not have opened properly. Retrying..."),await new Promise(o=>setTimeout(o,_.PANEL_ANIMATION_MS))),console.log("[AI Studio LOG] Settings panel opened successfully.")}catch(t){throw this.createErrorWithContext("openSettingsPanel",`Failed to open settings panel: ${t instanceof Error?t.message:String(t)}`)}}}async closeSettingsPanel(){if(window.innerWidth<=$.SCREEN_WIDTH_BREAKPOINT_PX)try{const t=await p([f.SETTINGS_PANEL_CLOSE_BUTTON],"Settings panel close button",A(y),0),n=h(t,HTMLButtonElement,"Settings panel close button");n&&(n.click(),await new Promise(o=>setTimeout(o,_.PANEL_ANIMATION_MS)),!document.querySelector(f.SETTINGS_PANEL_CLOSE_BUTTON)||(console.warn("[AI Studio LOG] Settings panel may not have closed properly. Waiting longer..."),await new Promise(o=>setTimeout(o,_.PANEL_ANIMATION_MS))),console.log("[AI Studio LOG] Settings panel closed successfully."))}catch(t){throw this.createErrorWithContext("closeSettingsPanel",`Failed to close settings panel: ${t instanceof Error?t.message:String(t)}`)}}async setSliderValueByLabel(t,n){try{const e=await P("h3",t);if(!e)throw this.createErrorWithContext("setSliderValueByLabel",`Could not find '${t}' label in settings panel.`);const o=e.closest(".settings-item-column");if(!o)throw this.createErrorWithContext("setSliderValueByLabel",`Could not find parent container for '${t}' label.`);const i=o.querySelector("input[type=number]");if(!i)throw this.createErrorWithContext("setSliderValueByLabel",`Found '${t}' label but could not find its input field.`);if(i.offsetParent===null||i.disabled)throw this.createErrorWithContext("setSliderValueByLabel",`Input field for '${t}' is not actionable (visible: ${i.offsetParent!==null}, disabled: ${i.disabled})`);i.value=n.toString(),i.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set ${t} to ${n} successfully.`)}catch(e){throw this.createErrorWithContext("setSliderValueByLabel",`Failed to set ${t}: ${e instanceof Error?e.message:String(e)}`,`LabelName=${t}, Value=${n}`)}}async _setModel(t){return console.log(`[AI Studio LOG] Setting model to: "${t}"`),this.retryOperation(async()=>{const n=await p([f.MODEL_SELECTOR_CARD],"Model selector card",A(y),2),e=h(n,HTMLButtonElement,"Model selector card"),o=e.querySelector("span.title");if(o&&o.textContent?.trim()===t){console.log(`[AI Studio LOG] Model "${t}" is already selected. Skipping.`);return}e.click(),await new Promise(l=>setTimeout(l,_.PANEL_ANIMATION_MS));const i=await p([f.MODEL_CATEGORIES_ALL_BUTTON],"Model categories all button",A(y),2);h(i,HTMLButtonElement,"Model categories all button").click(),await new Promise(l=>setTimeout(l,_.UI_STABILIZE_DELAY_MS));const T=Array.from(document.querySelectorAll(f.MODEL_CAROUSEL_BUTTON)),d=T.find(l=>{const c=l.textContent?.trim()||"";return(l.querySelector(f.MODEL_TITLE_TEXT)?.textContent?.trim()||"")===t||c.startsWith(t)});if(d){if(d.offsetParent===null)throw this.createErrorWithContext("_setModel",`Model button for "${t}" is not visible`);d.click(),console.log(`[AI Studio LOG] Success: Clicked model button for "${t}".`)}else{const l=T.map(c=>c.querySelector(f.MODEL_TITLE_TEXT)?.textContent?.trim()||c.textContent?.trim()||"unknown").join(", ");throw this.createErrorWithContext("_setModel",`Model button for "${t}" not found.`,`AvailableModels=[${l}]`)}const s=await p([f.DIALOG_CLOSE_BUTTON],"Dialog close button",A(y),2);h(s,HTMLButtonElement,"Dialog close button").click(),await new Promise(l=>setTimeout(l,_.PANEL_ANIMATION_MS))},"_setModel",2,300)}async _setTemperature(t){console.log(`[AI Studio LOG] Setting Temperature to: ${t}`),await this.setSliderValueByLabel("Temperature",t)}async _setTopP(t){console.log(`[AI Studio LOG] Setting Top-P to: ${t}`);const e=(await P("p","Advanced settings")).closest(f.ADVANCED_SETTINGS_TOGGLE);e&&!e.classList.contains("expanded")&&(e.click(),await new Promise(o=>setTimeout(o,_.PANEL_ANIMATION_MS))),await this.setSliderValueByLabel("Top P",t)}async _setThinkingBudget(t){console.log(`[AI Studio LOG] Configuring thinking budget. Provided value: ${t}`);const n=await O([f.THINKING_TOGGLE]),e=h(n,HTMLButtonElement,"Thinking toggle"),o=e.getAttribute("aria-checked")==="true";t!=null&&!o&&(e.click(),console.log('[AI Studio LOG] Enabled "thinking" feature.'),await new Promise(d=>setTimeout(d,_.PANEL_ANIMATION_MS)));const i=await O([f.MANUAL_BUDGET_TOGGLE]),a=h(i,HTMLButtonElement,"Manual budget toggle"),T=a.getAttribute("aria-checked")==="true";if(t!=null){T||(a.click(),console.log('[AI Studio LOG] Enabled "manual budget".'),await new Promise(u=>setTimeout(u,_.PANEL_ANIMATION_MS)));const d=await O([f.BUDGET_INPUT]),s=h(d,HTMLInputElement,"Budget input");s.value=t.toString(),s.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`[AI Studio LOG] Success: Set budget input to ${t}.`)}else T&&(a.click(),console.log('[AI Studio LOG] Success: Disabled "manual budget" as no value was provided.'))}async _setAdvancedOptions(t,n){if(console.log("[AI Studio LOG] Setting advanced options:",t),t.disableThinking!==void 0)if(n?.toLowerCase()==="gemini-2.5-pro")console.log('[AI Studio LOG] Skipping "disableThinking" toggle as it is not applicable for gemini-2.5-pro.');else{const o=await O([f.THINKING_TOGGLE]),i=h(o,HTMLButtonElement,"Thinking toggle"),a=i.getAttribute("aria-checked")==="true",T=!t.disableThinking;T!==a&&(i.click(),console.log(`[AI Studio LOG] Toggled thinking to: ${T?"enabled":"disabled"}`))}if(t.useWebSearch!==void 0||t.urlContext!==void 0){const o=(await P("p","Tools")).closest(f.TOOLS_TOGGLE_SELECTOR);if(o&&!o.classList.contains("expanded")&&(o.click(),await new Promise(i=>setTimeout(i,_.PANEL_ANIMATION_MS))),t.useWebSearch!==void 0){const i=await O([f.WEB_SEARCH_TOGGLE]),a=h(i,HTMLButtonElement,"Web search toggle");t.useWebSearch!==(a.getAttribute("aria-checked")==="true")&&(a.click(),console.log(`[AI Studio LOG] Toggled web search to: ${t.useWebSearch}`))}if(t.urlContext!==void 0){const i=await O([f.URL_CONTEXT_TOGGLE]),a=h(i,HTMLButtonElement,"URL context toggle");t.urlContext!==(a.getAttribute("aria-checked")==="true")&&(a.click(),console.log(`[AI Studio LOG] Toggled URL context to: ${t.urlContext}`))}}}async waitForReady(){await O([f.MODEL_SELECTOR_DESKTOP,f.RUN_SETTINGS_TOGGLE_MOBILE]),console.log("[AI Studio] UI is ready.")}async setSystemPrompt(t){if(t){console.log("[AI Studio LOG] Setting system prompt."),await this.openSettingsPanel();try{const n=await O([f.SYSTEM_PROMPT_CARD]);h(n,HTMLButtonElement,"System prompt card").click(),await new Promise(d=>setTimeout(d,_.PANEL_ANIMATION_MS));const o=await O([f.SYSTEM_PROMPT_TEXTAREA]),i=h(o,HTMLTextAreaElement,"System prompt textarea");i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[AI Studio LOG] Success: System prompt entered.");const a=await O([f.DIALOG_CLOSE_BUTTON]);h(a,HTMLButtonElement,"Dialog close button").click(),await new Promise(d=>setTimeout(d,_.PANEL_ANIMATION_MS))}finally{await this.closeSettingsPanel()}}}async applyAllSettings(t){if(!(t.model||t.temperature!==void 0||t.topP!==void 0||t.thinkingBudget!==void 0||t.useWebSearch!==void 0||t.disableThinking!==void 0||t.urlContext!==void 0)){console.log("[AI Studio LOG] No settings to apply. Skipping panel.");return}await this.openSettingsPanel();try{t.model&&await this._setModel(t.model),t.temperature!==void 0&&await this._setTemperature(t.temperature),t.topP!==void 0&&await this._setTopP(t.topP),t.thinkingBudget!==void 0&&await this._setThinkingBudget(t.thinkingBudget);const e={useWebSearch:t.useWebSearch,disableThinking:t.disableThinking,urlContext:t.urlContext};Object.values(e).some(o=>o!==void 0)&&await this._setAdvancedOptions(e,t.model)}finally{await this.closeSettingsPanel()}}async sendPrompt(t){if(console.log("[AI Studio LOG] Starting automation with prompt:",t.substring(0,$.LOG_PREVIEW_LENGTH)),this.isLoginPage())return console.log("[AI Studio LOG] Login page detected. Notifying Dart."),I({type:q,location:"sendPrompt",payload:"User needs to sign in to Google Account"}),new Promise(()=>{});try{const n=await p(f.PROMPT_INPUTS,"Prompt input area",A(y),2);if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.log("[AI Studio LOG] Prompt entered into input area, waiting for token count update...");else{const e=n?n.constructor.name:"null";throw this.createErrorWithContext("sendPrompt","Input area is not a valid textarea or input element.",`ElementType=${e}`)}return await new Promise(e=>{const o=_.TOKEN_COUNT_UPDATE_TIMEOUT_MS,i=Date.now(),a=()=>{if(Date.now()-i>o){console.warn("[AI Studio LOG] Token count timeout - proceeding anyway"),e();return}const s=document.querySelector(f.TOKEN_COUNT)?.textContent?.trim();s&&!s.startsWith("0")?(console.log(`[AI Studio LOG] Token count updated: ${s}`),e()):setTimeout(a,_.TOKEN_COUNT_CHECK_INTERVAL_MS)};a()}),this.retryOperation(async()=>{const e=await p(f.SEND_BUTTONS,"Send button",A(y),2);h(e,HTMLElement,"Send button").click(),console.log("[AI Studio LOG] Send button clicked successfully.")},"sendPrompt (click send button)",2,300)}catch(n){throw this.createErrorWithContext("sendPrompt",`Failed to send prompt: ${n instanceof Error?n.message:String(n)}`,`PromptLength=${t.length}`)}}findTurnContainerFromEditButton(t){const n=Array.isArray(f.CHAT_TURN)?f.CHAT_TURN.join(","):f.CHAT_TURN;return t.closest(n)}async extractResponse(){console.log(`[AI Studio LOG] Starting extraction process... (timeout: ${_.FINALIZED_TURN_TIMEOUT_MS}ms)`);const t=(a=_.FINALIZED_TURN_TIMEOUT_MS)=>new Promise((T,d)=>{const s=Array.isArray(f.EDIT_BUTTON)?f.EDIT_BUTTON.join(","):f.EDIT_BUTTON;let u=null,l=null;const c=()=>{u&&u.disconnect(),l&&clearTimeout(l)},g=()=>{const E=document.querySelectorAll(s);if(E.length===0)return;const S=E[E.length-1],w=this.findTurnContainerFromEditButton(S);w&&!w.querySelector('button[aria-label="Stop editing"]')&&S.offsetParent!==null&&!S.disabled&&(console.log("[AI Studio LOG] Found finalized turn via MutationObserver check."),c(),T({turn:w,editButton:S}))};u=new MutationObserver(g),u.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-label","disabled"]}),l=window.setTimeout(()=>{c();const S=`Extraction timed out. Final state: ${document.querySelectorAll(s).length} edit buttons found. The last response may still be generating or the UI has changed.`;console.error(`[AI Studio LOG] ${S}`),d(new Error(S))},a),g()}),{turn:n,editButton:e}=await t();console.log("[AI Studio LOG] Finalized turn found, clicking edit button..."),e.click(),console.log("[AI Studio LOG] Waiting for textarea to appear...");const o=await K(n,f.EDIT_TEXTAREA,_.TEXTAREA_APPEAR_TIMEOUT_MS);console.log("[AI Studio LOG] Textarea appeared, waiting for UI to stabilize..."),await new Promise(a=>setTimeout(a,_.UI_STABILIZE_DELAY_MS));const i=(o.value??o.innerText??"").trim();if(!i){const a="Textarea was found but it was empty.";throw console.error(`[AI Studio LOG] ${a}`),new Error(a)}console.log(`[AI Studio LOG] Extracted ${i.length} chars successfully.`);try{const a=n.querySelector(f.STOP_EDITING_BUTTON);a&&(a.click(),console.log("[AI Studio LOG] Exited edit mode successfully."))}catch(a){console.warn("[AI Studio LOG] Could not exit edit mode, but extraction was successful. This is non-critical.",a)}return i}}const at=100,ct=300,ut=250,dt=0,Et=100;function x(){if(window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function")try{window.flutter_inappwebview.callHandler(H),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(r){console.warn("[Engine] Failed to send bridge ready signal:",r)}}document.addEventListener("flutterInAppWebViewPlatformReady",()=>{console.log("[Engine] Received flutterInAppWebViewPlatformReady event"),x()});function C(r=at,t=ct){if(r<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function"?x():setTimeout(()=>C(r-1,t),t)}if(window.__AI_HYBRID_HUB_INITIALIZED__&&(console.log("[Engine] Bridge script already initialized. Checking if functions exist..."),typeof window.startAutomation<"u"&&typeof window.extractFinalResponse<"u"&&typeof window.inspectDOMForSelectors<"u"?(console.log("[Engine] Functions exist, signaling ready."),C()):(console.warn("[Engine] Flag set but functions missing! Force re-initialization."),delete window.__AI_HYBRID_HUB_INITIALIZED__)),!window.__AI_HYBRID_HUB_INITIALIZED__){let r=function(){const s=window.location.href;for(const[u,l]of Object.entries(a))if(s.startsWith(u))return console.log(`[Engine] Matched site: ${u}. Using corresponding chatbot module.`),l;return console.error(`[Engine] No chatbot module found for current URL: ${s}`),null},t=function(s,u=document){try{const l=u.querySelector(s);if(l)return l;const c=u.querySelectorAll("*");for(const g of c)if(g.shadowRoot){const E=t(s,g.shadowRoot);if(E)return E}}catch{}return null},n=function(){d&&clearTimeout(d),d=window.setTimeout(()=>{const s='[id^="turn-"], ms-chat-turn',u='button[aria-label="Edit"]',l=document.querySelectorAll(s);if(l.length===0)return;const c=l[l.length-1],g=c.querySelector(u);if(!g)return;const S=Array.from(c.querySelectorAll('textarea, [contenteditable="true"]')).filter(b=>b.closest("ms-chunk-input")===null).length===0,w=g.offsetParent!==null,m=!g.disabled&&!g.hasAttribute("inert");S&&w&&m&&(console.log("[Observer] Detected finalized response in the last chat turn. Notifying Dart that UI is ready for refinement."),I({type:W}),i())},ut)},e=function(s){if(s.type!=="childList"||s.addedNodes.length===0)return!1;for(let u=0;u<s.addedNodes.length;u++){const l=s.addedNodes[u];if(l&&l.nodeType===Node.ELEMENT_NODE){const c=l;if(c.tagName==="BUTTON"||c.querySelector("button"))return!0}}return!1},o=function(){T&&i();let s=document.querySelector("ms-chat-session");s||(console.warn("[Observer] Specific container (ms-chat-session) not found, falling back to body"),s=document.body),T=new MutationObserver(u=>{u.filter(e).length>0&&n()}),T.observe(s,{childList:!0,subtree:!0}),console.log(`[Observer] Started observing DOM for new responses (target: ${s.tagName}${s.id?"#"+s.id:""}).`)},i=function(){T&&(T.disconnect(),T=null,console.log("[Observer] Stopped observing DOM.")),d&&(clearTimeout(d),d=null)};window.__AI_HYBRID_HUB_INITIALIZED__=!0,window.__processedFootersCount=dt;const a={"https://aistudio.google.com":new lt};window.startAutomation=async function(s){console.log("[Engine LOG] >>> startAutomation called by Dart. Processing options:",JSON.stringify(s,null,2)),window.__AI_TIMEOUT_MODIFIER__=s.timeoutModifier??1,console.log(`[Engine] Using timeout modifier: ${window.__AI_TIMEOUT_MODIFIER__}x`);const u=r();if(!u){I({type:L,errorCode:"UNSUPPORTED_SITE",payload:"This site is not supported."});return}const l=Date.now();let c="Initialization";try{c="Phase 1: Waiting for UI to be ready",console.log(`[Engine LOG] ${c}...`),await u.waitForReady(),c="Phase 2: Applying configurations",console.log(`[Engine LOG] ${c}...`),s.systemPrompt&&u.setSystemPrompt&&(console.log(`[Engine LOG] Setting system prompt (length: ${s.systemPrompt.length})`),await u.setSystemPrompt(s.systemPrompt)),u.applyAllSettings&&await u.applyAllSettings(s),c="Phase 3: Sending prompt",console.log(`[Engine LOG] ${c}...`),await u.sendPrompt(s.prompt);const g=Date.now()-l;console.log(`[Engine LOG] All steps completed successfully in ${g}ms.`)}catch(g){const E=g instanceof Error?g.message:String(g),S=Date.now()-l,w={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};console.error(`[Engine LOG] Automation failed in ${c} after ${S}ms!`,g);const m={phase:c,elapsedTimeMs:S,url:w.url,readyState:w.readyState,visibleElements:w.visibleElements,timestamp:new Date().toISOString()};throw(E.includes("Selector")||E.includes("selector"))&&(m.selectorContext="Error message contains selector information"),I({type:L,errorCode:"AUTOMATION_EXECUTION_FAILED",location:"startAutomation",payload:E,diagnostics:m}),g}},window.extractFinalResponse=async function(){console.log("[Engine LOG] extractFinalResponse called");const s=r();if(!s){const l="This site is not supported for extraction.";throw console.error("[Engine LOG] No chatbot found for extraction"),I({type:L,errorCode:"UNSUPPORTED_SITE",payload:l}),new Error(l)}const u=Date.now();console.log(`[Engine LOG] Starting extraction with chatbot: ${s.constructor.name}`);try{console.log("[Engine LOG] [ENHANCED] DOM state before extraction:",{url:window.location.href,readyState:document.readyState,title:document.title,timestamp:new Date().toISOString()});const l=await s.extractResponse(),c=Date.now()-u;return console.log(`[Engine LOG] Extraction completed successfully in ${c}ms, extracted ${l.length} chars`),console.log("[Engine LOG] [ENHANCED] Extraction result details:",{success:!0,resultLength:l.length,resultPreview:l.substring(0,100)+(l.length>100?"...":""),elapsedTime:c}),l}catch(l){const c=l instanceof Error?l.message:String(l),g=Date.now()-u;console.error("[Engine LOG] [ENHANCED] Extraction failed with details:",{success:!1,errorMessage:c,errorType:l instanceof Error?l.constructor.name:typeof l,elapsedTime:g,timestamp:new Date().toISOString(),domState:{url:window.location.href,readyState:document.readyState,title:document.title,editButtons:document.querySelectorAll('button[aria-label="Edit"]').length,textareas:document.querySelectorAll('textarea, [contenteditable="true"]').length}});const E=`Extraction failed: ${c} (Type: ${l instanceof Error?l.constructor.name:typeof l}, Time: ${g}ms)`;throw console.error(`[Engine LOG] ${E}`),I({type:L,errorCode:"EXTRACTION_FAILED",payload:E}),l}},window.inspectDOMForSelectors=function(){const s={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},u=document.querySelectorAll("*");for(const m of u)if(m.shadowRoot){s.shadowDOMDetected=!0;break}const l=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],c={};for(const m of l)try{c[m]=document.querySelector(m),c[m]||(c[`${m} (shadow)`]=t(m))}catch{c[m]=null}s.allSelectorsTested.promptInput=c;const g=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],E={};for(const m of g)try{E[m]=document.querySelector(m),E[m]||(E[`${m} (shadow)`]=t(m))}catch{E[m]=null}s.allSelectorsTested.sendButton=E;const S=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));s.inputs=S.map(m=>{const b=m;return{tag:m.tagName.toLowerCase(),type:b.getAttribute("type")||"",placeholder:b.getAttribute("placeholder")||"",ariaLabel:b.getAttribute("aria-label")||"",id:m.id||"",className:m.className||"",contentEditable:b.contentEditable,visible:b.offsetParent!==null,inShadowDOM:!1}});const w=Array.from(document.querySelectorAll("button"));return s.buttons=w.map(m=>{const b=m;return{tag:m.tagName.toLowerCase(),ariaLabel:b.getAttribute("aria-label")||"",text:(b.innerText||"").substring(0,Et),id:m.id||"",className:m.className||"",type:b.getAttribute("type")||"",visible:b.offsetParent!==null,inShadowDOM:!1}}),s};let T=null,d=null;window.startResponseObserver=o,console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),C()}})();
