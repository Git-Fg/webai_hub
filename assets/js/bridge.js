(function(){"use strict";const q="automationBridge",V="bridgeReady",K="NEW_RESPONSE_DETECTED",Y="LOGIN_REQUIRED",N="AUTOMATION_FAILED",X="AUTOMATION_RETRY_REQUIRED";function L(s){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler(q,s)}function _(s){const t=window.__AI_TIMEOUT_MODIFIER__??1;return s*t}const P=1e4,$=300,R=2,Z=300,z=2e3;function j(){return{url:window.location.href,readyState:document.readyState,visibleElementsCount:document.querySelectorAll("*").length}}function B(s,t,n,e="waitForElement"){const o=j();return`${e} failed: None of the selectors [${s.join(", ")}] found within ${t}ms
Context: URL=${o.url}, Timeout=${t}ms, Elapsed=${n}ms
Page State: Ready=${o.readyState}, VisibleElements=${o.visibleElementsCount}`}function U(s,t,n){for(let e=0;e<s.length;e++){const o=s[e];if(!o)continue;let i=null;try{t?i=t.querySelector(o):i=document.querySelector(o)}catch(a){console.warn(`[${n}] Invalid selector "${o}" (index ${e}):`,a);continue}if(i)return i}return null}async function k(s,t,n="waitForElement",e){return new Promise((o,i)=>{const a=Date.now();let f=0,d=null,l=null,r=null,u=!1;console.log(`[${n}] Starting search for selectors: [${s.join(", ")}] (timeout: ${t}ms)`);const c=()=>{d&&(d.disconnect(),d=null),l!==null&&(clearTimeout(l),l=null),r!==null&&(clearInterval(r),r=null)},E=()=>{const T=Date.now()-a;T-f>=z&&(console.log(`[${n}] Still searching... (elapsed: ${T}ms, remaining: ${t-T}ms)`),f=T),u||(U(s,e,n)||console.log(`[${n}] Selectors not found on first attempt`),u=!0);const g=U(s,e,n);if(g){const b=Date.now()-a,O=s.find(S=>{if(!S)return!1;try{return e?e.querySelector(S)===g:document.querySelector(S)===g}catch{return!1}});console.log(`[${n}] Found element with selector "${O||"unknown"}" after ${b}ms`),c(),o(g);return}if(T>=t){c();const b=B(s,t,T,n);i(new Error(b))}};if(typeof MutationObserver<"u"){d=new MutationObserver(()=>{E()});const T=e||document.body;d.observe(T,{childList:!0,subtree:!0}),E()}else console.warn(`[${n}] MutationObserver not available, using polling fallback`),r=window.setInterval(E,$),E();l=window.setTimeout(()=>{c();const T=Date.now()-a,g=B(s,t,T,n);i(new Error(g))},t)})}function p(s,t=P,n=R){const e=_(t);return D(()=>k(s,e,"waitForElement"),n,"waitForElement")}function x(s,t,n=P,e=R){const o=_(n);return D(()=>k(t,o,"waitForElementWithin",s),e,"waitForElementWithin")}function C(s,t,n=P,e=R){const o=_(n);return D(()=>Q(s,t,o),e,"waitForElementByText")}async function Q(s,t,n){return new Promise((e,o)=>{const i=Date.now();let a=null,f=null;const d=()=>{a&&(a.disconnect(),a=null),f!==null&&(clearTimeout(f),f=null)},l=()=>{const r=document.querySelectorAll(s);for(const c of r)if(c.textContent?.includes(t)){const E=Date.now()-i;console.log(`[waitForElementByText] Found element with text "${t}" after ${E}ms`),d(),e(c);return}Date.now()-i>=n&&(d(),o(new Error(`Element with selector "${s}" containing text "${t}" not found within ${n}ms`)))};if(typeof MutationObserver<"u")a=new MutationObserver(()=>{l()}),a.observe(document.body,{childList:!0,subtree:!0}),l();else{console.warn("[waitForElementByText] MutationObserver not available, using polling fallback");const r=window.setInterval(l,$);l(),f=window.setTimeout(()=>{clearInterval(r),d(),o(new Error(`Element with selector "${s}" containing text "${t}" not found within ${n}ms`))},n)}})}async function D(s,t,n){let e=null;for(let o=0;o<=t;o++)try{return await s()}catch(i){if(e=i instanceof Error?i:new Error(String(i)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors"))||o>=t)throw e;const f=Z*Math.pow(2,o);console.log(`[${n}] Retry ${o+1}/${t} after ${f}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(d=>setTimeout(d,f))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}const J=1e4,tt=2,F=1e3,et=2e3;function nt(s){return s.isConnected===!0}function ot(s){if(typeof s.checkVisibility=="function")try{return s.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}catch{}return s.offsetParent!==null}async function it(s,t=F){try{const n=s.getAnimations();if(n.length===0)return!0;const e=n.map(i=>i.finished);return await Promise.race([Promise.all(e),new Promise(i=>setTimeout(i,t))]),s.getAnimations().length===0}catch{return!0}}function rt(s){if(s.disabled===!0||s.getAttribute("aria-disabled")==="true"||s.hasAttribute("inert"))return!1;let n=s.parentElement;for(;n;){if(n.hasAttribute("inert"))return!1;n=n.parentElement}return!0}function st(s){try{const t=s.getBoundingClientRect(),n=t.left+t.width/2,e=t.top+t.height/2,o=document.elementFromPoint(n,e);return o?s.contains(o)||o===s:!1}catch{return!0}}async function H(s,t=F){const n=s,e={attached:!1,visible:!1,stable:!1,enabled:!1,unoccluded:!1,details:{}};if(e.attached=nt(s),e.details.isConnected=s.isConnected,!e.attached)return{actionable:!1,diagnostics:e};e.visible=ot(n);try{typeof n.checkVisibility=="function"&&(e.details.checkVisibilityResult=n.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0}))}catch{}if(e.details.offsetParent=n.offsetParent,!e.visible)return{actionable:!1,diagnostics:e};e.stable=await it(n,t);try{const i=n.getAnimations();e.details.animationsCount=i.length}catch{}if(!e.stable)return{actionable:!1,diagnostics:e};if(e.enabled=rt(n),e.details.disabled=n.disabled,e.details.ariaDisabled=n.getAttribute("aria-disabled"),e.details.inert=n.hasAttribute("inert"),!e.enabled)return{actionable:!1,diagnostics:e};if(e.unoccluded=st(n),!e.unoccluded)try{const i=n.getBoundingClientRect(),a=i.left+i.width/2,f=i.top+i.height/2;e.details.occludingElement=document.elementFromPoint(a,f)}catch{}return{actionable:e.attached&&e.visible&&e.stable&&e.enabled&&e.unoccluded,diagnostics:e}}function at(s,t,n,e="element"){const o=[];n.attached||o.push("not attached to DOM"),n.visible||o.push("not visible"),n.stable||o.push("has ongoing animations"),n.enabled||o.push("disabled or inert"),n.unoccluded||o.push("occluded by another element");const i={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};return`${e} is not actionable: ${o.join(", ")}
Selectors: [${s.join(", ")}]
Timeout: ${t}ms
Diagnostics: ${JSON.stringify(n.details,null,2)}
Page State: URL=${i.url}, ReadyState=${i.readyState}, VisibleElements=${i.visibleElements}`}async function lt(s,t,n,e){const o=Date.now();let i=0;return console.log(`[waitForActionableElement] Starting search for actionable ${t} with selectors: [${s.join(", ")}] (timeout: ${n}ms)`),new Promise((a,f)=>{let d=null,l=null,r=null;const u=()=>{d&&(d.disconnect(),d=null),l!==null&&(clearTimeout(l),l=null),r!==null&&(clearInterval(r),r=null)},c=async()=>{const E=Date.now()-o;E-i>=et&&(console.log(`[waitForActionableElement] Still checking actionability for ${t}... (elapsed: ${E}ms)`),i=E);for(const T of s){if(!T)continue;let g=null;try{e||(g=document.querySelector(T))}catch(b){console.warn(`[waitForActionableElement] Invalid selector "${T}":`,b);continue}if(g){const{actionable:b,diagnostics:O}=await H(g);if(b){const S=Date.now()-o;console.log(`[waitForActionableElement] Found actionable ${t} with selector "${T}" after ${S}ms`),u(),a(g);return}else console.log(`[waitForActionableElement] Element found but not actionable: ${JSON.stringify(O.details)}`)}}if(E>=n){u();let T=null;for(const g of s)try{if(e||(T=document.querySelector(g)),T)break}catch{}if(T){const{diagnostics:g}=await H(T);f(new Error(at(s,n,g,t)))}else f(new Error(`waitForActionableElement failed: None of the selectors [${s.join(", ")}] found within ${n}ms`))}};if(typeof MutationObserver<"u"){d=new MutationObserver(()=>{c()});const E=document.body;d.observe(E,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","inert","style","class"]}),c()}else console.warn("[waitForActionableElement] MutationObserver not available, using polling fallback"),r=window.setInterval(c,100),c();l=window.setTimeout(()=>{u(),c()},n)})}function I(s,t="element",n=J,e=tt){const o=_(n);return ct(()=>lt(s,t,o),e,`waitForActionableElement(${t})`)}async function ct(s,t,n){let e=null;const o=300;for(let i=0;i<=t;i++)try{return await s()}catch(a){if(e=a instanceof Error?a:new Error(String(a)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors")||e.message.includes("not actionable"))||i>=t)throw e;const d=o*Math.pow(2,i);console.log(`[${n}] Retry ${i+1}/${t} after ${d}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(l=>setTimeout(l,d))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}function h(s,t,n="DOM assertion"){if(!s)throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but the element is null.`);if(!(s instanceof t))throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but got ${s.constructor.name}.`);return s}const M=1e4,w={READINESS_CHECK_INTERVAL_MS:100,TOKEN_COUNT_UPDATE_TIMEOUT_MS:1e4,TOKEN_COUNT_CHECK_INTERVAL_MS:100,UI_STABILIZE_AFTER_TOKEN_COUNT_MS:30,FINALIZED_TURN_TIMEOUT_MS:15e3,FINALIZED_TURN_CHECK_INTERVAL_MS:1e3,EDIT_BUTTON_WAIT_TIMEOUT_MS:2e3,TEXTAREA_APPEAR_TIMEOUT_MS:5e3,UI_STABILIZE_DELAY_MS:150,PANEL_ANIMATION_MS:250,POLL_INTERVAL_MS:100,POLL_TIMEOUT_MS:5e3},m={NEW_CHAT_BUTTON:'a[href="/prompts/new_chat"]',RUN_SETTINGS_TOGGLE_MOBILE:"button.runsettings-toggle-button",MODEL_SELECTOR_DESKTOP:"button.model-selector-card",PROMPT_INPUTS:["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']"],SEND_BUTTONS:['ms-run-button > button[aria-label="Run"]','ms-run-button > button[type="submit"]','button[aria-label="Run"]',"ms-run-button > button"],TOKEN_COUNT:"span.v3-token-count-value",EDIT_BUTTON:['button[aria-label="Edit"]','button[aria-label*="edit" i]','button:has([aria-label*="edit" i])'],EDIT_TEXTAREA:["textarea",'div[contenteditable="true"]','[contenteditable="true"]'],STOP_EDITING_BUTTON:'button[aria-label="Stop editing"]',CHAT_TURN:['[id^="turn-"]',"ms-chat-turn"],SETTINGS_PANEL_MOBILE_TOGGLE:['button[aria-label="Toggle run settings panel"]',"button.runsettings-toggle-button"],SETTINGS_PANEL_CLOSE_BUTTON:'ms-run-settings button[iconname="close"]',MODEL_SELECTOR_CARD:"button.model-selector-card",MODEL_CATEGORIES_ALL_BUTTON:"button[data-test-category-button]",MODEL_CAROUSEL_BUTTON:"ms-model-carousel-row button.content-button",MODEL_TITLE_TEXT:"span.model-title-text",SYSTEM_PROMPT_CARD:"button[data-test-system-instructions-card]",SYSTEM_PROMPT_TEXTAREA:"ms-system-instructions textarea",DIALOG_CLOSE_BUTTON:"mat-dialog-container button[data-test-close-button]",MODEL_DIALOG_CONTAINER:"mat-dialog-container",ADVANCED_SETTINGS_TOGGLE:"div.settings-item",THINKING_TOGGLE:'mat-slide-toggle[data-test-toggle="enable-thinking"] button',MANUAL_BUDGET_TOGGLE:'mat-slide-toggle[data-test-toggle="manual-budget"] button',BUDGET_INPUT:'div[data-test-id="user-setting-budget-animation-wrapper"] input',TOOLS_TOGGLE_SELECTOR:"div.settings-item",WEB_SEARCH_TOGGLE:'div[data-test-id="searchAsAToolTooltip"] button',URL_CONTEXT_TOGGLE:'div[data-test-id="browseAsAToolTooltip"] button'},v={SCREEN_WIDTH_BREAKPOINT_PX:960,LOG_PREVIEW_LENGTH:50};class ut{getPageStateContext(){const t=document.querySelectorAll("*").length;return`URL=${window.location.href}, ReadyState=${document.readyState}, VisibleElements=${t}`}createErrorWithContext(t,n,e){const o=this.getPageStateContext(),i=e?`${o}, ${e}`:o;return new Error(`${t} failed: ${n}
Context: ${i}`)}async retryOperation(t,n,e=2,o=300){let i=null;for(let a=0;a<=e;a++)try{return await t()}catch(f){if(i=f instanceof Error?f:new Error(String(f)),a>=e)throw this.createErrorWithContext(n,i.message,`Retries=${e}, Attempt=${a+1}`);const d=o*Math.pow(2,a);console.log(`[AI Studio LOG] ${n} failed, retrying ${a+1}/${e} after ${d}ms. Error: ${i.message.split(`
`)[0]}`),await new Promise(l=>setTimeout(l,d))}throw i||new Error(`${n} failed after ${e} retries`)}isLoginPage(){const t=window.location.href.toLowerCase();if(t.includes("accounts.google.com")||t.includes("/signin"))return!0;const n=document.querySelector('input[type="email"]'),e=document.body?.innerText?.includes("Sign in");return n&&e?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}async openSettingsPanel(){if(window.innerWidth<=v.SCREEN_WIDTH_BREAKPOINT_PX){if(document.querySelector(m.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel is already open.");return}try{const t=await I(Array.isArray(m.SETTINGS_PANEL_MOBILE_TOGGLE)?m.SETTINGS_PANEL_MOBILE_TOGGLE:[m.SETTINGS_PANEL_MOBILE_TOGGLE],"Settings panel toggle button",_(M),2);h(t,HTMLButtonElement,"Settings panel toggle button").click(),await new Promise(o=>setTimeout(o,w.PANEL_ANIMATION_MS)),document.querySelector(m.SETTINGS_PANEL_CLOSE_BUTTON)||(console.warn("[AI Studio LOG] Settings panel may not have opened properly. Retrying..."),await new Promise(o=>setTimeout(o,w.PANEL_ANIMATION_MS))),console.log("[AI Studio LOG] Settings panel opened successfully.")}catch(t){throw this.createErrorWithContext("openSettingsPanel",`Failed to open settings panel: ${t instanceof Error?t.message:String(t)}`)}}}async closeSettingsPanel(){if(window.innerWidth<=v.SCREEN_WIDTH_BREAKPOINT_PX){if(!document.querySelector(m.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel appears to be already closed.");return}try{const t=await I([m.SETTINGS_PANEL_CLOSE_BUTTON],"Settings panel close button",_(2e3),0);h(t,HTMLButtonElement,"Settings panel close button").click(),await new Promise(e=>setTimeout(e,w.PANEL_ANIMATION_MS)),console.log("[AI Studio LOG] Settings panel closed successfully.")}catch(t){console.warn("[AI Studio LOG] Could not close settings panel, but continuing:",t)}}}async setSliderValueByLabel(t,n){try{const e=await C("h3",t);if(!e)throw this.createErrorWithContext("setSliderValueByLabel",`Could not find '${t}' label in settings panel.`);const o=e.closest(".settings-item-column");if(!o)throw this.createErrorWithContext("setSliderValueByLabel",`Could not find parent container for '${t}' label.`);const i=o.querySelector("input[type=number]");if(!i)throw this.createErrorWithContext("setSliderValueByLabel",`Found '${t}' label but could not find its input field.`);if(i.offsetParent===null||i.disabled)throw this.createErrorWithContext("setSliderValueByLabel",`Input field for '${t}' is not actionable (visible: ${i.offsetParent!==null}, disabled: ${i.disabled})`);i.value=n.toString(),i.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set ${t} to ${n} successfully.`)}catch(e){throw this.createErrorWithContext("setSliderValueByLabel",`Failed to set ${t}: ${e instanceof Error?e.message:String(e)}`,`LabelName=${t}, Value=${n}`)}}async _setModel(t){return console.log(`[AI Studio LOG] Setting model to: "${t}"`),this.retryOperation(async()=>{const n=await I([m.MODEL_SELECTOR_CARD],"Model selector card",_(M),2),e=h(n,HTMLButtonElement,"Model selector card"),o=e.querySelector("span.title");if(o&&o.textContent?.trim()===t){console.log(`[AI Studio LOG] Model "${t}" is already selected. Skipping.`);return}e.click(),await p([m.MODEL_DIALOG_CONTAINER],_(3e3));let i=null;try{i=await I([m.MODEL_CATEGORIES_ALL_BUTTON],"Model categories all button",_(M),2)}catch(l){if((l instanceof Error?l.message:String(l)).includes("occluded")){console.log("[AI Studio LOG] Element found but occluded. Waiting longer and attempting click anyway..."),await new Promise(c=>setTimeout(c,w.PANEL_ANIMATION_MS));const u=document.querySelector(m.MODEL_CATEGORIES_ALL_BUTTON);if(u&&u.offsetParent!==null)i=u,console.log("[AI Studio LOG] Found element despite occlusion, will attempt click.");else throw l}else throw l}const a=h(i,HTMLButtonElement,"Model categories all button");a.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise(l=>setTimeout(l,w.UI_STABILIZE_DELAY_MS)),a.click(),await new Promise(l=>setTimeout(l,w.UI_STABILIZE_DELAY_MS));const f=Array.from(document.querySelectorAll(m.MODEL_CAROUSEL_BUTTON)),d=f.find(l=>{const r=l.textContent?.trim()||"";return(l.querySelector(m.MODEL_TITLE_TEXT)?.textContent?.trim()||"")===t||r.startsWith(t)});if(d){if(d.offsetParent===null)throw this.createErrorWithContext("_setModel",`Model button for "${t}" is not visible`);d.click(),console.log(`[AI Studio LOG] Success: Clicked model button for "${t}".`),await new Promise(l=>setTimeout(l,w.PANEL_ANIMATION_MS))}else{const l=f.map(r=>r.querySelector(m.MODEL_TITLE_TEXT)?.textContent?.trim()||r.textContent?.trim()||"unknown").join(", ");throw this.createErrorWithContext("_setModel",`Model button for "${t}" not found.`,`AvailableModels=[${l}]`)}if(document.querySelector("mat-dialog-container"))try{const l=await I([m.DIALOG_CLOSE_BUTTON],"Dialog close button",_(2e3),0);h(l,HTMLButtonElement,"Dialog close button").click(),await new Promise(u=>setTimeout(u,w.PANEL_ANIMATION_MS))}catch{console.log("[AI Studio LOG] Model dialog seems to have closed automatically.")}},"_setModel",2,300)}async _setTemperature(t){console.log(`[AI Studio LOG] Setting Temperature to: ${t}`),await this.setSliderValueByLabel("Temperature",t)}async _setTopP(t){console.log(`[AI Studio LOG] Setting Top-P to: ${t}`);const e=(await C("p","Advanced settings")).closest(m.ADVANCED_SETTINGS_TOGGLE);e&&!e.classList.contains("expanded")&&(e.click(),await new Promise(o=>setTimeout(o,w.PANEL_ANIMATION_MS))),await this.setSliderValueByLabel("Top P",t)}async _setThinkingBudget(t){console.log(`[AI Studio LOG] Configuring thinking budget. Provided value: ${t}`);const n=await p([m.THINKING_TOGGLE]),e=h(n,HTMLButtonElement,"Thinking toggle"),o=e.getAttribute("aria-checked")==="true";t!=null&&!o&&(e.click(),console.log('[AI Studio LOG] Enabled "thinking" feature.'),await new Promise(d=>setTimeout(d,w.PANEL_ANIMATION_MS)));const i=await p([m.MANUAL_BUDGET_TOGGLE]),a=h(i,HTMLButtonElement,"Manual budget toggle"),f=a.getAttribute("aria-checked")==="true";if(t!=null){f||(a.click(),console.log('[AI Studio LOG] Enabled "manual budget".'),await new Promise(r=>setTimeout(r,w.PANEL_ANIMATION_MS)));const d=await p([m.BUDGET_INPUT]),l=h(d,HTMLInputElement,"Budget input");l.value=t.toString(),l.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`[AI Studio LOG] Success: Set budget input to ${t}.`)}else f&&(a.click(),console.log('[AI Studio LOG] Success: Disabled "manual budget" as no value was provided.'))}async _setAdvancedOptions(t,n){if(console.log("[AI Studio LOG] Setting advanced options:",t),t.disableThinking!==void 0)if(n?.toLowerCase()==="gemini-2.5-pro")console.log('[AI Studio LOG] Skipping "disableThinking" toggle as it is not applicable for gemini-2.5-pro.');else{const o=await p([m.THINKING_TOGGLE]),i=h(o,HTMLButtonElement,"Thinking toggle"),a=i.getAttribute("aria-checked")==="true",f=!t.disableThinking;f!==a&&(i.click(),console.log(`[AI Studio LOG] Toggled thinking to: ${f?"enabled":"disabled"}`))}if(t.useWebSearch!==void 0||t.urlContext!==void 0){const o=(await C("p","Tools")).closest(m.TOOLS_TOGGLE_SELECTOR);if(o&&!o.classList.contains("expanded")&&(o.click(),await new Promise(i=>setTimeout(i,w.PANEL_ANIMATION_MS))),t.useWebSearch!==void 0){const i=await p([m.WEB_SEARCH_TOGGLE]),a=h(i,HTMLButtonElement,"Web search toggle");t.useWebSearch!==(a.getAttribute("aria-checked")==="true")&&(a.click(),console.log(`[AI Studio LOG] Toggled web search to: ${t.useWebSearch}`))}if(t.urlContext!==void 0){const i=await p([m.URL_CONTEXT_TOGGLE]),a=h(i,HTMLButtonElement,"URL context toggle");t.urlContext!==(a.getAttribute("aria-checked")==="true")&&(a.click(),console.log(`[AI Studio LOG] Toggled URL context to: ${t.urlContext}`))}}}async resetState(){console.log("[AI Studio] Preparing to reset UI state...");try{const t=Array.isArray(m.SETTINGS_PANEL_MOBILE_TOGGLE)?m.SETTINGS_PANEL_MOBILE_TOGGLE[0]:m.SETTINGS_PANEL_MOBILE_TOGGLE,n=t?document.querySelector(t):null,e=document.querySelector(m.NEW_CHAT_BUTTON);if(!e||e.offsetParent===null){console.warn('[AI Studio] "New Chat" button not found, assuming clean state and proceeding.'),await this.waitForReady();return}if(e.click(),console.log('[AI Studio] "New Chat" clicked. Waiting for UI transition...'),n){const o=_(5e3),i=Date.now();for(;document.body.contains(n);){if(Date.now()-i>o)throw this.createErrorWithContext("resetState","Old settings button did not disappear within timeout.",`Timeout=${o}ms`);await new Promise(a=>setTimeout(a,50))}console.log("[AI Studio] Old UI elements have been removed.")}await this.waitForReady(),console.log("[AI Studio] State reset completed successfully.")}catch(t){console.error("[AI Studio] A non-critical error occurred during state reset. Continuing under assumption that UI is ready.",t),await this.waitForReady()}}async waitForReady(){await I(m.PROMPT_INPUTS,"Prompt Input Area"),console.log("[AI Studio] UI is fully actionable and ready (prompt input is available).")}async setSystemPrompt(t){if(t){console.log("[AI Studio LOG] Setting system prompt."),await this.openSettingsPanel();try{const n=await p([m.SYSTEM_PROMPT_CARD]);h(n,HTMLButtonElement,"System prompt card").click(),await new Promise(d=>setTimeout(d,w.PANEL_ANIMATION_MS));const o=await p([m.SYSTEM_PROMPT_TEXTAREA]),i=h(o,HTMLTextAreaElement,"System prompt textarea");i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[AI Studio LOG] Success: System prompt entered.");const a=await p([m.DIALOG_CLOSE_BUTTON]);h(a,HTMLButtonElement,"Dialog close button").click(),await new Promise(d=>setTimeout(d,w.PANEL_ANIMATION_MS))}finally{await this.closeSettingsPanel()}}}async applyAllSettings(t){if(!(t.model||t.temperature!==void 0||t.topP!==void 0||t.thinkingBudget!==void 0||t.useWebSearch!==void 0||t.disableThinking!==void 0||t.urlContext!==void 0)){console.log("[AI Studio LOG] No settings to apply. Skipping panel.");return}await this.openSettingsPanel();try{t.model&&await this._setModel(t.model),t.temperature!==void 0&&await this._setTemperature(t.temperature),t.topP!==void 0&&await this._setTopP(t.topP),t.thinkingBudget!==void 0&&await this._setThinkingBudget(t.thinkingBudget);const e={useWebSearch:t.useWebSearch,disableThinking:t.disableThinking,urlContext:t.urlContext};Object.values(e).some(o=>o!==void 0)&&await this._setAdvancedOptions(e,t.model)}finally{await this.closeSettingsPanel()}}async sendPrompt(t){if(console.log("[AI Studio LOG] Starting automation with prompt:",t.substring(0,v.LOG_PREVIEW_LENGTH)),this.isLoginPage())return console.log("[AI Studio LOG] Login page detected. Notifying Dart."),L({type:Y,location:"sendPrompt",payload:"User needs to sign in to Google Account"}),new Promise(()=>{});try{const n=await I(m.PROMPT_INPUTS,"Prompt input area",_(M),2);if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.log("[AI Studio LOG] Prompt entered into input area, waiting for token count update...");else{const e=n?n.constructor.name:"null";throw this.createErrorWithContext("sendPrompt","Input area is not a valid textarea or input element.",`ElementType=${e}`)}return await new Promise((e,o)=>{const i=_(w.TOKEN_COUNT_UPDATE_TIMEOUT_MS),a=Date.now(),f=()=>{if(Date.now()-a>i){o(new Error(`Token count did not update within ${i}ms.`));return}const r=document.querySelector(m.TOKEN_COUNT)?.textContent?.trim();r&&!r.startsWith("0")?(console.log(`[AI Studio LOG] Token count updated: ${r}`),e()):setTimeout(f,w.TOKEN_COUNT_CHECK_INTERVAL_MS)};f()}),await new Promise(e=>setTimeout(e,w.UI_STABILIZE_AFTER_TOKEN_COUNT_MS)),console.log("[AI Studio LOG] UI stabilized after token count, proceeding to send."),await this.closeSettingsPanel(),this.retryOperation(async()=>{const e=await I(m.SEND_BUTTONS,"Send button",_(M),2);h(e,HTMLElement,"Send button").click(),console.log("[AI Studio LOG] Send button clicked successfully.")},"sendPrompt (click send button)",2,300)}catch(n){throw this.createErrorWithContext("sendPrompt",`Failed to send prompt: ${n instanceof Error?n.message:String(n)}`,`PromptLength=${t.length}`)}}findTurnContainerFromEditButton(t){const n=Array.isArray(m.CHAT_TURN)?m.CHAT_TURN.join(","):m.CHAT_TURN;return t.closest(n)}async extractResponse(){console.log(`[AI Studio LOG] Starting extraction process... (timeout: ${w.FINALIZED_TURN_TIMEOUT_MS}ms)`);const t=(a=w.FINALIZED_TURN_TIMEOUT_MS)=>new Promise((f,d)=>{const l=Array.isArray(m.EDIT_BUTTON)?m.EDIT_BUTTON.join(","):m.EDIT_BUTTON;let r=null,u=null;const c=()=>{r&&r.disconnect(),u&&clearTimeout(u)},E=()=>{const T=document.querySelectorAll(l);if(T.length===0)return;const g=T[T.length-1],b=this.findTurnContainerFromEditButton(g);b&&!b.querySelector('button[aria-label="Stop editing"]')&&g.offsetParent!==null&&!g.disabled&&(console.log("[AI Studio LOG] Found finalized turn via MutationObserver check."),c(),f({turn:b,editButton:g}))};r=new MutationObserver(E),r.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-label","disabled"]}),u=window.setTimeout(()=>{c();const g=`Extraction timed out. Final state: ${document.querySelectorAll(l).length} edit buttons found. The last response may still be generating or the UI has changed.`;console.error(`[AI Studio LOG] ${g}`),d(new Error(g))},a),E()}),{turn:n,editButton:e}=await t();console.log("[AI Studio LOG] Finalized turn found, clicking edit button..."),e.click(),console.log("[AI Studio LOG] Waiting for textarea to appear...");const o=await x(n,m.EDIT_TEXTAREA,w.TEXTAREA_APPEAR_TIMEOUT_MS);console.log("[AI Studio LOG] Textarea appeared, waiting for UI to stabilize..."),await new Promise(a=>setTimeout(a,w.UI_STABILIZE_DELAY_MS));const i=(o.value??o.innerText??"").trim();if(!i){const a="Textarea was found but it was empty.";throw console.error(`[AI Studio LOG] ${a}`),this.createErrorWithContext("extractResponse",a,"Textarea was found but contained no content")}console.log(`[AI Studio LOG] Extracted ${i.length} chars successfully.`);try{const a=n.querySelector(m.STOP_EDITING_BUTTON);a&&(a.click(),console.log("[AI Studio LOG] Exited edit mode successfully."))}catch(a){console.warn("[AI Studio LOG] Could not exit edit mode, but extraction was successful. This is non-critical.",a)}return i}}const y={READINESS:".current-model",PROMPT_INPUT:"div[contenteditable=true]",SEND_BUTTON_CONTAINER:".send-button-container",SEND_BUTTON:"div.send-button",GENERATING_INDICATOR:'path[d="M331.946667 379.904c-11.946667 23.466667-11.946667 54.186667-11.946667 115.626667v32.938666c0 61.44 0 92.16 11.946667 115.626667 10.538667 20.650667 27.306667 37.418667 47.957333 47.957333 23.466667 11.946667 54.186667 11.946667 115.626667 11.946667h32.938666c61.44 0 92.16 0 115.626667-11.946667 20.650667-10.538667 37.418667-27.306667 47.957333-47.957333 11.946667-23.466667 11.946667-54.186667 11.946667-115.626667v-32.938666c0-61.44 0-92.16-11.946667-115.626667a109.696 109.696 0 0 0-47.957333-47.957333c-23.466667-11.946667-54.186667-11.946667-115.626667-11.946667h-32.938666c-61.44 0-92.16 0-115.626667 11.946667-20.650667 10.538667-37.418667 27.306667-47.957333 47.957333z"]',RESPONSE_CONTAINER:".segment-content",RESPONSE_TEXT:".segment-content > div:first-child",COPY_BUTTON:".segment-assistant-actions-content div[data-v-10d40aa8]"};class dt{async waitForReady(){console.log("[Kimi] Waiting for UI to be ready..."),await p([y.READINESS],_(1e4)),console.log("[Kimi] UI is ready.")}async sendPrompt(t){console.log("[Kimi] Starting sendPrompt workflow...");const n=await I([y.PROMPT_INPUT],"Prompt Input");console.log("[Kimi] Dispatching InputEvent to contenteditable div..."),n.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:t})),console.log("[Kimi] Waiting for send button to become enabled..."),await new Promise((o,i)=>{const a=_(5e3),f=100;let d=0;const r=setInterval(()=>{const u=document.querySelector(y.SEND_BUTTON_CONTAINER);u&&!u.classList.contains("disabled")?(clearInterval(r),console.log("[Kimi] Send button is now enabled."),o()):(d+=f,d>=a&&(clearInterval(r),i(new Error("Send button did not become enabled in time."))))},f)});const e=await I([y.SEND_BUTTON],"Send Button");console.log("[Kimi] Clicking send button..."),e.click(),console.log("[Kimi] Send button clicked successfully.")}async extractResponse(){console.log("[Kimi] Starting response extraction..."),console.log("[Kimi] Waiting for generating indicator to appear..."),await p([y.GENERATING_INDICATOR],_(5e3)),console.log("[Kimi] Generating indicator appeared. Waiting for it to disappear..."),await new Promise((i,a)=>{const f=_(6e4),d=200;let l=0;const u=setInterval(()=>{document.querySelector(y.GENERATING_INDICATOR)?(l+=d,l>=f&&(clearInterval(u),a(new Error("Response generation timed out.")))):(clearInterval(u),console.log("[Kimi] Generating indicator disappeared. Response should be complete."),i())},d)}),console.log("[Kimi] Finding response containers...");const t=document.querySelectorAll(y.RESPONSE_CONTAINER);if(t.length===0)throw new Error("No response containers found.");const n=t[t.length-1];if(!n)throw new Error("Could not find last response container.");console.log(`[Kimi] Found ${t.length} response container(s). Targeting the last one.`),console.log("[Kimi] Waiting for copy button to appear (confirms response is complete)..."),await x(n,[y.COPY_BUTTON],_(5e3)),console.log("[Kimi] Copy button found. Response is complete.");const e=n.querySelector(y.RESPONSE_TEXT);if(!e)throw new Error("Could not find response text element within the final container.");const o=e.textContent?.trim();if(!o)throw new Error("Response text element was found, but it is empty.");return console.log(`[Kimi] Response extracted successfully (${o.length} characters).`),o}}const Et=new dt,Tt=100,gt=300,mt=250,ft=0,St=100;function W(){if(window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function")try{window.flutter_inappwebview.callHandler(V),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(s){console.warn("[Engine] Failed to send bridge ready signal:",s)}}document.addEventListener("flutterInAppWebViewPlatformReady",()=>{console.log("[Engine] Received flutterInAppWebViewPlatformReady event"),W()});function G(s=Tt,t=gt){if(s<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function"?W():setTimeout(()=>G(s-1,t),t)}if(window.__AI_HYBRID_HUB_INITIALIZED__&&(console.log("[Engine] Bridge script already initialized. Checking if functions exist..."),typeof window.startAutomation<"u"&&typeof window.extractFinalResponse<"u"&&typeof window.inspectDOMForSelectors<"u"?(console.log("[Engine] Functions exist, signaling ready."),G()):(console.warn("[Engine] Flag set but functions missing! Force re-initialization."),delete window.__AI_HYBRID_HUB_INITIALIZED__)),!window.__AI_HYBRID_HUB_INITIALIZED__){let s=function(r){const u=f[r];return u?(console.log(`[Engine] Matched providerId: "${r}". Using corresponding chatbot module.`),u):(console.error(`[Engine] No chatbot module found for providerId: "${r}"`),null)},t=function(r,u=document){try{const c=u.querySelector(r);if(c)return c;const E=u.querySelectorAll("*");for(const T of E)if(T.shadowRoot){const g=t(r,T.shadowRoot);if(g)return g}}catch{}return null},n=function(){l&&clearTimeout(l),l=window.setTimeout(()=>{const r=document.querySelector(".model-error mat-icon");if(r&&r.textContent?.trim()==="error"&&!window.__hasAttemptedRetry){window.__hasAttemptedRetry=!0,console.warn("[Observer] Detected transient model error. Requesting retry from Dart."),L({type:X}),i();return}const u='[id^="turn-"], ms-chat-turn',c='button[aria-label="Edit"]',E=document.querySelectorAll(u);if(E.length===0)return;const T=E[E.length-1],g=T.querySelector(c);if(!g)return;const O=Array.from(T.querySelectorAll('textarea, [contenteditable="true"]')).filter(wt=>wt.closest("ms-chunk-input")===null).length===0,S=g.offsetParent!==null,A=!g.disabled&&!g.hasAttribute("inert");O&&S&&A&&(console.log("[Observer] Detected finalized response in the last chat turn. Notifying Dart that UI is ready for refinement."),L({type:K}),i())},mt)},e=function(r){if(r.type!=="childList"||r.addedNodes.length===0)return!1;for(let u=0;u<r.addedNodes.length;u++){const c=r.addedNodes[u];if(c&&c.nodeType===Node.ELEMENT_NODE){const E=c;if(E.tagName==="BUTTON"||E.querySelector("button"))return!0}}return!1},o=function(){d&&i();let r=document.querySelector("ms-chat-session");r||(console.warn("[Observer] Specific container (ms-chat-session) not found, falling back to body"),r=document.body),d=new MutationObserver(u=>{u.filter(e).length>0&&n()}),d.observe(r,{childList:!0,subtree:!0}),console.log(`[Observer] Started observing DOM for new responses (target: ${r.tagName}${r.id?"#"+r.id:""}).`)},i=function(){d&&(d.disconnect(),d=null,console.log("[Observer] Stopped observing DOM.")),l&&(clearTimeout(l),l=null)};window.__AI_HYBRID_HUB_INITIALIZED__=!0,window.__processedFootersCount=ft;let a=null;const f={ai_studio:new ut,kimi:Et};window.startAutomation=async function(r){console.log("[Engine LOG] >>> Full automation cycle started by Dart. Options:",JSON.stringify(r,null,2)),window.__hasAttemptedRetry=!1,window.__AI_TIMEOUT_MODIFIER__=r.timeoutModifier??1,console.log(`[Engine] Using timeout modifier: ${window.__AI_TIMEOUT_MODIFIER__}x`),a=r.providerId;const u=s(r.providerId);if(!u){L({type:N,errorCode:"UNSUPPORTED_PROVIDER",payload:`Provider "${r.providerId}" is not supported.`});return}const c=Date.now();let E="Initialization";try{u.resetState&&(E="Phase 1: Resetting UI state",console.log(`[Engine LOG] ${E}...`),await u.resetState()),E="Phase 2: Waiting for UI to be ready",console.log(`[Engine LOG] ${E}...`),await u.waitForReady(),E="Phase 3: Applying configurations",console.log(`[Engine LOG] ${E}...`),r.systemPrompt&&u.setSystemPrompt&&(console.log(`[Engine LOG] Setting system prompt (length: ${r.systemPrompt.length})`),await u.setSystemPrompt(r.systemPrompt)),u.applyAllSettings&&await u.applyAllSettings(r),E="Phase 4: Entering and sending prompt",console.log(`[Engine LOG] ${E}...`),await u.sendPrompt(r.prompt),E="Phase 5: Starting response observer",console.log(`[Engine LOG] ${E}...`),o();const T=Date.now()-c;console.log(`[Engine LOG] Full automation cycle initiated successfully in ${T}ms. Now observing for response.`)}catch(T){const g=T instanceof Error?T.message:String(T),b=Date.now()-c,O={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};console.error(`[Engine LOG] Full automation cycle failed in ${E} after ${b}ms!`,T);const S={phase:E,elapsedTimeMs:b,url:O.url,readyState:O.readyState,visibleElements:O.visibleElements,timestamp:new Date().toISOString()};throw(g.includes("Selector")||g.includes("selector"))&&(S.selectorContext="Error message contains selector information"),L({type:N,errorCode:"FULL_CYCLE_FAILED",location:"startAutomation",payload:g,diagnostics:S}),T}},window.extractFinalResponse=async function(){if(console.log("[Engine LOG] extractFinalResponse called"),!a){const c="No providerId available for extraction. Automation must be started first.";throw console.error("[Engine LOG] No providerId found for extraction"),L({type:N,errorCode:"NO_PROVIDER_ID",payload:c}),new Error(c)}const r=s(a);if(!r){const c=`Provider "${a}" is not supported for extraction.`;throw console.error("[Engine LOG] No chatbot found for extraction"),L({type:N,errorCode:"UNSUPPORTED_PROVIDER",payload:c}),new Error(c)}const u=Date.now();console.log(`[Engine LOG] Starting extraction with chatbot: ${r.constructor.name}`);try{console.log("[Engine LOG] [ENHANCED] DOM state before extraction:",{url:window.location.href,readyState:document.readyState,title:document.title,timestamp:new Date().toISOString()});const c=await r.extractResponse(),E=Date.now()-u;return console.log(`[Engine LOG] Extraction completed successfully in ${E}ms, extracted ${c.length} chars`),console.log("[Engine LOG] [ENHANCED] Extraction result details:",{success:!0,resultLength:c.length,resultPreview:c.substring(0,100)+(c.length>100?"...":""),elapsedTime:E}),c}catch(c){const E=c instanceof Error?c.message:String(c),T=Date.now()-u;console.error("[Engine LOG] [ENHANCED] Extraction failed with details:",{success:!1,errorMessage:E,errorType:c instanceof Error?c.constructor.name:typeof c,elapsedTime:T,timestamp:new Date().toISOString(),domState:{url:window.location.href,readyState:document.readyState,title:document.title,editButtons:document.querySelectorAll('button[aria-label="Edit"]').length,textareas:document.querySelectorAll('textarea, [contenteditable="true"]').length}});const g=`Extraction failed: ${E} (Type: ${c instanceof Error?c.constructor.name:typeof c}, Time: ${T}ms)`;throw console.error(`[Engine LOG] ${g}`),L({type:N,errorCode:"EXTRACTION_FAILED",payload:g}),c}},window.inspectDOMForSelectors=function(){const r={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},u=document.querySelectorAll("*");for(const S of u)if(S.shadowRoot){r.shadowDOMDetected=!0;break}const c=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],E={};for(const S of c)try{E[S]=document.querySelector(S),E[S]||(E[`${S} (shadow)`]=t(S))}catch{E[S]=null}r.allSelectorsTested.promptInput=E;const T=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],g={};for(const S of T)try{g[S]=document.querySelector(S),g[S]||(g[`${S} (shadow)`]=t(S))}catch{g[S]=null}r.allSelectorsTested.sendButton=g;const b=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));r.inputs=b.map(S=>{const A=S;return{tag:S.tagName.toLowerCase(),type:A.getAttribute("type")||"",placeholder:A.getAttribute("placeholder")||"",ariaLabel:A.getAttribute("aria-label")||"",id:S.id||"",className:S.className||"",contentEditable:A.contentEditable,visible:A.offsetParent!==null,inShadowDOM:!1}});const O=Array.from(document.querySelectorAll("button"));return r.buttons=O.map(S=>{const A=S;return{tag:S.tagName.toLowerCase(),ariaLabel:A.getAttribute("aria-label")||"",text:(A.innerText||"").substring(0,St),id:S.id||"",className:S.className||"",type:A.getAttribute("type")||"",visible:A.offsetParent!==null,inShadowDOM:!1}}),r};let d=null,l=null;console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),G()}})();
