(function(){"use strict";function u(e){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler("automationBridge",e)}function f(e,t,o=!1){try{const n=e.split(":contains")[0],l=document.querySelectorAll(n||"*");for(const a of l){const c=a.textContent||"",s=o?c:c.toLowerCase(),r=o?t:t.toLowerCase();if(s.includes(r))return a}}catch{}return null}function d(e,t=1e4){return new Promise((o,n)=>{let a=0;const c=setInterval(()=>{for(const s of e){let r=null;if(s.includes(":contains(")){const i=s.match(/^(.+):contains\(['"](.+)['"]\)$/);i&&i[1]&&i[2]&&(r=f(i[1],i[2]))}else try{r=document.querySelector(s),!r&&a===0&&console.log(`[waitForElement] Selector "${s}" not found on first attempt`)}catch(i){console.warn(`[waitForElement] Invalid selector "${s}":`,i);continue}if(r){console.log(`[waitForElement] Found element with selector "${s}"`),clearInterval(c),o(r);return}}a+=300,a>=t&&(clearInterval(c),n(new Error(`None of the selectors [${e.join(", ")}] found within ${t}ms`)))},300)})}const w=["ms-incognito-mode-toggle > button","button.runsettings-toggle-button","button.model-selector-card","ms-chunk-input textarea"],h="ms-chunk-input textarea",y="ms-run-button > button",E='ms-chat-turn[data-turn-role="Model"]',S="span.v3-token-count-value",T=["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']","textarea[placeholder*='typing a prompt']","input[placeholder*='Start typing a prompt']","input[placeholder*='typing a prompt']","textarea[placeholder*='prompt']","input[placeholder*='prompt']","input-area","textarea[aria-label*='prompt']","textarea[name*='prompt']","textarea[id*='prompt']",".ql-editor","div[contenteditable='true']","textarea","input[type='text']"],A=['ms-run-button > button[aria-label="Run"]',"ms-run-button > button",'button[aria-label="Run"]','button[aria-label*="Run"]','button[aria-label*="Append to prompt and run"]','button[aria-label*="Append to Prompt and run"]','button[aria-label*="run"]','send-button[variant="primary"]','button[aria-label*="Send"]','button:contains("Run")',".send-button button",'button[type="submit"]',"button"];function x(){const e=window.location.href.toLowerCase();if(e.includes("accounts.google.com")||e.includes("/signin"))return!0;const t=document.querySelector('input[placeholder*="Email or phone"], input[type="email"]'),o=document.body?.innerText?.includes("Sign in")||document.body?.innerText?.includes("Use your Google Account");return t&&o?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}function I(){const e=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]')),t=Array.from(document.querySelectorAll("button"));console.log("[AI Studio] Found inputs:",e.map(o=>({tag:o.tagName,type:o.getAttribute("type"),placeholder:o.getAttribute("placeholder"),ariaLabel:o.getAttribute("aria-label"),id:o.id,className:o.className,contentEditable:o.contentEditable}))),console.log("[AI Studio] Found buttons:",t.slice(0,10).map(o=>({tag:o.tagName,ariaLabel:o.getAttribute("aria-label"),text:o.innerText?.substring(0,50),id:o.id,className:o.className,type:o.getAttribute("type")})))}function v(e){const t=e.cloneNode(!0);t.querySelector(".turn-footer")?.remove(),t.querySelector(".author-label")?.remove(),t.querySelector(".actions-container")?.remove(),t.querySelector("ms-thought-chunk")?.remove(),t.querySelectorAll('button, nav, [role="button"], [aria-label*="Edit"], [aria-label*="Rerun"], [aria-label*="Good"], [aria-label*="Bad"], [aria-label*="More"], .scrollbar-item, .navigation, [data-testid*="button"]').forEach(l=>l.remove());let n=(t.textContent||t.innerText||"").trim();return n=n.replace(/\n{3,}/g,`

`),n=n.replace(/^\s+|\s+$/gm,""),n}const b={waitForReady:async()=>{await d(w,2e4),console.log("[AI Studio] UI is ready.")},sendPrompt:async e=>{if(console.log("[AI Studio] Starting automation with prompt:",e.substring(0,50)),x()){console.log("[AI Studio] Login page detected. Pausing automation."),u({type:"LOGIN_REQUIRED",location:"sendPrompt",payload:"User needs to sign in to Google Account"});return}I(),console.log("[AI Studio] Waiting for input area...");const t=await d([h,...T]);if(console.log("[AI Studio] Found input area:",t.tagName,t.className),t.tagName==="TEXTAREA"||t.tagName==="INPUT"){const n=t;n.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}else if(t instanceof HTMLElement&&t.contentEditable==="true"){const n=t;n.innerText=e,t.dispatchEvent(new Event("input",{bubbles:!0}))}else{const n=t;n.click(),await new Promise(a=>setTimeout(()=>a(),500));const l=n;l.value!==void 0&&(l.value=e)}await new Promise(n=>{const l=()=>{const c=document.querySelector(S)?.textContent?.trim();c&&!c.startsWith("0")?(console.log("[AI Studio] Token count updated."),n()):setTimeout(l,100)};l()}),console.log("[AI Studio] Waiting for send button...");const o=await d([y,...A]);console.log("[AI Studio] Found send button:",o.tagName,o.className,o.getAttribute("aria-label")),o.click(),console.log("[AI Studio] Clicked send button. Prompt sent.")},extractResponse:async()=>{console.log("[AI Studio] Starting robust extraction...");const e=await d([`${E}:has(.turn-footer button[iconname="thumb_up"])`],15e3);console.log("[AI Studio] Last model turn with footer is stable.");const t=v(e);if(!t)throw new Error("Extraction resulted in an empty string after cleaning.");return console.log("[AI Studio] Returning value:",`"${t.substring(0,100)}..."`,"with type:",typeof t),t},waitForResponse:e=>new Promise((t,o)=>{let n;const l=new MutationObserver(()=>{clearTimeout(n),n=setTimeout(()=>{console.log("[Observer] DOM is stable. Checking for new response footer...");const c=document.querySelectorAll('ms-chat-turn[data-turn-role="Model"] .turn-footer'),s=c.length>0?c[c.length-1]:null;s&&s.querySelector('button[iconname="thumb_up"]')&&!s.__cwc_processed&&(console.log("[Observer] New, complete response footer found. Success!"),s.__cwc_processed=!0,l.disconnect(),clearTimeout(a),t())},200)});l.observe(document.body,{childList:!0,subtree:!0});const a=setTimeout(()=>{l.disconnect(),o(new Error(`Timeout: No stable response detected within ${e/1e3}s.`))},e)})};window.__processedFootersCount=0;const R={"https://aistudio.google.com/prompts/new_chat":b};function p(){const e=window.location.href;if(e.startsWith("file://")||document.querySelector("ms-chunk-input textarea")!==null||document.querySelector("h1")?.textContent?.includes("High-Fidelity Sandbox"))return console.log("[Engine] Local sandbox detected. Using AI Studio chatbot module for testing."),b;for(const[o,n]of Object.entries(R))if(e.startsWith(o))return console.log(`[Engine] Matched site: ${o}. Using corresponding chatbot module.`),n;return console.error(`[Engine] No chatbot module found for current URL: ${e}`),null}window.startAutomation=async function(e){const t=p();if(!t){u({type:"AUTOMATION_FAILED",errorCode:"UNSUPPORTED_SITE",payload:"This site is not supported."});return}try{console.log("[Engine] Waiting for chatbot page to be ready..."),await t.waitForReady(),console.log("[Engine] Page is ready. Sending prompt..."),await t.sendPrompt(e),console.log("[Engine] Prompt sent. Observation will be handled by Dart.")}catch(o){const n=o instanceof Error?o.message:String(o);throw u({type:"AUTOMATION_FAILED",errorCode:"AUTOMATION_EXECUTION_FAILED",location:"startAutomation",payload:n}),o}},window.extractFinalResponse=async function(){const e=p();if(!e){const t="This site is not supported for extraction.";throw u({type:"AUTOMATION_FAILED",errorCode:"UNSUPPORTED_SITE",payload:t}),new Error(t)}try{return await e.extractResponse()}catch(t){const o=t instanceof Error?t.message:String(t);throw u({type:"AUTOMATION_FAILED",errorCode:"RESPONSE_EXTRACTION_FAILED",location:"extractFinalResponse",payload:o}),t}},window.waitForResponseCompletion=async function(e=6e4){const t=p();if(!t||!t.waitForResponse)return console.warn("[Engine] Current chatbot does not support waitForResponse."),!0;try{return await t.waitForResponse(e),!0}catch(o){return console.error("[Engine] Error waiting for response:",o),!1}};function m(e,t=document){try{const o=t.querySelector(e);if(o)return o;const n=t.querySelectorAll("*");for(const l of n)if(l.shadowRoot){const a=m(e,l.shadowRoot);if(a)return a}}catch{}return null}window.inspectDOMForSelectors=function(){const e={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},t=document.querySelectorAll("*");for(const r of t)if(r.shadowRoot){e.shadowDOMDetected=!0;break}const o=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],n={};for(const r of o)try{n[r]=document.querySelector(r),n[r]||(n[`${r} (shadow)`]=m(r))}catch{n[r]=null}e.allSelectorsTested.promptInput=n;const l=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],a={};for(const r of l)try{a[r]=document.querySelector(r),a[r]||(a[`${r} (shadow)`]=m(r))}catch{a[r]=null}e.allSelectorsTested.sendButton=a;const c=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));e.inputs=c.map(r=>{const i=r;return{tag:r.tagName.toLowerCase(),type:i.getAttribute("type")||"",placeholder:i.getAttribute("placeholder")||"",ariaLabel:i.getAttribute("aria-label")||"",id:r.id||"",className:r.className||"",contentEditable:i.contentEditable,visible:i.offsetParent!==null,inShadowDOM:!1}});const s=Array.from(document.querySelectorAll("button"));return e.buttons=s.map(r=>{const i=r;return{tag:r.tagName.toLowerCase(),ariaLabel:i.getAttribute("aria-label")||"",text:(i.innerText||"").substring(0,100),id:r.id||"",className:r.className||"",type:i.getAttribute("type")||"",visible:i.offsetParent!==null,inShadowDOM:!1}}),e};function O(){const e=window;if(e.flutter_inappwebview)try{e.flutter_inappwebview.callHandler("bridgeReady"),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(t){console.warn("[Engine] Failed to send bridge ready signal:",t)}}function g(e=100,t=300){if(e<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview?O():setTimeout(()=>g(e-1,t),t)}console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),console.log("[Engine] startAutomation available:",typeof window.startAutomation),console.log("[Engine] extractFinalResponse available:",typeof window.extractFinalResponse),console.log("[Engine] window.flutter_inappwebview available:",typeof window.flutter_inappwebview),console.log("[Engine] Document ready state:",document.readyState),console.log("[Engine] Document body exists:",!!document.body),g()})();
