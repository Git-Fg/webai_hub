(function(){"use strict";const W="automationBridge",K="bridgeReady",V="NEW_RESPONSE_DETECTED",Y="LOGIN_REQUIRED",N="AUTOMATION_FAILED";function A(s){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler(W,s)}function S(s){const t=window.__AI_TIMEOUT_MODIFIER__??1;return s*t}const M=1e4,$=300,C=2,z=300,X=2e3;function Z(){return{url:window.location.href,readyState:document.readyState,visibleElementsCount:document.querySelectorAll("*").length}}function G(s,t,n,e="waitForElement"){const o=Z();return`${e} failed: None of the selectors [${s.join(", ")}] found within ${t}ms
Context: URL=${o.url}, Timeout=${t}ms, Elapsed=${n}ms
Page State: Ready=${o.readyState}, VisibleElements=${o.visibleElementsCount}`}function B(s,t,n){for(let e=0;e<s.length;e++){const o=s[e];if(!o)continue;let r=null;try{t?r=t.querySelector(o):r=document.querySelector(o)}catch(i){console.warn(`[${n}] Invalid selector "${o}" (index ${e}):`,i);continue}if(r)return r}return null}async function U(s,t,n="waitForElement",e){return new Promise((o,r)=>{const i=Date.now();let a=0,c=null,l=null,E=null,g=!1;console.log(`[${n}] Starting search for selectors: [${s.join(", ")}] (timeout: ${t}ms)`);const u=()=>{c&&(c.disconnect(),c=null),l!==null&&(clearTimeout(l),l=null),E!==null&&(clearInterval(E),E=null)},f=()=>{const d=Date.now()-i;d-a>=X&&(console.log(`[${n}] Still searching... (elapsed: ${d}ms, remaining: ${t-d}ms)`),a=d),g||(B(s,e,n)||console.log(`[${n}] Selectors not found on first attempt`),g=!0);const m=B(s,e,n);if(m){const _=Date.now()-i,O=s.find(L=>{if(!L)return!1;try{return e?e.querySelector(L)===m:document.querySelector(L)===m}catch{return!1}});console.log(`[${n}] Found element with selector "${O||"unknown"}" after ${_}ms`),u(),o(m);return}if(d>=t){u();const _=G(s,t,d,n);r(new Error(_))}};if(typeof MutationObserver<"u"){c=new MutationObserver(()=>{f()});const d=e||document.body;c.observe(d,{childList:!0,subtree:!0}),f()}else console.warn(`[${n}] MutationObserver not available, using polling fallback`),E=window.setInterval(f,$),f();l=window.setTimeout(()=>{u();const d=Date.now()-i,m=G(s,t,d,n);r(new Error(m))},t)})}function h(s,t=M,n=C){const e=S(t);return v(()=>U(s,e,"waitForElement"),n,"waitForElement")}function k(s,t,n=M,e=C){const o=S(n);return v(()=>U(t,o,"waitForElementWithin",s),e,"waitForElementWithin")}function P(s,t,n=M,e=C){const o=S(n);return v(()=>j(s,t,o),e,"waitForElementByText")}async function j(s,t,n){return new Promise((e,o)=>{const r=Date.now();let i=null,a=null;const c=()=>{i&&(i.disconnect(),i=null),a!==null&&(clearTimeout(a),a=null)},l=()=>{const E=document.querySelectorAll(s);for(const u of E)if(u.textContent?.includes(t)){const f=Date.now()-r;console.log(`[waitForElementByText] Found element with text "${t}" after ${f}ms`),c(),e(u);return}Date.now()-r>=n&&(c(),o(new Error(`Element with selector "${s}" containing text "${t}" not found within ${n}ms`)))};if(typeof MutationObserver<"u")i=new MutationObserver(()=>{l()}),i.observe(document.body,{childList:!0,subtree:!0}),l();else{console.warn("[waitForElementByText] MutationObserver not available, using polling fallback");const E=window.setInterval(l,$);l(),a=window.setTimeout(()=>{clearInterval(E),c(),o(new Error(`Element with selector "${s}" containing text "${t}" not found within ${n}ms`))},n)}})}async function v(s,t,n){let e=null;for(let o=0;o<=t;o++)try{return await s()}catch(r){if(e=r instanceof Error?r:new Error(String(r)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors"))||o>=t)throw e;const a=z*Math.pow(2,o);console.log(`[${n}] Retry ${o+1}/${t} after ${a}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(c=>setTimeout(c,a))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}const J=1e4,Q=2,x=1e3,tt=2e3;function et(s){return s.isConnected===!0}function nt(s){if(typeof s.checkVisibility=="function")try{return s.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}catch{}return s.offsetParent!==null}async function ot(s,t=x){try{const n=s.getAnimations();if(n.length===0)return!0;const e=n.map(r=>r.finished);return await Promise.race([Promise.all(e),new Promise(r=>setTimeout(r,t))]),s.getAnimations().length===0}catch{return!0}}function it(s){if(s.disabled===!0||s.getAttribute("aria-disabled")==="true"||s.hasAttribute("inert"))return!1;let n=s.parentElement;for(;n;){if(n.hasAttribute("inert"))return!1;n=n.parentElement}return!0}function rt(s){try{const t=s.getBoundingClientRect(),n=t.left+t.width/2,e=t.top+t.height/2,o=document.elementFromPoint(n,e);return o?s.contains(o)||o===s:!1}catch{return!0}}async function F(s,t=x){const n=s,e={attached:!1,visible:!1,stable:!1,enabled:!1,unoccluded:!1,details:{}};if(e.attached=et(s),e.details.isConnected=s.isConnected,!e.attached)return{actionable:!1,diagnostics:e};e.visible=nt(n);try{typeof n.checkVisibility=="function"&&(e.details.checkVisibilityResult=n.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0}))}catch{}if(e.details.offsetParent=n.offsetParent,!e.visible)return{actionable:!1,diagnostics:e};e.stable=await ot(n,t);try{const r=n.getAnimations();e.details.animationsCount=r.length}catch{}if(!e.stable)return{actionable:!1,diagnostics:e};if(e.enabled=it(n),e.details.disabled=n.disabled,e.details.ariaDisabled=n.getAttribute("aria-disabled"),e.details.inert=n.hasAttribute("inert"),!e.enabled)return{actionable:!1,diagnostics:e};if(e.unoccluded=rt(n),!e.unoccluded)try{const r=n.getBoundingClientRect(),i=r.left+r.width/2,a=r.top+r.height/2;e.details.occludingElement=document.elementFromPoint(i,a)}catch{}return{actionable:e.attached&&e.visible&&e.stable&&e.enabled&&e.unoccluded,diagnostics:e}}function at(s,t,n,e="element"){const o=[];n.attached||o.push("not attached to DOM"),n.visible||o.push("not visible"),n.stable||o.push("has ongoing animations"),n.enabled||o.push("disabled or inert"),n.unoccluded||o.push("occluded by another element");const r={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};return`${e} is not actionable: ${o.join(", ")}
Selectors: [${s.join(", ")}]
Timeout: ${t}ms
Diagnostics: ${JSON.stringify(n.details,null,2)}
Page State: URL=${r.url}, ReadyState=${r.readyState}, VisibleElements=${r.visibleElements}`}async function st(s,t,n,e){const o=Date.now();let r=0;return console.log(`[waitForActionableElement] Starting search for actionable ${t} with selectors: [${s.join(", ")}] (timeout: ${n}ms)`),new Promise((i,a)=>{let c=null,l=null,E=null;const g=()=>{c&&(c.disconnect(),c=null),l!==null&&(clearTimeout(l),l=null),E!==null&&(clearInterval(E),E=null)},u=async()=>{const f=Date.now()-o;f-r>=tt&&(console.log(`[waitForActionableElement] Still checking actionability for ${t}... (elapsed: ${f}ms)`),r=f);for(const d of s){if(!d)continue;let m=null;try{e||(m=document.querySelector(d))}catch(_){console.warn(`[waitForActionableElement] Invalid selector "${d}":`,_);continue}if(m){const{actionable:_,diagnostics:O}=await F(m);if(_){const L=Date.now()-o;console.log(`[waitForActionableElement] Found actionable ${t} with selector "${d}" after ${L}ms`),g(),i(m);return}else console.log(`[waitForActionableElement] Element found but not actionable: ${JSON.stringify(O.details)}`)}}if(f>=n){g();let d=null;for(const m of s)try{if(e||(d=document.querySelector(m)),d)break}catch{}if(d){const{diagnostics:m}=await F(d);a(new Error(at(s,n,m,t)))}else a(new Error(`waitForActionableElement failed: None of the selectors [${s.join(", ")}] found within ${n}ms`))}};if(typeof MutationObserver<"u"){c=new MutationObserver(()=>{u()});const f=document.body;c.observe(f,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","inert","style","class"]}),u()}else console.warn("[waitForActionableElement] MutationObserver not available, using polling fallback"),E=window.setInterval(u,100),u();l=window.setTimeout(()=>{g(),u()},n)})}function I(s,t="element",n=J,e=Q){const o=S(n);return lt(()=>st(s,t,o),e,`waitForActionableElement(${t})`)}async function lt(s,t,n){let e=null;const o=300;for(let r=0;r<=t;r++)try{return await s()}catch(i){if(e=i instanceof Error?i:new Error(String(i)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors")||e.message.includes("not actionable"))||r>=t)throw e;const c=o*Math.pow(2,r);console.log(`[${n}] Retry ${r+1}/${t} after ${c}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(l=>setTimeout(l,c))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}function b(s,t,n="DOM assertion"){if(!s)throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but the element is null.`);if(!(s instanceof t))throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but got ${s.constructor.name}.`);return s}const y=1e4,w={READINESS_CHECK_INTERVAL_MS:100,TOKEN_COUNT_UPDATE_TIMEOUT_MS:1e4,TOKEN_COUNT_CHECK_INTERVAL_MS:100,UI_STABILIZE_AFTER_TOKEN_COUNT_MS:30,FINALIZED_TURN_TIMEOUT_MS:15e3,FINALIZED_TURN_CHECK_INTERVAL_MS:1e3,EDIT_BUTTON_WAIT_TIMEOUT_MS:2e3,TEXTAREA_APPEAR_TIMEOUT_MS:5e3,UI_STABILIZE_DELAY_MS:150,PANEL_ANIMATION_MS:250,POLL_INTERVAL_MS:100,POLL_TIMEOUT_MS:5e3,UI_STATE_DEBOUNCE_DELAY_MS:250},T={NEW_CHAT_BUTTON:'a[href="/prompts/new_chat"]',RUN_SETTINGS_TOGGLE_MOBILE:"button.runsettings-toggle-button",MODEL_SELECTOR_DESKTOP:"button.model-selector-card",PROMPT_INPUTS:["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']"],SEND_BUTTONS:['ms-run-button > button[aria-label="Run"]','ms-run-button > button[type="submit"]','button[aria-label="Run"]',"ms-run-button > button"],TOKEN_COUNT:"span.v3-token-count-value",EDIT_BUTTON:['button[aria-label="Edit"]','button[aria-label*="edit" i]','button:has([aria-label*="edit" i])'],EDIT_TEXTAREA:["textarea",'div[contenteditable="true"]','[contenteditable="true"]'],STOP_EDITING_BUTTON:'button[aria-label="Stop editing"]',CHAT_TURN:['[id^="turn-"]',"ms-chat-turn"],SETTINGS_PANEL_MOBILE_TOGGLE:['button[aria-label="Toggle run settings panel"]',"button.runsettings-toggle-button"],SETTINGS_PANEL_CLOSE_BUTTON:'ms-run-settings button[iconname="close"]',MODEL_SELECTOR_CARD:"button.model-selector-card",MODEL_CATEGORIES_ALL_BUTTON:"button[data-test-category-button]",MODEL_CAROUSEL_BUTTON:"ms-model-carousel-row button.content-button",MODEL_TITLE_TEXT:"span.model-title-text",SYSTEM_PROMPT_CARD:"button[data-test-system-instructions-card]",SYSTEM_PROMPT_TEXTAREA:"ms-system-instructions textarea",DIALOG_CLOSE_BUTTON:"mat-dialog-container button[data-test-close-button]",MODEL_DIALOG_CONTAINER:"mat-dialog-container",ADVANCED_SETTINGS_TOGGLE:"div.settings-item",THINKING_TOGGLE:'mat-slide-toggle[data-test-toggle="enable-thinking"] button',MANUAL_BUDGET_TOGGLE:'mat-slide-toggle[data-test-toggle="manual-budget"] button',BUDGET_INPUT:'div[data-test-id="user-setting-budget-animation-wrapper"] input',TOOLS_TOGGLE_SELECTOR:"div.settings-item",WEB_SEARCH_TOGGLE:'div[data-test-id="searchAsAToolTooltip"] button',URL_CONTEXT_TOGGLE:'div[data-test-id="browseAsAToolTooltip"] button'},R={SCREEN_WIDTH_BREAKPOINT_PX:960,LOG_PREVIEW_LENGTH:50};class ct{constructor(t){this.chatbot=t}async setModel(t){return console.log(`[AI Studio Settings] Setting model to: "${t}"`),this.chatbot.retryOperation(async()=>{const n=await I([T.MODEL_SELECTOR_CARD],"Model selector card",S(y),2),e=b(n,HTMLButtonElement,"Model selector card"),o=e.querySelector("span.title");if(o&&o.textContent?.trim()===t){console.log(`[AI Studio LOG] Model "${t}" is already selected. Skipping.`);return}e.click(),await h([T.MODEL_DIALOG_CONTAINER],S(3e3));let r=null;try{r=await I([T.MODEL_CATEGORIES_ALL_BUTTON],"Model categories all button",S(y),2)}catch(l){if((l instanceof Error?l.message:String(l)).includes("occluded")){console.log("[AI Studio LOG] Element found but occluded. Waiting longer and attempting click anyway..."),await new Promise(u=>setTimeout(u,w.PANEL_ANIMATION_MS));const g=document.querySelector(T.MODEL_CATEGORIES_ALL_BUTTON);if(g&&g.offsetParent!==null)r=g,console.log("[AI Studio LOG] Found element despite occlusion, will attempt click.");else throw l}else throw l}const i=b(r,HTMLButtonElement,"Model categories all button");i.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise(l=>setTimeout(l,w.UI_STABILIZE_DELAY_MS)),i.click(),await new Promise(l=>setTimeout(l,w.UI_STABILIZE_DELAY_MS));const a=Array.from(document.querySelectorAll(T.MODEL_CAROUSEL_BUTTON)),c=a.find(l=>{const E=l.textContent?.trim()||"";return(l.querySelector(T.MODEL_TITLE_TEXT)?.textContent?.trim()||"")===t||E.startsWith(t)});if(c){if(c.offsetParent===null)throw this.chatbot.createErrorWithContext("setModel",`Model button for "${t}" is not visible`);c.click(),console.log(`[AI Studio LOG] Success: Clicked model button for "${t}".`),await new Promise(l=>setTimeout(l,w.PANEL_ANIMATION_MS))}else{const l=a.map(E=>E.querySelector(T.MODEL_TITLE_TEXT)?.textContent?.trim()||E.textContent?.trim()||"unknown").join(", ");throw this.chatbot.createErrorWithContext("setModel",`Model button for "${t}" not found.`,`AvailableModels=[${l}]`)}if(document.querySelector("mat-dialog-container"))try{const l=await I([T.DIALOG_CLOSE_BUTTON],"Dialog close button",S(2e3),0);b(l,HTMLButtonElement,"Dialog close button").click(),await new Promise(g=>setTimeout(g,w.PANEL_ANIMATION_MS))}catch{console.log("[AI Studio LOG] Model dialog seems to have closed automatically.")}},"setModel",2,300)}async setTemperature(t){console.log(`[AI Studio LOG] Setting Temperature to: ${t}`);try{const n=await P("h3","Temperature");if(!n)throw new Error("Could not find 'Temperature' label in settings panel.");const e=n.closest(".settings-item-column");if(!e)throw new Error("Could not find parent container for 'Temperature' label.");const o=e.querySelector("input[type=number]");if(!o)throw new Error("Found 'Temperature' label but could not find its input field.");if(o.offsetParent===null||o.disabled)throw new Error(`Input field for 'Temperature' is not actionable (visible: ${o.offsetParent!==null}, disabled: ${o.disabled})`);o.value=t.toString(),o.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set Temperature to ${t} successfully.`)}catch(n){throw new Error(`Failed to set Temperature: ${n instanceof Error?n.message:String(n)}. LabelName=Temperature, Value=${t}`)}}async setTopP(t){console.log(`[AI Studio LOG] Setting Top-P to: ${t}`);const e=(await P("p","Advanced settings")).closest(T.ADVANCED_SETTINGS_TOGGLE);e&&!e.classList.contains("expanded")&&(e.click(),await new Promise(o=>setTimeout(o,w.PANEL_ANIMATION_MS)));try{const o=await P("h3","Top P");if(!o)throw new Error("Could not find 'Top P' label in settings panel.");const r=o.closest(".settings-item-column");if(!r)throw new Error("Could not find parent container for 'Top P' label.");const i=r.querySelector("input[type=number]");if(!i)throw new Error("Found 'Top P' label but could not find its input field.");if(i.offsetParent===null||i.disabled)throw new Error(`Input field for 'Top P' is not actionable (visible: ${i.offsetParent!==null}, disabled: ${i.disabled})`);i.value=t.toString(),i.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set Top P to ${t} successfully.`)}catch(o){throw new Error(`Failed to set Top P: ${o instanceof Error?o.message:String(o)}. LabelName=Top P, Value=${t}`)}}async setThinkingBudget(t){console.log(`[AI Studio LOG] Configuring thinking budget. Provided value: ${t}`);const n=await h([T.THINKING_TOGGLE]),e=b(n,HTMLButtonElement,"Thinking toggle"),o=e.getAttribute("aria-checked")==="true";t!=null&&!o&&(e.click(),console.log('[AI Studio LOG] Enabled "thinking" feature.'),await new Promise(c=>setTimeout(c,w.PANEL_ANIMATION_MS)));const r=await h([T.MANUAL_BUDGET_TOGGLE]),i=b(r,HTMLButtonElement,"Manual budget toggle"),a=i.getAttribute("aria-checked")==="true";if(t!=null){a||(i.click(),console.log('[AI Studio LOG] Enabled "manual budget".'),await new Promise(E=>setTimeout(E,w.PANEL_ANIMATION_MS)));const c=await h([T.BUDGET_INPUT]),l=b(c,HTMLInputElement,"Budget input");l.value=t.toString(),l.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`[AI Studio LOG] Success: Set budget input to ${t}.`)}else a&&(i.click(),console.log('[AI Studio LOG] Success: Disabled "manual budget" as no value was provided.'))}async setAdvancedOptions(t,n){if(console.log("[AI Studio LOG] Setting advanced options:",t),t.disableThinking!==void 0)if(n?.toLowerCase()==="gemini-2.5-pro")console.log('[AI Studio LOG] Skipping "disableThinking" toggle as it is not applicable for gemini-2.5-pro.');else{const o=await h([T.THINKING_TOGGLE]),r=b(o,HTMLButtonElement,"Thinking toggle"),i=r.getAttribute("aria-checked")==="true",a=!t.disableThinking;a!==i&&(r.click(),console.log(`[AI Studio LOG] Toggled thinking to: ${a?"enabled":"disabled"}`))}if(t.useWebSearch!==void 0||t.urlContext!==void 0){const o=(await P("p","Tools")).closest(T.TOOLS_TOGGLE_SELECTOR);if(o&&!o.classList.contains("expanded")&&(o.click(),await new Promise(r=>setTimeout(r,w.PANEL_ANIMATION_MS))),t.useWebSearch!==void 0){const r=await h([T.WEB_SEARCH_TOGGLE]),i=b(r,HTMLButtonElement,"Web search toggle");t.useWebSearch!==(i.getAttribute("aria-checked")==="true")&&(i.click(),console.log(`[AI Studio LOG] Toggled web search to: ${t.useWebSearch}`))}if(t.urlContext!==void 0){const r=await h([T.URL_CONTEXT_TOGGLE]),i=b(r,HTMLButtonElement,"URL context toggle");t.urlContext!==(i.getAttribute("aria-checked")==="true")&&(i.click(),console.log(`[AI Studio LOG] Toggled URL context to: ${t.urlContext}`))}}}}class H{constructor(){this.settingsManager=new ct(this)}getPageStateContext(){const t=document.querySelectorAll("*").length;return`URL=${window.location.href}, ReadyState=${document.readyState}, VisibleElements=${t}`}createErrorWithContext(t,n,e){const o=this.getPageStateContext(),r=e?`${o}, ${e}`:o;return new Error(`${t} failed: ${n}
Context: ${r}`)}async retryOperation(t,n,e=2,o=300){let r=null;for(let i=0;i<=e;i++)try{return await t()}catch(a){if(r=a instanceof Error?a:new Error(String(a)),i>=e)throw this.createErrorWithContext(n,r.message,`Retries=${e}, Attempt=${i+1}`);const c=o*Math.pow(2,i);console.log(`[AI Studio LOG] ${n} failed, retrying ${i+1}/${e} after ${c}ms. Error: ${r.message.split(`
`)[0]}`),await new Promise(l=>setTimeout(l,c))}throw r||new Error(`${n} failed after ${e} retries`)}async resetState(){console.log("[AI Studio] Preparing to reset UI state...");try{const t=Array.isArray(T.SETTINGS_PANEL_MOBILE_TOGGLE)?T.SETTINGS_PANEL_MOBILE_TOGGLE[0]:T.SETTINGS_PANEL_MOBILE_TOGGLE,n=t?document.querySelector(t):null,e=document.querySelector(T.NEW_CHAT_BUTTON);if(!e||e.offsetParent===null){console.warn('[AI Studio] "New Chat" button not found, assuming clean state and proceeding.'),await this.waitForReady();return}if(e.click(),console.log('[AI Studio] "New Chat" clicked. Waiting for UI transition...'),n){const o=S(5e3),r=Date.now();for(;document.body.contains(n);){if(Date.now()-r>o)throw this.createErrorWithContext("resetState","Old settings button did not disappear within timeout.",`Timeout=${o}ms`);await new Promise(i=>setTimeout(i,50))}console.log("[AI Studio] Old UI elements have been removed.")}await this.waitForReady(),console.log("[AI Studio] State reset completed successfully.")}catch(t){console.error("[AI Studio] A non-critical error occurred during state reset. Continuing under assumption that UI is ready.",t),await this.waitForReady()}}async waitForReady(){await I(T.PROMPT_INPUTS,"Prompt Input Area"),console.log("[AI Studio] UI is fully actionable and ready (prompt input is available).")}async setSystemPrompt(t){if(t){console.log("[AI Studio LOG] Setting system prompt."),await this.openSettingsPanel();try{const n=await h([T.SYSTEM_PROMPT_CARD]);b(n,HTMLButtonElement,"System prompt card").click(),await new Promise(c=>setTimeout(c,w.PANEL_ANIMATION_MS));const o=await h([T.SYSTEM_PROMPT_TEXTAREA]),r=b(o,HTMLTextAreaElement,"System prompt textarea");r.value=t,r.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[AI Studio LOG] Success: System prompt entered.");const i=await h([T.DIALOG_CLOSE_BUTTON]);b(i,HTMLButtonElement,"Dialog close button").click(),await new Promise(c=>setTimeout(c,w.PANEL_ANIMATION_MS))}finally{await this.closeSettingsPanel()}}}async applyAllSettings(t){if(!(t.model||t.temperature!==void 0||t.topP!==void 0||t.thinkingBudget!==void 0||t.useWebSearch!==void 0||t.disableThinking!==void 0||t.urlContext!==void 0)){console.log("[AI Studio LOG] No settings to apply. Skipping panel.");return}await this.openSettingsPanel();try{t.model&&await this.settingsManager.setModel(t.model),t.temperature!==void 0&&await this.settingsManager.setTemperature(t.temperature),t.topP!==void 0&&await this.settingsManager.setTopP(t.topP),t.thinkingBudget!==void 0&&await this.settingsManager.setThinkingBudget(t.thinkingBudget);const e={useWebSearch:t.useWebSearch,disableThinking:t.disableThinking,urlContext:t.urlContext};Object.values(e).some(o=>o!==void 0)&&await this.settingsManager.setAdvancedOptions(e,t.model)}finally{await this.closeSettingsPanel()}}async _waitForResponseFinalization(){return console.log("[AI Studio] Now waiting for AI response to finalize..."),new Promise((t,n)=>{const e=S(w.FINALIZED_TURN_TIMEOUT_MS),o=Array.isArray(T.EDIT_BUTTON)?T.EDIT_BUTTON.join(","):T.EDIT_BUTTON,r=Array.isArray(T.CHAT_TURN)?T.CHAT_TURN.join(","):T.CHAT_TURN,i=new MutationObserver(()=>{const l=document.querySelectorAll(r);if(l.length===0)return;const E=l[l.length-1],g=E.querySelector(o),u=E.querySelector(T.STOP_EDITING_BUTTON);g&&!u&&g.offsetParent!==null&&!g.disabled&&(console.log("[AI Studio] Response finalized. Ready for extraction."),i.disconnect(),clearTimeout(a),t())});i.observe(document.body,{childList:!0,subtree:!0,attributes:!0});const a=setTimeout(()=>{i.disconnect(),n(new Error(`Timed out after ${e}ms waiting for response to finalize.`))},e),c=document.querySelectorAll(r);if(c.length>0){const l=c[c.length-1],E=l.querySelector(o),g=l.querySelector(T.STOP_EDITING_BUTTON);E&&!g&&E.offsetParent!==null&&!E.disabled&&(i.disconnect(),clearTimeout(a),t())}})}async sendPrompt(t){if(console.log("[AI Studio LOG] Starting automation with prompt:",t.substring(0,R.LOG_PREVIEW_LENGTH)),this.isLoginPage())return console.log("[AI Studio LOG] Login page detected. Notifying Dart."),A({type:Y,location:"sendPrompt",payload:"User needs to sign in to Google Account"}),new Promise(()=>{});try{const n=await I(T.PROMPT_INPUTS,"Prompt input area",S(y),2);if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.log("[AI Studio LOG] Prompt entered into input area, waiting for token count update...");else{const e=n?n.constructor.name:"null";throw this.createErrorWithContext("sendPrompt","Input area is not a valid textarea or input element.",`ElementType=${e}`)}await new Promise((e,o)=>{const r=S(w.TOKEN_COUNT_UPDATE_TIMEOUT_MS),i=Date.now(),a=()=>{if(Date.now()-i>r){o(new Error(`Token count did not update within ${r}ms.`));return}const E=document.querySelector(T.TOKEN_COUNT)?.textContent?.trim();E&&!E.startsWith("0")?(console.log(`[AI Studio LOG] Token count updated: ${E}`),e()):setTimeout(a,w.TOKEN_COUNT_CHECK_INTERVAL_MS)};a()}),await new Promise(e=>setTimeout(e,w.UI_STABILIZE_AFTER_TOKEN_COUNT_MS)),console.log("[AI Studio LOG] UI stabilized after token count, proceeding to send."),await this.closeSettingsPanel(),await this.retryOperation(async()=>{const e=await I(T.SEND_BUTTONS,"Send button",S(y),2);b(e,HTMLElement,"Send button").click(),console.log("[AI Studio LOG] Send button clicked successfully.")},"sendPrompt (click send button)",2,300),await this._waitForResponseFinalization()}catch(n){throw this.createErrorWithContext("sendPrompt",`Failed to send prompt: ${n instanceof Error?n.message:String(n)}`,`PromptLength=${t.length}`)}}findTurnContainerFromEditButton(t){const n=Array.isArray(T.CHAT_TURN)?T.CHAT_TURN.join(","):T.CHAT_TURN;return t.closest(n)}async extractResponse(){console.log(`[AI Studio LOG] Starting extraction process... (timeout: ${w.FINALIZED_TURN_TIMEOUT_MS}ms)`);const t=(i=w.FINALIZED_TURN_TIMEOUT_MS)=>new Promise((a,c)=>{const l=Array.isArray(T.EDIT_BUTTON)?T.EDIT_BUTTON.join(","):T.EDIT_BUTTON;let E=null,g=null;const u=()=>{E&&E.disconnect(),g&&clearTimeout(g)},f=()=>{const d=document.querySelectorAll(l);if(d.length===0)return;const m=d[d.length-1],_=this.findTurnContainerFromEditButton(m);_&&!_.querySelector('button[aria-label="Stop editing"]')&&m.offsetParent!==null&&!m.disabled&&(console.log("[AI Studio LOG] Found finalized turn via MutationObserver check."),u(),a({turn:_,editButton:m}))};E=new MutationObserver(f),E.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-label","disabled"]}),g=window.setTimeout(()=>{u();const m=`Extraction timed out. Final state: ${document.querySelectorAll(l).length} edit buttons found. The last response may still be generating or UI has changed.`;console.error(`[AI Studio LOG] ${m}`),c(new Error(m))},i),f()}),{turn:n,editButton:e}=await t();console.log("[AI Studio LOG] Finalized turn found, clicking edit button..."),e.click(),console.log("[AI Studio LOG] Waiting for textarea to appear...");const o=await k(n,T.EDIT_TEXTAREA,w.TEXTAREA_APPEAR_TIMEOUT_MS);console.log("[AI Studio LOG] Textarea appeared, waiting for UI to stabilize..."),await new Promise(i=>setTimeout(i,w.UI_STABILIZE_DELAY_MS));const r=(o.value??o.innerText??"").trim();if(!r){const i="Textarea was found but it was empty.";throw console.error(`[AI Studio LOG] ${i}`),this.createErrorWithContext("extractResponse",i,"Textarea was found but contained no content")}console.log(`[AI Studio LOG] Extracted ${r.length} chars successfully.`);try{const i=n.querySelector(T.STOP_EDITING_BUTTON);i&&(i.click(),console.log("[AI Studio LOG] Exited edit mode successfully."))}catch(i){console.warn("[AI Studio LOG] Could not exit edit mode, but extraction was successful. This is non-critical.",i)}return r}isLoginPage(){const t=window.location.href.toLowerCase();if(t.includes("accounts.google.com")||t.includes("/signin"))return!0;const n=document.querySelector('input[type="email"]'),e=document.body?.innerText?.includes("Sign in");return n&&e?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}async openSettingsPanel(){if(window.innerWidth<=R.SCREEN_WIDTH_BREAKPOINT_PX){if(document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel is already open.");return}try{const t=await I(Array.isArray(T.SETTINGS_PANEL_MOBILE_TOGGLE)?T.SETTINGS_PANEL_MOBILE_TOGGLE:[T.SETTINGS_PANEL_MOBILE_TOGGLE],"Settings panel toggle button",S(y),2);b(t,HTMLButtonElement,"Settings panel toggle button").click(),await new Promise(o=>setTimeout(o,w.PANEL_ANIMATION_MS)),document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)||(console.warn("[AI Studio LOG] Settings panel may not have opened properly. Retrying..."),await new Promise(o=>setTimeout(o,w.PANEL_ANIMATION_MS))),console.log("[AI Studio LOG] Settings panel opened successfully.")}catch(t){throw this.createErrorWithContext("openSettingsPanel",`Failed to open settings panel: ${t instanceof Error?t.message:String(t)}`)}}}async closeSettingsPanel(){if(window.innerWidth<=R.SCREEN_WIDTH_BREAKPOINT_PX){if(!document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel appears to be already closed.");return}try{const t=await I([T.SETTINGS_PANEL_CLOSE_BUTTON],"Settings panel close button",S(2e3),0);b(t,HTMLButtonElement,"Settings panel close button").click(),await new Promise(e=>setTimeout(e,w.PANEL_ANIMATION_MS)),console.log("[AI Studio LOG] Settings panel closed successfully.")}catch(t){console.warn("[AI Studio LOG] Could not close settings panel, but continuing:",t)}}}}new H;const p={LOGIN_BUTTON:"button.login-button",PROMPT_INPUT:"div[contenteditable=true]",SEND_BUTTON_CONTAINER:".send-button-container",SEND_BUTTON:"div.send-button",GENERATING_INDICATOR:'path[d="M331.946667 379.904c-11.946667 23.466667-11.946667 54.186667-11.946667 115.626667v32.938666c0 61.44 0 92.16 11.946667 115.626667 10.538667 20.650667 27.306667 37.418667 47.957333 47.957333 23.466667 11.946667 54.186667 11.946667 115.626667 11.946667h32.938666c61.44 0 92.16 0 115.626667-11.946667 20.650667-10.538667 37.418667-27.306667 47.957333-47.957333 11.946667-23.466667 11.946667-54.186667 11.946667-115.626667v-32.938666c0-61.44 0-92.16-11.946667-115.626667a109.696 109.696 0 0 0-47.957333-47.957333c-23.466667-11.946667-54.186667-11.946667-115.626667-11.946667h-32.938666c-61.44 0-92.16 0-115.626667 11.946667-20.650667 10.538667-37.418667 27.306667-47.957333 47.957333z"]',RESPONSE_CONTAINER:".segment-content",RESPONSE_TEXT:".segment-content > div:first-child",COPY_BUTTON:".segment-assistant-actions-content div[data-v-10d40aa8]"};class ut{async waitForReady(){console.log("[Kimi] Starting robust multi-condition readiness check...");const t=S(2e4);return new Promise((n,e)=>{let r=0,i=!1,a=!1;const c=()=>{const g=document.querySelector(p.LOGIN_BUTTON),u=!g;if(g&&!i){i=!0,console.log("[Kimi] Login button detected. Waiting 1.5s for page to stabilize..."),setTimeout(()=>{a=!0,console.log("[Kimi] Login button wait complete. Resuming readiness check...")},1500);return}if(i&&!a)return;const f=document.querySelector(p.PROMPT_INPUT),d=f&&f.offsetParent!==null,m=document.querySelector(p.SEND_BUTTON_CONTAINER),_=m&&m.offsetParent!==null;if(u&&d&&_)clearInterval(l),clearTimeout(E),console.log("[Kimi] All readiness conditions met. UI is ready."),n();else if(r+=250,r>=t){clearInterval(l),clearTimeout(E);const O=[`- Logged In: ${u}`,`- Prompt Input Ready: ${d}`,`- Send Container Ready: ${_}`].join(`
`);e(new Error(`[Kimi] UI readiness check timed out after ${t}ms.
Status:
${O}`))}},l=setInterval(c,250),E=setTimeout(()=>{clearInterval(l),e(new Error(`[Kimi] Readiness check timed out externally after ${t}ms.`))},t);c()})}async _waitForResponseFinalization(){return console.log("[Kimi] Now waiting for AI response to finalize..."),new Promise((t,n)=>{const e=S(6e4),o=300,r=()=>{const c=document.querySelectorAll(p.RESPONSE_CONTAINER);if(c.length===0)return;const l=c[c.length-1];if(!l)return;const E=!!document.querySelector(p.GENERATING_INDICATOR),g=l.querySelector(p.COPY_BUTTON);!E&&g&&(console.log("[Kimi] Response finalized. Ready for extraction."),clearInterval(i),clearTimeout(a),t())},i=setInterval(r,o),a=setTimeout(()=>{clearInterval(i),n(new Error(`Timed out after ${e}ms waiting for response to finalize.`))},e);r()})}async sendPrompt(t){console.log("[Kimi] Starting sendPrompt workflow...");const n=await I([p.PROMPT_INPUT],"Prompt Input");console.log("[Kimi] Dispatching InputEvent to contenteditable div..."),n.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:t})),console.log("[Kimi] Waiting for send button to become enabled..."),await new Promise((o,r)=>{const i=S(5e3),a=100;let c=0;const E=setInterval(()=>{const g=document.querySelector(p.SEND_BUTTON_CONTAINER);g&&!g.classList.contains("disabled")?(clearInterval(E),console.log("[Kimi] Send button is now enabled."),o()):(c+=a,c>=i&&(clearInterval(E),r(new Error("Send button did not become enabled in time."))))},a)});const e=await I([p.SEND_BUTTON],"Send Button");console.log("[Kimi] Clicking send button..."),e.click(),console.log("[Kimi] Send button clicked successfully."),await this._waitForResponseFinalization()}async extractResponse(){console.log("[Kimi] Starting response extraction workflow...");const t=document.querySelectorAll(p.RESPONSE_CONTAINER);if(t.length===0)throw new Error("No response containers found.");const n=t[t.length-1];if(!n)throw new Error("Could not find last response container.");const e=d=>d.replace(/\s+Copy\s*$/i,"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim(),o=n.querySelector(p.RESPONSE_TEXT);if(o){const d=e(o.innerText);if(d.length>0)return console.log(`[Kimi] Extracted response text directly from DOM (${d.length} chars).`),d}const r=e(n.innerText??"");if(r.length>0)return console.log(`[Kimi] Extracted response from container fallback (${r.length} chars).`),r;if(!window.flutter_inappwebview)throw new Error("flutter_inappwebview bridge is not available for clipboard operations.");console.log("[Kimi] Falling back to clipboard-based extraction workflow...");const i=`ai-hybrid-hub-copy-check-${Date.now()}`;try{await window.flutter_inappwebview.callHandler("setClipboard",i),console.log("[Kimi] Primed clipboard with unique token.")}catch(d){throw console.error("[Kimi] Failed to prime clipboard via Dart handler.",d),new Error("Could not set initial clipboard state for validation.")}const a=await k(n,[p.COPY_BUTTON],S(5e3));if(!a.offsetParent)throw new Error("Copy button is not visible.");a.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise(d=>setTimeout(d,200));const c=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window}),l=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window}),E=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});a.dispatchEvent(c),await new Promise(d=>setTimeout(d,50)),a.dispatchEvent(l),await new Promise(d=>setTimeout(d,50)),a.dispatchEvent(E),console.log('[Kimi] "Copy" button clicked with full mouse event sequence. Waiting before polling...'),await new Promise(d=>setTimeout(d,300));const g=150,u=40;for(let d=0;d<u;d++){await new Promise(m=>setTimeout(m,g));try{const m=await window.flutter_inappwebview.callHandler("readClipboard");if(typeof m=="string"&&m.trim()&&m!==i)return console.log(`[Kimi] Clipboard updated. Successfully extracted ${m.length} chars (attempt ${d+1}).`),m}catch(m){console.warn(`[Kimi] Clipboard read attempt ${d+1} failed, retrying...`,m)}}let f="";try{const d=await window.flutter_inappwebview.callHandler("readClipboard");f=` Final clipboard state: ${typeof d=="string"?`"${d.substring(0,50)}..."`:"non-string"}`}catch(d){f=` Could not read final clipboard state: ${d}`}throw new Error(`Extraction failed: Clipboard content did not change from the unique token after the copy operation.${f} Tried ${u} times over ${u*g/1e3}s.`)}}const dt=new ut,Et=100,Tt=300,gt=0,mt=100;function q(){if(window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function")try{window.flutter_inappwebview.callHandler(K),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(s){console.warn("[Engine] Failed to send bridge ready signal:",s)}}document.addEventListener("flutterInAppWebViewPlatformReady",()=>{console.log("[Engine] Received flutterInAppWebViewPlatformReady event"),q()});function D(s=Et,t=Tt){if(s<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function"?q():setTimeout(()=>D(s-1,t),t)}if(window.__AI_HYBRID_HUB_INITIALIZED__&&(console.log("[Engine] Bridge script already initialized. Checking if functions exist..."),typeof window.startAutomation<"u"&&typeof window.extractFinalResponse<"u"&&typeof window.inspectDOMForSelectors<"u"?(console.log("[Engine] Functions exist, signaling ready."),D()):(console.warn("[Engine] Flag set but functions missing! Force re-initialization."),delete window.__AI_HYBRID_HUB_INITIALIZED__)),!window.__AI_HYBRID_HUB_INITIALIZED__){let s=function(o){const r=e[o];return r?(console.log(`[Engine] Matched providerId: "${o}". Using corresponding chatbot module.`),r):(console.error(`[Engine] No chatbot module found for providerId: "${o}"`),null)},t=function(o,r=document){try{const i=r.querySelector(o);if(i)return i;const a=r.querySelectorAll("*");for(const c of a)if(c.shadowRoot){const l=t(o,c.shadowRoot);if(l)return l}}catch{}return null};window.__AI_HYBRID_HUB_INITIALIZED__=!0,window.__processedFootersCount=gt;const n={currentChatbot:null},e={ai_studio:new H,kimi:dt};window.startAutomation=async function(o){console.log("[Engine LOG] >>> Full automation cycle started by Dart. Options:",JSON.stringify(o,null,2)),window.__hasAttemptedRetry=!1,window.__AI_TIMEOUT_MODIFIER__=o.timeoutModifier??1,console.log(`[Engine] Using timeout modifier: ${window.__AI_TIMEOUT_MODIFIER__}x`);const r=s(o.providerId);if(!r){A({type:N,errorCode:"UNSUPPORTED_PROVIDER",payload:`Provider "${o.providerId}" is not supported.`});return}n.currentChatbot=r;const i=Date.now();let a="Initialization";try{r.resetState&&(a="Phase 1: Resetting UI state",console.log(`[Engine LOG] ${a}...`),await r.resetState()),a="Phase 2: Waiting for UI to be ready",console.log(`[Engine LOG] ${a}...`),await r.waitForReady(),a="Phase 3: Applying configurations",console.log(`[Engine LOG] ${a}...`),o.systemPrompt&&r.setSystemPrompt&&(console.log(`[Engine LOG] Setting system prompt (length: ${o.systemPrompt.length})`),await r.setSystemPrompt(o.systemPrompt)),r.applyAllSettings&&await r.applyAllSettings(o),a="Phase 4: Sending prompt and awaiting finalization",console.log(`[Engine LOG] ${a}...`),await r.sendPrompt(o.prompt),a="Phase 5: Notifying Dart of readiness",console.log(`[Engine LOG] ${a}...`),A({type:V});const c=Date.now()-i;console.log(`[Engine LOG] Sequential automation cycle completed successfully in ${c}ms.`)}catch(c){const l=c instanceof Error?c.message:String(c),E=Date.now()-i,g={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};console.error(`[Engine LOG] Full automation cycle failed in ${a} after ${E}ms!`,c);const u={phase:a,elapsedTimeMs:E,url:g.url,readyState:g.readyState,visibleElements:g.visibleElements,timestamp:new Date().toISOString()};throw(l.includes("Selector")||l.includes("selector"))&&(u.selectorContext="Error message contains selector information"),A({type:N,errorCode:"FULL_CYCLE_FAILED",location:"startAutomation",payload:l,diagnostics:u}),c}},window.extractFinalResponse=async function(){console.log("[Engine LOG] extractFinalResponse called");const o=n.currentChatbot;if(!o){const i="No chatbot available for extraction. Automation must be started first.";throw console.error("[Engine LOG] No chatbot found for extraction"),A({type:N,errorCode:"NO_CHATBOT_INSTANCE",payload:i}),new Error(i)}const r=Date.now();console.log(`[Engine LOG] Starting extraction with chatbot: ${o.constructor.name}`);try{console.log("[Engine LOG] [ENHANCED] DOM state before extraction:",{url:window.location.href,readyState:document.readyState,title:document.title,timestamp:new Date().toISOString()});const i=await o.extractResponse(),a=Date.now()-r;return console.log(`[Engine LOG] Extraction completed successfully in ${a}ms, extracted ${i.length} chars`),console.log("[Engine LOG] [ENHANCED] Extraction result details:",{success:!0,resultLength:i.length,resultPreview:i.substring(0,100)+(i.length>100?"...":""),elapsedTime:a}),i}catch(i){const a=i instanceof Error?i.message:String(i),c=Date.now()-r;console.error("[Engine LOG] [ENHANCED] Extraction failed with details:",{success:!1,errorMessage:a,errorType:i instanceof Error?i.constructor.name:typeof i,elapsedTime:c,timestamp:new Date().toISOString(),domState:{url:window.location.href,readyState:document.readyState,title:document.title,editButtons:document.querySelectorAll('button[aria-label="Edit"]').length,textareas:document.querySelectorAll('textarea, [contenteditable="true"]').length}});const l=`Extraction failed: ${a} (Type: ${i instanceof Error?i.constructor.name:typeof i}, Time: ${c}ms)`;throw console.error(`[Engine LOG] ${l}`),A({type:N,errorCode:"EXTRACTION_FAILED",payload:l}),i}},window.inspectDOMForSelectors=function(){const o={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},r=document.querySelectorAll("*");for(const u of r)if(u.shadowRoot){o.shadowDOMDetected=!0;break}const i=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],a={};for(const u of i)try{a[u]=document.querySelector(u),a[u]||(a[`${u} (shadow)`]=t(u))}catch{a[u]=null}o.allSelectorsTested.promptInput=a;const c=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],l={};for(const u of c)try{l[u]=document.querySelector(u),l[u]||(l[`${u} (shadow)`]=t(u))}catch{l[u]=null}o.allSelectorsTested.sendButton=l;const E=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));o.inputs=E.map(u=>{const f=u;return{tag:u.tagName.toLowerCase(),type:f.getAttribute("type")||"",placeholder:f.getAttribute("placeholder")||"",ariaLabel:f.getAttribute("aria-label")||"",id:u.id||"",className:u.className||"",contentEditable:f.contentEditable,visible:f.offsetParent!==null,inShadowDOM:!1}});const g=Array.from(document.querySelectorAll("button"));return o.buttons=g.map(u=>{const f=u;return{tag:u.tagName.toLowerCase(),ariaLabel:f.getAttribute("aria-label")||"",text:(f.innerText||"").substring(0,mt),id:u.id||"",className:u.className||"",type:f.getAttribute("type")||"",visible:f.offsetParent!==null,inShadowDOM:!1}}),o},console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),D()}})();
