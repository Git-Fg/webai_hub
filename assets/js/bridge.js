(function(){"use strict";const j="automationBridge",J="bridgeReady",Q="NEW_RESPONSE_DETECTED",tt="LOGIN_REQUIRED",B="AUTOMATION_FAILED";function C(r){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler(j,r)}function f(r){const t=window.__AI_TIMEOUT_MODIFIER__??1;return r*t}const D=1e4,Z=300,$=2,et=300,nt=2e3;function ot(){return{url:window.location.href,readyState:document.readyState,visibleElementsCount:document.querySelectorAll("*").length}}function W(r,t,n,e="waitForElement"){const o=ot();return`${e} failed: None of the selectors [${r.join(", ")}] found within ${t}ms
Context: URL=${o.url}, Timeout=${t}ms, Elapsed=${n}ms
Page State: Ready=${o.readyState}, VisibleElements=${o.visibleElementsCount}`}function Y(r,t){for(let n=0;n<r.length;n++){const e=r[n];if(!e)continue;let o=null;try{t?o=t.querySelector(e):o=document.querySelector(e)}catch(i){console.warn(`[waitForElement] Invalid selector "${e}" (index ${n}):`,i);continue}if(o)return o}return null}async function V(r,t,n="waitForElement",e){return new Promise((o,i)=>{const l=Date.now();let a=0,u=null,c=null,s=null,d=!1;console.log(`[waitForElement] Starting search for selectors: [${r.join(", ")}] (timeout: ${t}ms)`);const E=()=>{u&&(u.disconnect(),u=null),c!==null&&(clearTimeout(c),c=null),s!==null&&(clearInterval(s),s=null)},g=()=>{const m=Date.now()-l;m-a>=nt&&(console.log(`[waitForElement] Still searching... (elapsed: ${m}ms, remaining: ${t-m}ms)`),a=m),d||(Y(r,e)||console.log("[waitForElement] Selectors not found on first attempt"),d=!0);const _=Y(r,e);if(_){const b=Date.now()-l,L=r.find(v=>{if(!v)return!1;try{return e?e.querySelector(v)===_:document.querySelector(v)===_}catch{return!1}});console.log(`[waitForElement] Found element with selector "${L||"unknown"}" after ${b}ms`),E(),o(_);return}if(m>=t){E();const b=W(r,t,m,n);i(new Error(b))}};if(typeof MutationObserver<"u"){u=new MutationObserver(()=>{g()});const m=e||document.body;u.observe(m,{childList:!0,subtree:!0}),g()}else console.warn("[waitForElement] MutationObserver not available, using polling fallback"),s=window.setInterval(g,Z),g();c=window.setTimeout(()=>{E();const m=Date.now()-l,_=W(r,t,m,n);i(new Error(_))},t)})}function I(r,t=D,n=$){const e=f(t);return x(()=>V(r,e,"waitForElement"),n,"waitForElement")}function K(r,t,n=D,e=$){const o=f(n);return x(()=>V(t,o,"waitForElementWithin",r),e,"waitForElementWithin")}function M(r,t,n=D,e=$){const o=f(n);return x(()=>it(r,t,o),e,"waitForElementByText")}async function it(r,t,n){return new Promise((e,o)=>{const i=Date.now();let l=null,a=null,u=null;const c=()=>{l&&(l.disconnect(),l=null),a!==null&&(clearTimeout(a),a=null),u!==null&&(clearInterval(u),u=null)},s=()=>{const d=document.querySelectorAll(r);for(const g of d)if(g.textContent?.includes(t)){const m=Date.now()-i;console.log(`[waitForElementByText] Found element with text "${t}" after ${m}ms`),c(),e(g);return}Date.now()-i>=n&&(c(),o(new Error(`Element with selector "${r}" containing text "${t}" not found within ${n}ms`)))};typeof MutationObserver<"u"?(l=new MutationObserver(()=>{s()}),l.observe(document.body,{childList:!0,subtree:!0}),s()):(console.warn("[waitForElementByText] MutationObserver not available, using polling fallback"),u=window.setInterval(s,Z),s()),a=window.setTimeout(()=>{c();const d=Date.now()-i;o(new Error(`Element with selector "${r}" containing text "${t}" not found within ${n}ms (elapsed: ${d}ms)`))},n)})}async function x(r,t,n){let e=null;for(let o=0;o<=t;o++)try{return await r()}catch(i){if(e=i instanceof Error?i:new Error(String(i)),!(e.message.includes("not found")||e.message.includes("timeout")||e.message.includes("None of the selectors"))||o>=t)throw e;const a=et*Math.pow(2,o);console.log(`[waitForElement] Retry ${o+1}/${t} after ${a}ms delay. Error: ${e.message.split(`
`)[0]}`),await new Promise(u=>setTimeout(u,a))}throw e||new Error(`Operation ${n} failed after ${t} retries`)}async function k(r,t,n=2,e=300,o=()=>!0){let i=null;for(let l=0;l<=n;l++)try{return await r()}catch(a){if(i=a instanceof Error?a:new Error(String(a)),!o(i)||l>=n){const c=`Retries=${n}, Attempt=${l+1}`,s=`${t} failed: ${i.message}
Context: ${c}`;throw new Error(s)}const u=e*Math.pow(2,l);console.log(`[Retry] ${t} failed, retrying ${l+1}/${n} after ${u}ms. Error: ${i.message.split(`
`)[0]}`),await new Promise(c=>setTimeout(c,u))}throw i||new Error(`${t} failed after ${n} retries.`)}const at=1e4,rt=2,G=1e3,lt=2e3;class st extends Error{constructor(t,n){super(t),this.name="ActionabilityError",this.diagnostics=n}}function ct(r){return r.isConnected===!0}function ut(r){if(typeof r.checkVisibility=="function")try{return r.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}catch{}return r.offsetParent!==null}async function dt(r,t=G){try{const n=r.getAnimations();if(n.length===0)return!0;const e=n.map(i=>i.finished);return await Promise.race([Promise.all(e),new Promise(i=>setTimeout(i,t))]),r.getAnimations().length===0}catch{return!0}}async function O(r,t=G){try{const n=r.getAnimations({subtree:!0});if(n.length===0)return;const e=n.map(o=>o.finished);await Promise.race([Promise.all(e),new Promise(o=>setTimeout(o,t))])}catch{return}}function Et(r){if(r.disabled===!0||r.getAttribute("aria-disabled")==="true"||r.hasAttribute("inert"))return!1;let n=r.parentElement;for(;n;){if(n.hasAttribute("inert"))return!1;n=n.parentElement}return!0}function Tt(r){try{const t=r.getBoundingClientRect(),n=t.left+t.width/2,e=t.top+t.height/2,o=document.elementFromPoint(n,e);return o?r.contains(o)||o===r:!1}catch{return!0}}async function z(r,t=G){const n=r,e={attached:!1,visible:!1,stable:!1,enabled:!1,unoccluded:!1,details:{}};if(e.attached=ct(r),e.details.isConnected=r.isConnected,!e.attached)return{actionable:!1,diagnostics:e};e.visible=ut(n);try{typeof n.checkVisibility=="function"&&(e.details.checkVisibilityResult=n.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0}))}catch{}if(e.details.offsetParent=n.offsetParent,!e.visible)return{actionable:!1,diagnostics:e};e.stable=await dt(n,t);try{const i=n.getAnimations();e.details.animationsCount=i.length}catch{}if(!e.stable)return{actionable:!1,diagnostics:e};if(e.enabled=Et(n),e.details.disabled=n.disabled,e.details.ariaDisabled=n.getAttribute("aria-disabled"),e.details.inert=n.hasAttribute("inert"),!e.enabled)return{actionable:!1,diagnostics:e};if(e.unoccluded=Tt(n),!e.unoccluded)try{const i=n.getBoundingClientRect(),l=i.left+i.width/2,a=i.top+i.height/2;e.details.occludingElement=document.elementFromPoint(l,a)}catch{}return{actionable:e.attached&&e.visible&&e.stable&&e.enabled&&e.unoccluded,diagnostics:e}}function gt(r,t,n,e="element"){const o=[];n.attached||o.push("not attached to DOM"),n.visible||o.push("not visible"),n.stable||o.push("has ongoing animations"),n.enabled||o.push("disabled or inert"),n.unoccluded||o.push("occluded by another element");const i={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};return`${e} is not actionable: ${o.join(", ")}
Selectors: [${r.join(", ")}]
Timeout: ${t}ms
Diagnostics: ${JSON.stringify(n.details,null,2)}
Page State: URL=${i.url}, ReadyState=${i.readyState}, VisibleElements=${i.visibleElements}`}async function ft(r,t,n,e){const o=Date.now();let i=0;return console.log(`[waitForActionableElement] Starting search for actionable ${t} with selectors: [${r.join(", ")}] (timeout: ${n}ms)`),new Promise((l,a)=>{let u=null,c=null,s=null;const d=()=>{u&&(u.disconnect(),u=null),c!==null&&(clearTimeout(c),c=null),s!==null&&(clearInterval(s),s=null)},E=async()=>{const g=Date.now()-o;g-i>=lt&&(console.log(`[waitForActionableElement] Still checking actionability for ${t}... (elapsed: ${g}ms)`),i=g);for(const m of r){if(!m)continue;let _=null;try{e||(_=document.querySelector(m))}catch(b){console.warn(`[waitForActionableElement] Invalid selector "${m}":`,b);continue}if(_){const{actionable:b,diagnostics:L}=await z(_);if(b){const v=Date.now()-o;console.log(`[waitForActionableElement] Found actionable ${t} with selector "${m}" after ${v}ms`),d(),l(_);return}else console.log(`[waitForActionableElement] Element found but not actionable: ${JSON.stringify(L.details)}`)}}if(g>=n){d();let m=null;for(const _ of r)try{if(e||(m=document.querySelector(_)),m)break}catch{}if(m){const{diagnostics:_}=await z(m),b=gt(r,n,_,t);a(new st(b,_))}else a(new Error(`waitForActionableElement failed: None of the selectors [${r.join(", ")}] found within ${n}ms`))}};if(typeof MutationObserver<"u"){u=new MutationObserver(()=>{E()});const g=document.body;u.observe(g,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","inert","style","class"]}),E()}else console.warn("[waitForActionableElement] MutationObserver not available, using polling fallback"),s=window.setInterval(E,100),E();c=window.setTimeout(()=>{d(),E()},n)})}function w(r,t="element",n=at,e=rt){const o=f(n),i=l=>{const a=l.message.toLowerCase();return a.includes("not found")||a.includes("timeout")||a.includes("none of the selectors")||a.includes("not actionable")};return k(()=>ft(r,t,o),`waitForActionableElement(${t})`,e,300,i)}function h(r,t,n="DOM assertion"){if(!r)throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but the element is null.`);if(!(r instanceof t))throw new Error(`[${n}] Assertion failed: Expected ${t.name}, but got ${r.constructor.name}.`);return r}const y=1e4,S={READINESS_CHECK_INTERVAL_MS:100,TOKEN_COUNT_UPDATE_TIMEOUT_MS:1e4,TOKEN_COUNT_CHECK_INTERVAL_MS:100,UI_STABILIZE_AFTER_TOKEN_COUNT_MS:30,FINALIZED_TURN_TIMEOUT_MS:3e4,FINALIZED_TURN_CHECK_INTERVAL_MS:1e3,EDIT_BUTTON_WAIT_TIMEOUT_MS:2e3,TEXTAREA_APPEAR_TIMEOUT_MS:5e3,UI_STABILIZE_DELAY_MS:150,PANEL_ANIMATION_MS:250,POLL_INTERVAL_MS:100,POLL_TIMEOUT_MS:5e3,UI_STATE_DEBOUNCE_DELAY_MS:250},T={AUTOSAVE_DIALOG_BUTTON:'ms-autosave-enabled-by-default-dialog button[jslog*="273915"]',COOKIE_CONSENT_BUTTON:".glue-cookie-notification-bar__accept",NEW_CHAT_BUTTON:'a[href="/prompts/new_chat"]',RUN_SETTINGS_TOGGLE_MOBILE:"button.runsettings-toggle-button",MODEL_SELECTOR_DESKTOP:"button.model-selector-card",PROMPT_INPUTS:["ms-chunk-input textarea","textarea[placeholder*='Start typing a prompt']","textarea[aria-label*='Start typing a prompt']"],SEND_BUTTONS:['ms-run-button > button[aria-label="Run"]','ms-run-button > button[type="submit"]','button[aria-label="Run"]',"ms-run-button > button"],TOKEN_COUNT:"span.v3-token-count-value",EDIT_BUTTON:['button[aria-label="Edit"]','button[aria-label*="edit" i]','button:has([aria-label*="edit" i])'],EDIT_TEXTAREA:["textarea",'div[contenteditable="true"]','[contenteditable="true"]'],STOP_EDITING_BUTTON:'button[aria-label="Stop editing"]',CHAT_TURN:['[id^="turn-"]',"ms-chat-turn"],SETTINGS_PANEL_MOBILE_TOGGLE:['button[aria-label="Toggle run settings panel"]',"button.runsettings-toggle-button"],SETTINGS_PANEL_CLOSE_BUTTON:'ms-run-settings button[iconname="close"], button[aria-label="Close run settings panel"]',TOOLS_SECTION_TOGGLE:'button[aria-label="Expand or collapse tools"], button[aria-label="Grounding with Google Search"] + button[aria-label="Expand or collapse tools"]',ADVANCED_SECTION_TOGGLE:'button[aria-label="Expand or collapse advanced settings"]',MODEL_SELECTOR_CARD:"button.model-selector-card",MODEL_CATEGORIES_ALL_BUTTON:"button[data-test-category-button]",MODEL_CAROUSEL_BUTTON:"ms-model-carousel-row button.content-button",MODEL_TITLE_TEXT:"span.model-title-text",SYSTEM_PROMPT_CARD:"button[data-test-system-instructions-card]",SYSTEM_PROMPT_TEXTAREA:"ms-system-instructions textarea",DIALOG_CLOSE_BUTTON:"button[data-test-close-button]",MODEL_DIALOG_CONTAINER:"mat-dialog-container",ADVANCED_SETTINGS_TOGGLE:"div.settings-item",THINKING_TOGGLE:'button[aria-label="Toggle thinking mode"], button#mat-mdc-slide-toggle-0-button',MANUAL_BUDGET_TOGGLE:'button[aria-label="Toggle thinking budget between auto and manual"], button#mat-mdc-slide-toggle-1-button',BUDGET_INPUT:'div[data-test-id="user-setting-budget-animation-wrapper"] input',TOOLS_TOGGLE_SELECTOR:'div[data-test-id="tools-group"], div.settings-item',WEB_SEARCH_TOGGLE:'div[data-test-id="searchAsAToolTooltip"] button[role="switch"], button#mat-mdc-slide-toggle-5-button',URL_CONTEXT_TOGGLE:'div[data-test-id="browseAsAToolTooltip"] button[role="switch"], button#mat-mdc-slide-toggle-6-button'},F={SCREEN_WIDTH_BREAKPOINT_PX:960,LOG_PREVIEW_LENGTH:50},A=r=>new Promise(t=>{setTimeout(t,r)});class mt{async setModel(t){return console.log(`[AI Studio Settings] Setting model to: "${t}"`),k(async()=>{const n=await w([T.MODEL_SELECTOR_CARD],"Model selector card",f(y),2),e=h(n,HTMLButtonElement,"Model selector card"),o=e.querySelector("span.title");if(o&&o.textContent?.trim()===t){console.log(`[AI Studio LOG] Model "${t}" is already selected. Skipping.`);return}e.click();const i=await I([T.MODEL_DIALOG_CONTAINER],f(3e3));await O(i,f(S.PANEL_ANIMATION_MS));const l=await w([T.MODEL_CATEGORIES_ALL_BUTTON],"Model categories all button",f(y),2),a=h(l,HTMLButtonElement,"Model categories all button");a.scrollIntoView({behavior:"smooth",block:"center"}),await O(a,f(S.UI_STABILIZE_DELAY_MS)),a.click(),await O(a,f(S.UI_STABILIZE_DELAY_MS));const u=Array.from(document.querySelectorAll(T.MODEL_CAROUSEL_BUTTON)),c=u.find(s=>{const d=s.textContent?.trim()||"";return(s.querySelector(T.MODEL_TITLE_TEXT)?.textContent?.trim()||"")===t||d.startsWith(t)});if(c){if(c.offsetParent===null)throw this.createErrorWithContext("setModel",`Model button for "${t}" is not visible`);c.click(),console.log(`[AI Studio LOG] Success: Clicked model button for "${t}".`),await O(c,f(S.PANEL_ANIMATION_MS))}else{const s=u.map(d=>d.querySelector(T.MODEL_TITLE_TEXT)?.textContent?.trim()||d.textContent?.trim()||"unknown").join(", ");throw this.createErrorWithContext("setModel",`Model button for "${t}" not found.`,`AvailableModels=[${s}]`)}if(document.querySelector("mat-dialog-container"))try{const s=await w([T.DIALOG_CLOSE_BUTTON],"Dialog close button",f(2e3),0),d=h(s,HTMLButtonElement,"Dialog close button");d.click(),await O(d,f(S.PANEL_ANIMATION_MS))}catch{console.log("[AI Studio LOG] Model dialog seems to have closed automatically.")}},"setModel",2,300)}async setTemperature(t){console.log(`[AI Studio LOG] Setting Temperature to: ${t}`);try{await A(S.UI_STABILIZE_DELAY_MS);const n=await M("h3","Temperature",f(y));if(!n)throw new Error("Could not find 'Temperature' label in settings panel.");const e=n.closest(".settings-item-column");if(!e)throw new Error("Could not find parent container for 'Temperature' label.");const o=e.querySelector("input[type=number]");if(!o)throw new Error("Found 'Temperature' label but could not find its input field.");if(o.offsetParent===null||o.disabled)throw new Error(`Input field for 'Temperature' is not actionable (visible: ${o.offsetParent!==null}, disabled: ${o.disabled})`);o.value=t.toString(),o.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set Temperature to ${t} successfully.`)}catch(n){throw new Error(`Failed to set Temperature: ${n instanceof Error?n.message:String(n)}. LabelName=Temperature, Value=${t}`)}}async setTopP(t){console.log(`[AI Studio LOG] Setting Top-P to: ${t}`);const e=(await M("p","Advanced settings",f(y))).closest(T.ADVANCED_SETTINGS_TOGGLE);e&&!e.classList.contains("expanded")&&(e.click(),await O(e,f(S.PANEL_ANIMATION_MS)));try{const o=await M("h3","Top P",f(y));if(!o)throw new Error("Could not find 'Top P' label in settings panel.");const i=o.closest(".settings-item-column");if(!i)throw new Error("Could not find parent container for 'Top P' label.");const l=i.querySelector("input[type=number]");if(!l)throw new Error("Found 'Top P' label but could not find its input field.");if(l.offsetParent===null||l.disabled)throw new Error(`Input field for 'Top P' is not actionable (visible: ${l.offsetParent!==null}, disabled: ${l.disabled})`);l.value=t.toString(),l.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[AI Studio LOG] Set Top P to ${t} successfully.`)}catch(o){throw new Error(`Failed to set Top P: ${o instanceof Error?o.message:String(o)}. LabelName=Top P, Value=${t}`)}}async setThinkingBudget(t){console.log(`[AI Studio LOG] Configuring thinking budget. Provided value: ${t}`);try{const u=await I([T.ADVANCED_SECTION_TOGGLE],f(y)),c=h(u,HTMLButtonElement,"Advanced settings toggle");c.getAttribute("aria-expanded")==="true"||c.classList.contains("expanded")||(c.click(),await O(c,f(S.PANEL_ANIMATION_MS)))}catch(u){console.warn("[AI Studio LOG] Unable to expand advanced settings before configuring thinking budget:",u)}const n=await I([T.THINKING_TOGGLE]),e=h(n,HTMLButtonElement,"Thinking toggle"),o=e.getAttribute("aria-checked")==="true";t!=null&&!o&&(e.click(),console.log('[AI Studio LOG] Enabled "thinking" feature.'),await O(e,f(S.PANEL_ANIMATION_MS)));const i=await I([T.MANUAL_BUDGET_TOGGLE]),l=h(i,HTMLButtonElement,"Manual budget toggle"),a=l.getAttribute("aria-checked")==="true";if(t!=null){a||(l.click(),console.log('[AI Studio LOG] Enabled "manual budget".'),await O(l,f(S.PANEL_ANIMATION_MS)));const u=await I([T.BUDGET_INPUT]),c=h(u,HTMLInputElement,"Budget input");c.value=t.toString(),c.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`[AI Studio LOG] Success: Set budget input to ${t}.`)}else a&&(l.click(),console.log('[AI Studio LOG] Success: Disabled "manual budget" as no value was provided.'))}async setAdvancedOptions(t,n){if(console.log("[AI Studio LOG] Setting advanced options:",t),t.disableThinking!==void 0)if(n?.toLowerCase()==="gemini-2.5-pro")console.log('[AI Studio LOG] Skipping "disableThinking" toggle as it is not applicable for gemini-2.5-pro.');else{try{const u=await I([T.ADVANCED_SECTION_TOGGLE],f(y)),c=h(u,HTMLButtonElement,"Advanced settings toggle");c.getAttribute("aria-expanded")==="true"||c.classList.contains("expanded")||(c.click(),await O(c,f(S.PANEL_ANIMATION_MS)))}catch(u){console.warn("[AI Studio LOG] Unable to expand advanced settings before toggling thinking:",u)}const o=await I([T.THINKING_TOGGLE]),i=h(o,HTMLButtonElement,"Thinking toggle"),l=i.getAttribute("aria-checked")==="true",a=!t.disableThinking;a!==l&&(i.click(),console.log(`[AI Studio LOG] Toggled thinking to: ${a?"enabled":"disabled"}`))}if(t.useWebSearch!==void 0||t.urlContext!==void 0){try{const e=await I([T.TOOLS_SECTION_TOGGLE],f(y)),o=h(e,HTMLButtonElement,"Tools section toggle");o.getAttribute("aria-expanded")==="true"||o.classList.contains("expanded")||(o.click(),await O(o,f(S.PANEL_ANIMATION_MS)))}catch(e){console.warn("[AI Studio LOG] Unable to locate tools section toggle. Proceeding without explicit expansion.",e)}try{const e=document.querySelector("div.settings-items-wrapper [msscrollable], div.settings-items-wrapper");e&&(e.scrollTop=e.scrollHeight,await A(S.UI_STABILIZE_DELAY_MS))}catch(e){console.warn("[AI Studio LOG] Failed to scroll tools section into view:",e)}if(t.useWebSearch!==void 0)try{const e=await I([T.WEB_SEARCH_TOGGLE],f(y)),o=h(e,HTMLButtonElement,"Web search toggle");t.useWebSearch!==(o.getAttribute("aria-checked")==="true")&&(o.click(),console.log(`[AI Studio LOG] Toggled web search to: ${t.useWebSearch}`))}catch(e){console.warn("[AI Studio LOG] Web search toggle not available for current UI. Skipping toggle update.",e)}if(t.urlContext!==void 0)try{const e=await I([T.URL_CONTEXT_TOGGLE],f(y)),o=h(e,HTMLButtonElement,"URL context toggle");t.urlContext!==(o.getAttribute("aria-checked")==="true")&&(o.click(),console.log(`[AI Studio LOG] Toggled URL context to: ${t.urlContext}`))}catch(e){console.warn("[AI Studio LOG] URL context toggle not available for current UI. Skipping toggle update.",e)}}}async setSystemPrompt(t){if(t){console.log("[AI Studio LOG] Setting system prompt."),await this.openSettingsPanel();try{const n=await I([T.SYSTEM_PROMPT_CARD]),e=h(n,HTMLButtonElement,"System prompt card");e.click(),await O(e,f(S.PANEL_ANIMATION_MS));const o=await I([T.SYSTEM_PROMPT_TEXTAREA]),i=h(o,HTMLTextAreaElement,"System prompt textarea");i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[AI Studio LOG] Success: System prompt entered.");const l=await I([T.DIALOG_CLOSE_BUTTON]),a=h(l,HTMLButtonElement,"Dialog close button");a.click(),await O(a,f(S.PANEL_ANIMATION_MS))}finally{await this.closeSettingsPanel()}}}async applyAllSettings(t){if(t.systemPrompt&&await this.setSystemPrompt(t.systemPrompt),!(t.model||t.temperature!==void 0||t.topP!==void 0||t.thinkingBudget!==void 0||t.useWebSearch!==void 0||t.disableThinking!==void 0||t.urlContext!==void 0)){console.log("[AI Studio LOG] No other settings to apply. Skipping panel.");return}await this.openSettingsPanel(),await A(S.UI_STABILIZE_DELAY_MS*2);try{document.querySelector('.settings-item-column, input[type="number"]')||(console.warn("[AI Studio LOG] Settings panel content not yet loaded, waiting additional time..."),await A(S.UI_STABILIZE_DELAY_MS))}catch{}try{t.model&&(await this.setModel(t.model),await A(S.UI_STABILIZE_DELAY_MS*2),document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)||(console.log("[AI Studio LOG] Settings panel closed after model selection, reopening..."),await this.openSettingsPanel(),await A(S.UI_STABILIZE_DELAY_MS*2),document.querySelector('.settings-item-column, input[type="number"]')||(console.warn("[AI Studio LOG] Settings panel content not yet loaded after reopening, waiting additional time..."),await A(S.UI_STABILIZE_DELAY_MS)))),t.temperature!==void 0&&await this.setTemperature(t.temperature),t.topP!==void 0&&await this.setTopP(t.topP),t.thinkingBudget!==void 0&&await this.setThinkingBudget(t.thinkingBudget);const e={useWebSearch:t.useWebSearch,disableThinking:t.disableThinking,urlContext:t.urlContext};Object.values(e).some(o=>o!==void 0)&&await this.setAdvancedOptions(e,t.model)}finally{await this.closeSettingsPanel()}}async _dismissOverlays(){console.log("[AI Studio] Proactively dismissing known overlays...");try{document.querySelectorAll(".cdk-overlay-backdrop").forEach(n=>{const e=n;e.click(),e.style.pointerEvents="none"})}catch{}const t=async(n,e)=>{try{const o=document.querySelector(n);o&&o.offsetParent!==null&&(console.log(`[AI Studio] Found and clicking overlay: "${e}"`),o.click(),await A(500))}catch(o){console.warn(`[AI Studio] Could not dismiss overlay "${e}":`,o)}};await t(T.AUTOSAVE_DIALOG_BUTTON,"Auto-save Dialog"),await t(T.COOKIE_CONSENT_BUTTON,"Cookie Banner");try{document.querySelectorAll(".cdk-overlay-backdrop").forEach(n=>{const e=n;e.click(),e.style.pointerEvents="none"}),await A(500)}catch{}}getPageStateContext(){const t=document.querySelectorAll("*").length;return`URL=${window.location.href}, ReadyState=${document.readyState}, VisibleElements=${t}`}createErrorWithContext(t,n,e){const o=this.getPageStateContext(),i=e?`${o}, ${e}`:o;return new Error(`${t} failed: ${n}
Context: ${i}`)}async resetState(){console.log("[AI Studio] Preparing to reset UI state...");try{const t=Array.isArray(T.SETTINGS_PANEL_MOBILE_TOGGLE)?T.SETTINGS_PANEL_MOBILE_TOGGLE[0]:T.SETTINGS_PANEL_MOBILE_TOGGLE,n=t?document.querySelector(t):null,e=document.querySelector(T.NEW_CHAT_BUTTON);if(!e||e.offsetParent===null){console.warn('[AI Studio] "New Chat" button not found, assuming clean state and proceeding.'),await this.waitForReady();return}if(e.click(),console.log('[AI Studio] "New Chat" clicked. Waiting for UI transition...'),n){const o=f(5e3),i=Date.now();for(;document.body.contains(n);){if(Date.now()-i>o)throw this.createErrorWithContext("resetState","Old settings button did not disappear within timeout.",`Timeout=${o}ms`);await A(50)}console.log("[AI Studio] Old UI elements have been removed.")}await this.waitForReady(),console.log("[AI Studio] State reset completed successfully.")}catch(t){console.error("[AI Studio] A non-critical error occurred during state reset. Continuing under assumption that UI is ready.",t),await this.waitForReady()}}async waitForReady(){await this._dismissOverlays(),await w(T.PROMPT_INPUTS,"Prompt Input Area"),console.log("[AI Studio] UI is fully actionable and ready (prompt input is available)."),await A(S.UI_STABILIZE_DELAY_MS)}async _waitForResponseFinalization(){return console.log("[AI Studio] Now waiting for AI response to finalize..."),new Promise((t,n)=>{const e=f(S.FINALIZED_TURN_TIMEOUT_MS),o=Array.isArray(T.EDIT_BUTTON)?T.EDIT_BUTTON.join(","):T.EDIT_BUTTON,i=Array.isArray(T.CHAT_TURN)?T.CHAT_TURN.join(","):T.CHAT_TURN,l=new MutationObserver(()=>{const c=document.querySelectorAll(i);if(c.length===0)return;const s=c[c.length-1],d=s.querySelector(o),E=s.querySelector(T.STOP_EDITING_BUTTON);d&&!E&&d.offsetParent!==null&&!d.disabled&&(console.log("[AI Studio] Response finalized. Ready for extraction."),l.disconnect(),clearTimeout(a),t())});l.observe(document.body,{childList:!0,subtree:!0,attributes:!0});const a=setTimeout(()=>{l.disconnect();const c=document.querySelectorAll(i),s=document.querySelectorAll(o),d=`Turns found: ${c.length}, Edit buttons found: ${s.length}, URL: ${window.location.href}`;n(new Error(`Timed out after ${e}ms waiting for response to finalize. ${d}`))},e),u=document.querySelectorAll(i);if(u.length>0){const c=u[u.length-1],s=c.querySelector(o),d=c.querySelector(T.STOP_EDITING_BUTTON);s&&!d&&s.offsetParent!==null&&!s.disabled&&(l.disconnect(),clearTimeout(a),t())}})}async sendPrompt(t){if(console.log("[AI Studio LOG] Starting automation with prompt:",t.substring(0,F.LOG_PREVIEW_LENGTH)),await this._dismissOverlays(),this.isLoginPage())return console.log("[AI Studio LOG] Login page detected. Notifying Dart."),C({type:tt,location:"sendPrompt",payload:"User needs to sign in to Google Account"}),new Promise(()=>{});try{const n=await w(T.PROMPT_INPUTS,"Prompt input area",f(y),2);if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.log("[AI Studio LOG] Prompt entered into input area, waiting for token count update...");else{const e=n?n.constructor.name:"null";throw this.createErrorWithContext("sendPrompt","Input area is not a valid textarea or input element.",`ElementType=${e}`)}await new Promise((e,o)=>{const i=f(S.TOKEN_COUNT_UPDATE_TIMEOUT_MS),l=Date.now(),a=()=>{if(Date.now()-l>i){o(new Error(`Token count did not update within ${i}ms.`));return}const s=document.querySelector(T.TOKEN_COUNT)?.textContent?.trim();s&&!s.startsWith("0")?(console.log(`[AI Studio LOG] Token count updated: ${s}`),e()):setTimeout(a,S.TOKEN_COUNT_CHECK_INTERVAL_MS)};a()}),await A(S.UI_STABILIZE_AFTER_TOKEN_COUNT_MS),console.log("[AI Studio LOG] UI stabilized after token count, proceeding to send."),await this.closeSettingsPanel(),await k(async()=>{const e=await w(T.SEND_BUTTONS,"Send button",f(y),2);h(e,HTMLElement,"Send button").click(),console.log("[AI Studio LOG] Send button clicked successfully.")},"sendPrompt (click send button)",2,300),await this._waitForResponseFinalization()}catch(n){throw this.createErrorWithContext("sendPrompt",`Failed to send prompt: ${n instanceof Error?n.message:String(n)}`,`PromptLength=${t.length}`)}}findTurnContainerFromEditButton(t){const n=Array.isArray(T.CHAT_TURN)?T.CHAT_TURN.join(","):T.CHAT_TURN;return t.closest(n)}async extractResponse(){console.log(`[AI Studio LOG] Starting extraction process... (timeout: ${S.FINALIZED_TURN_TIMEOUT_MS}ms)`);const t=(l=S.FINALIZED_TURN_TIMEOUT_MS)=>new Promise((a,u)=>{const c=Array.isArray(T.EDIT_BUTTON)?T.EDIT_BUTTON.join(","):T.EDIT_BUTTON;let s=null,d=null;const E=()=>{s&&s.disconnect(),d&&clearTimeout(d)},g=()=>{const m=document.querySelectorAll(c);if(m.length===0)return;const _=m[m.length-1],b=this.findTurnContainerFromEditButton(_);b&&!b.querySelector('button[aria-label="Stop editing"]')&&_.offsetParent!==null&&!_.disabled&&(console.log("[AI Studio LOG] Found finalized turn via MutationObserver check."),E(),a({turn:b,editButton:_}))};s=new MutationObserver(g),s.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-label","disabled"]}),d=window.setTimeout(()=>{E();const _=`Extraction timed out. Final state: ${document.querySelectorAll(c).length} edit buttons found.`;console.error(`[AI Studio LOG] ${_}`),u(new Error(_))},l),g()}),{turn:n,editButton:e}=await t();console.log("[AI Studio LOG] Finalized turn found, clicking edit button..."),e.click(),console.log("[AI Studio LOG] Waiting for textarea to appear...");const o=await K(n,T.EDIT_TEXTAREA,S.TEXTAREA_APPEAR_TIMEOUT_MS);console.log("[AI Studio LOG] Textarea appeared, waiting for UI to stabilize..."),await A(S.UI_STABILIZE_DELAY_MS);let i=(o.value??o.innerText??"").trim();if(!i){const l=n?.innerText?.trim()??"";l&&(console.log(`[AI Studio LOG] Primary textarea empty, using fallback turn text (${l.length} chars).`),i=l)}if(!i){const l="Extraction failed: Textarea and fallback turn content were empty.";throw console.error(`[AI Studio LOG] ${l}`),this.createErrorWithContext("extractResponse",l,"No content available for extraction after fallback")}console.log(`[AI Studio LOG] Extracted ${i.length} chars successfully.`);try{const l=n.querySelector(T.STOP_EDITING_BUTTON);l&&(l.click(),console.log("[AI Studio LOG] Exited edit mode successfully."))}catch(l){console.warn("[AI Studio LOG] Could not exit edit mode, but extraction was successful. This is non-critical.",l)}return i}isLoginPage(){const t=window.location.href.toLowerCase();if(t.includes("accounts.google.com")||t.includes("/signin"))return!0;const n=document.querySelector('input[type="email"]'),e=document.body?.innerText?.includes("Sign in");return n&&e?(console.log("[AI Studio] Login page detected via DOM elements"),!0):!1}async openSettingsPanel(){if(await this._dismissOverlays(),window.innerWidth<=F.SCREEN_WIDTH_BREAKPOINT_PX){if(document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel is already open."),await A(S.UI_STABILIZE_DELAY_MS);return}try{const t=await w(Array.isArray(T.SETTINGS_PANEL_MOBILE_TOGGLE)?T.SETTINGS_PANEL_MOBILE_TOGGLE:[T.SETTINGS_PANEL_MOBILE_TOGGLE],"Settings panel toggle button",f(y),2);h(t,HTMLButtonElement,"Settings panel toggle button").click();const e=document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)?.closest("ms-run-settings");e?await O(e,f(S.PANEL_ANIMATION_MS)):await A(S.PANEL_ANIMATION_MS),await A(S.UI_STABILIZE_DELAY_MS),console.log("[AI Studio LOG] Settings panel opened successfully.")}catch(t){throw this.createErrorWithContext("openSettingsPanel",`Failed to open settings panel: ${t instanceof Error?t.message:String(t)}`)}}}async closeSettingsPanel(){if(window.innerWidth<=F.SCREEN_WIDTH_BREAKPOINT_PX){if(!document.querySelector(T.SETTINGS_PANEL_CLOSE_BUTTON)){console.log("[AI Studio LOG] Settings panel appears to be already closed.");return}try{const t=await w([T.SETTINGS_PANEL_CLOSE_BUTTON],"Settings panel close button",f(2e3),0),n=h(t,HTMLButtonElement,"Settings panel close button"),e=n.closest("ms-run-settings");n.click(),e?await O(e,f(S.PANEL_ANIMATION_MS)):await A(S.PANEL_ANIMATION_MS),console.log("[AI Studio LOG] Settings panel closed successfully.")}catch(t){console.warn("[AI Studio LOG] Could not close settings panel, but continuing:",t)}}}}const St=new mt,N={TUTORIAL_CLOSE_BUTTON:".edu-card-popover svg.iconify.close",NOTICE_DIALOG_BUTTON:".common-notice-dialog button.kimi-button.plain",PROMPT_INPUT:"div[contenteditable=true]",SEND_BUTTON_CONTAINER:".send-button-container",SEND_BUTTON:"div.send-button",GENERATING_INDICATOR:'path[d^="M331.946667 379.904"]',RESPONSE_CONTAINER:".segment-content",RESPONSE_TEXT:".segment-content > div:first-child",COPY_BUTTON:".segment-assistant-actions-content div[data-v-10d40aa8]"},R={POLL_INTERVAL_MS:150,COPY_POLL_MAX_ATTEMPTS:40,UI_STABILIZE_MS:300,SEND_BUTTON_TIMEOUT_MS:5e3},U=r=>new Promise(t=>{setTimeout(t,r)});class _t{async waitForReady(){console.log("[Kimi] Starting readiness check...");try{const t=await w([N.TUTORIAL_CLOSE_BUTTON],"Tutorial Close Button",3e3,0);console.log("[Kimi] Found and dismissing tutorial popover..."),t.click(),await U(500)}catch{console.log("[Kimi] Info: Tutorial popover not found.")}try{const t=Array.from(document.querySelectorAll(N.NOTICE_DIALOG_BUTTON)).find(n=>n.textContent?.trim()==="Got it");t&&(console.log("[Kimi] Found and dismissing notice dialog..."),t.click(),await U(500))}catch{console.log("[Kimi] Info: Notice dialog not found.")}await w([N.PROMPT_INPUT],"Prompt Input"),console.log("[Kimi] UI is ready.")}async _waitForResponseFinalization(){return console.log("[Kimi] Now waiting for AI response to finalize..."),new Promise((t,n)=>{const e=f(6e4),o=new MutationObserver(()=>{const l=!!document.querySelector(N.GENERATING_INDICATOR),a=document.querySelectorAll(N.RESPONSE_CONTAINER);if(a.length===0)return;const u=a[a.length-1];if(!u)return;const c=u.querySelector(N.COPY_BUTTON);!l&&c&&(console.log("[Kimi] Response finalized. Ready for extraction."),o.disconnect(),clearTimeout(i),t())});o.observe(document.body,{childList:!0,subtree:!0});const i=setTimeout(()=>{o.disconnect(),n(new Error(`Timed out after ${e}ms waiting for response to finalize.`))},e)})}async sendPrompt(t){console.log("[Kimi] Starting sendPrompt workflow...");const n=await w([N.PROMPT_INPUT],"Prompt Input");console.log("[Kimi] Dispatching InputEvent to contenteditable div..."),n.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:t})),console.log("[Kimi] Waiting for send button to become enabled..."),await new Promise((o,i)=>{const l=f(R.SEND_BUTTON_TIMEOUT_MS),a=100;let u=0;const s=setInterval(()=>{const d=document.querySelector(N.SEND_BUTTON_CONTAINER);d&&!d.classList.contains("disabled")?(clearInterval(s),console.log("[Kimi] Send button is now enabled."),o()):(u+=a,u>=l&&(clearInterval(s),i(new Error("Send button did not become enabled in time."))))},a)});const e=await w([N.SEND_BUTTON],"Send Button");console.log("[Kimi] Clicking send button..."),e.click(),console.log("[Kimi] Send button clicked successfully."),await this._waitForResponseFinalization()}async extractResponse(){console.log("[Kimi] Starting response extraction...");const t=document.querySelectorAll(N.RESPONSE_CONTAINER);if(t.length===0)throw new Error("No response containers found.");const n=t[t.length-1];if(!n)throw new Error("Could not find last response container.");const e=n.querySelector(N.RESPONSE_TEXT);if(e&&e.innerText.trim()){const l=e.innerText.trim();return console.log(`[Kimi] Extracted response text directly from DOM (${l.length} chars).`),l}if(console.log("[Kimi] Falling back to clipboard-based extraction..."),!window.flutter_inappwebview)throw new Error("flutter_inappwebview bridge is not available for clipboard operations.");const o=`ai-hybrid-hub-copy-check-${Date.now()}`;await window.flutter_inappwebview.callHandler("setClipboard",o),console.log("[Kimi] Primed clipboard with unique token."),(await w([N.COPY_BUTTON],"Copy Button",5e3,2)).click(),console.log('[Kimi] "Copy" button clicked. Polling clipboard for changes...'),await U(R.UI_STABILIZE_MS);for(let l=0;l<R.COPY_POLL_MAX_ATTEMPTS;l++){await U(R.POLL_INTERVAL_MS);const a=await window.flutter_inappwebview.callHandler("readClipboard");if(typeof a=="string"&&a.trim()&&a!==o)return console.log(`[Kimi] Clipboard updated. Successfully extracted ${a.length} chars.`),a}throw new Error("Extraction failed: Clipboard content did not change after copy operation.")}}const bt=new _t,p={PROMPT_INPUT:'textarea[placeholder="How can I help you today?"]',SEND_BUTTON:"button#send-message-button",DEEP_THINK_TOGGLE:"button[data-autothink]",MODEL_SWITCHER_BUTTON:'button[aria-label="Select a model"]',MODEL_OPTION_BY_VALUE:r=>`button[data-value="${r}"]`,TOOLS_BUTTON_GLM45:'button:has(svg path[d^="M2.6499 4.48322"])',WEB_SEARCH_BUTTON_POPOVER:"button.px-3.py-2",RESPONSE_ACTIONS_FOOTER:".chat-assistant + div",RESPONSE_ACTIONS_FOOTER_ALT:".chat-assistant ~ div",RESPONSE_ACTIONS_FOOTER_ALT2:'[class*="chat"] + div',COPY_BUTTON:"button.copy-response-button",COPY_BUTTON_ALT:'button[aria-label*="Copy" i]',COPY_BUTTON_ALT2:'button[title*="Copy" i]',COPY_BUTTON_ALT3:'button:has(svg[class*="copy" i])',COPY_BUTTON_ALT4:'button:has(svg path[d*="M8" i])'},wt={"GLM-4.6":"GLM-4-6-API-V1","GLM-4.5":"0727-360B-API"},P={POLL_INTERVAL_MS:150,COPY_POLL_MAX_ATTEMPTS:40,UI_STABILIZE_MS:300,GENERATION_TIMEOUT_MS:3e4},q=r=>new Promise(t=>{setTimeout(t,r)});class pt{async waitForReady(){await w([p.PROMPT_INPUT],"Prompt Input"),console.log("[Z.ai] UI is ready.")}async _switchModel(t){console.log(`[Z.ai] Switching model to: ${t}`);const n=await w([p.MODEL_SWITCHER_BUTTON],"Model Switcher");if(n.textContent?.includes(t)){console.log(`[Z.ai] Model is already set to ${t}.`);return}n.click();const e=wt[t];if(!e)throw new Error(`[Z.ai] No data-value mapping for model "${t}".`);const o=p.MODEL_OPTION_BY_VALUE(e);(await w([o],`Model Option ${t}`)).click(),await q(500)}async applyAllSettings(t){if(t.model&&await this._switchModel(t.model),t.disableThinking!==void 0){const n=await w([p.DEEP_THINK_TOGGLE],"Deep Think Toggle"),e=n.getAttribute("data-autothink")==="true",o=!t.disableThinking;e!==o&&(n.click(),console.log(`[Z.ai] Toggled Deep Think to: ${o}`))}if(t.useWebSearch!==void 0)if(t.model==="GLM-4.5"){(await w([p.TOOLS_BUTTON_GLM45],"Tools Button")).click();const e=await M(p.WEB_SEARCH_BUTTON_POPOVER,"Web Search"),o=e.querySelector('[role="checkbox"]');if(!o)throw new Error("[Z.ai] Web Search checkbox not found in popover.");o.getAttribute("data-state")==="checked"!==t.useWebSearch&&(e.click(),console.log(`[Z.ai] Toggled Web Search (GLM-4.5) to: ${t.useWebSearch}`)),(await w([p.PROMPT_INPUT],"Prompt Input")).click()}else{const n=await M("button","Web Search");!n.className.includes("text-gray-400")!==t.useWebSearch&&(n.click(),console.log(`[Z.ai] Toggled Web Search to: ${t.useWebSearch}`))}}async sendPrompt(t){const n=await w([p.PROMPT_INPUT],"Prompt Input");n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),(await w([p.SEND_BUTTON],"Send Button")).click(),await this._waitForResponseFinalization()}async _waitForResponseFinalization(){const t=document.querySelectorAll(p.RESPONSE_ACTIONS_FOOTER).length;return new Promise((n,e)=>{const o=f(P.GENERATION_TIMEOUT_MS);let i=null;const l=new MutationObserver(async()=>{if(document.querySelectorAll(p.RESPONSE_ACTIONS_FOOTER).length>t)try{await w([p.COPY_BUTTON],"Copy Button in new footer",2e3,0),console.log("[Z.ai] Response finalized: New footer with actionable copy button found."),i&&clearTimeout(i),l.disconnect(),n()}catch{}});l.observe(document.body,{childList:!0,subtree:!0}),i=window.setTimeout(()=>{l.disconnect(),e(new Error(`[Z.ai] Response did not finalize within ${o}ms.`))},o)})}async extractResponse(){if(!window.flutter_inappwebview)throw new Error("[Z.ai] flutter_inappwebview bridge is not available for clipboard operations.");console.log("[Z.ai] Starting clipboard-based extraction...");const t=`ai-hybrid-hub-copy-check-${Date.now()}`;await window.flutter_inappwebview.callHandler("setClipboard",t),console.log("[Z.ai] Primed clipboard with unique token.");let n=null,e="";const o=[p.RESPONSE_ACTIONS_FOOTER,p.RESPONSE_ACTIONS_FOOTER_ALT,p.RESPONSE_ACTIONS_FOOTER_ALT2];for(const s of o)try{const d=document.querySelectorAll(s);if(d.length>0){n=d,e=s,console.log(`[Z.ai] Found ${d.length} response footer(s) using selector: ${s}`);break}}catch(d){console.warn(`[Z.ai] Selector ${s} failed:`,d)}if(!n||n.length===0){console.warn("[Z.ai] No footers found with standard selectors, trying fallback...");const s=document.querySelectorAll("div"),d=document.querySelectorAll('[class*="chat" i], [class*="message" i], [class*="assistant" i]');if(console.log(`[Z.ai] Found ${d.length} potential chat elements, ${s.length} total divs`),d.length>0){const E=d[d.length-1];if(E){let g=E.nextElementSibling;for(;g&&g.tagName!=="DIV";)g=g.nextElementSibling;g&&(n=document.createDocumentFragment().querySelectorAll("*"),n=[g],e="fallback-next-sibling",console.log("[Z.ai] Using fallback: found next sibling div after last chat element"))}}}const i=n&&n.length>0?n[n.length-1]:void 0;if(!i)throw console.error("[Z.ai] Could not find any response footer to extract from. DOM state:",{url:window.location.href,title:document.title,chatElements:document.querySelectorAll('[class*="chat" i]').length,assistantElements:document.querySelectorAll('[class*="assistant" i]').length,allDivs:document.querySelectorAll("div").length,footerSelectorUsed:e||"none"}),new Error("[Z.ai] Could not find any response footer to extract from.");console.log(`[Z.ai] Using footer found with selector: ${e||"unknown"}`),console.log("[Z.ai] Looking for copy button within last footer...");const l=[p.COPY_BUTTON,p.COPY_BUTTON_ALT,p.COPY_BUTTON_ALT2,p.COPY_BUTTON_ALT3,p.COPY_BUTTON_ALT4];let a=null,u="";for(const s of l)try{const d=await K(i,[s],f(2e3));if(d){a=d,u=s,console.log(`[Z.ai] Copy button found in footer using selector: ${s}`);break}}catch{}if(!a){console.warn("[Z.ai] Copy button not found in footer, searching globally as fallback...");for(const s of l)try{if(a=await w([s],"Copy Button",2e3),a){u=s,console.log(`[Z.ai] Copy button found globally using selector: ${s}`);break}}catch{}}if(!a)throw console.error("[Z.ai] Could not find copy button with any selector. Available buttons:",{allButtons:Array.from(document.querySelectorAll("button")).map(s=>({text:s.textContent?.substring(0,50),ariaLabel:s.getAttribute("aria-label"),className:s.className,id:s.id})),footerButtons:Array.from(i.querySelectorAll("button")).map(s=>({text:s.textContent?.substring(0,50),ariaLabel:s.getAttribute("aria-label"),className:s.className}))}),new Error("[Z.ai] Could not find copy button with any selector strategy.");a.click(),console.log(`[Z.ai] "Copy" button clicked (selector: ${u}). Polling clipboard for changes...`),await q(P.UI_STABILIZE_MS);for(let s=0;s<P.COPY_POLL_MAX_ATTEMPTS;s++){await q(P.POLL_INTERVAL_MS);try{const d=await window.flutter_inappwebview.callHandler("readClipboard");if(console.log(`[Z.ai] Clipboard check attempt ${s+1}/${P.COPY_POLL_MAX_ATTEMPTS}: type=${typeof d}, isNull=${d===null}, isUndefined=${d===void 0}, length=${d?.length??0}, matchesToken=${d===t}`),d==null){console.warn(`[Z.ai] Clipboard read returned ${d===null?"null":"undefined"} on attempt ${s+1}, continuing...`);continue}if(typeof d=="string"&&d.trim()&&d!==t)return console.log(`[Z.ai] Clipboard updated. Successfully extracted ${d.length} chars.`),d.trim()}catch(d){console.error(`[Z.ai] Error reading clipboard on attempt ${s+1}:`,d)}}let c;try{c=await window.flutter_inappwebview.callHandler("readClipboard")}catch(s){console.error("[Z.ai] Error reading final clipboard state:",s),c=null}if(!c||c===t||c.trim().length===0){console.warn("[Z.ai] Clipboard extraction failed, attempting direct DOM extraction as fallback...");const s=document.querySelectorAll(".chat-assistant");if(s.length>0){const E=s[s.length-1];if(E){const g=E.querySelector('[class*="thought" i], [class*="process" i]'),m=E.querySelectorAll('button, [class*="action" i]'),_=E.cloneNode(!0);g&&g.remove(),m.forEach(L=>L.remove());const b=_.innerText?.trim()||_.textContent?.trim()||"";if(b&&b.length>0)return console.log(`[Z.ai] Direct DOM extraction successful: ${b.length} chars extracted.`),b}}const d=document.querySelectorAll('[class*="response" i], [class*="message" i]');if(d.length>0){const E=d[d.length-1];if(E&&!E.closest('.chat-user, [class*="user" i]')){const g=E.innerText?.trim()||E.textContent?.trim()||"";if(g&&g.length>0)return console.log(`[Z.ai] Direct DOM extraction from response container successful: ${g.length} chars extracted.`),g}}}else return console.log(`[Z.ai] Clipboard extraction successful: ${c.length} chars extracted.`),c.trim();throw console.error(`[Z.ai] All extraction methods failed. Clipboard: type=${typeof c}, isNull=${c===null}, isUndefined=${c===void 0}, value=${c?.substring(0,100)??"null/undefined"}`),new Error("[Z.ai] Extraction failed: Both clipboard and direct DOM extraction methods failed.")}}const ht=new pt,At={ai_studio:St,kimi:bt,z_ai:ht};async function Ot(r,t){const n=Date.now();let e="Initialization";try{r.resetState&&(e="Phase 1: Resetting UI state",console.log(`[Engine LOG] ${e}...`),await r.resetState()),e="Phase 2: Waiting for UI to be ready",console.log(`[Engine LOG] ${e}...`),await r.waitForReady(),e="Phase 3: Applying configurations",console.log(`[Engine LOG] ${e}...`),r.applyAllSettings&&await r.applyAllSettings(t),e="Phase 4: Sending prompt and awaiting finalization",console.log(`[Engine LOG] ${e}...`),await r.sendPrompt(t.prompt),e="Phase 5: Notifying Dart of readiness",console.log(`[Engine LOG] ${e}...`),C({type:Q});const o=Date.now()-n;console.log(`[Engine LOG] Sequential automation cycle completed successfully in ${o}ms.`)}catch(o){const i=o instanceof Error?o.message:String(o),l=Date.now()-n,a={url:window.location.href,readyState:document.readyState,visibleElements:document.querySelectorAll("*").length};console.error(`[Engine LOG] Full automation cycle failed in ${e} after ${l}ms!`,o);const u={phase:e,elapsedTimeMs:l,url:a.url,readyState:a.readyState,visibleElements:a.visibleElements,timestamp:new Date().toISOString()};throw o instanceof Error&&o.name==="ActionabilityError"&&(u.actionability=o.diagnostics),(i.includes("Selector")||i.includes("selector"))&&(u.selectorContext="Error message contains selector information"),C({type:B,errorCode:"FULL_CYCLE_FAILED",location:"runChatbotWorkflow",payload:i,diagnostics:u}),o}}const It=100,yt=300,Nt=0,Lt=100;function X(){if(window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function")try{window.flutter_inappwebview.callHandler(J),console.log("[Engine] Bridge ready signal sent to Flutter.")}catch(r){console.warn("[Engine] Failed to send bridge ready signal:",r)}}document.addEventListener("flutterInAppWebViewPlatformReady",()=>{console.log("[Engine] Received flutterInAppWebViewPlatformReady event"),X()});function H(r=It,t=yt){if(r<=0){console.warn("[Engine] Max retries reached for bridge ready signal.");return}window.flutter_inappwebview&&typeof window.flutter_inappwebview.callHandler=="function"?X():setTimeout(()=>H(r-1,t),t)}if(window.__AI_HYBRID_HUB_INITIALIZED__&&(console.log("[Engine] Bridge script already initialized. Checking if functions exist..."),typeof window.startAutomation<"u"&&typeof window.extractFinalResponse<"u"&&typeof window.inspectDOMForSelectors<"u"?(console.log("[Engine] Functions exist, signaling ready."),H()):(console.warn("[Engine] Flag set but functions missing! Force re-initialization."),delete window.__AI_HYBRID_HUB_INITIALIZED__)),!window.__AI_HYBRID_HUB_INITIALIZED__){let r=function(e){const o=At[e];return o?(console.log(`[Engine] Matched providerId: "${e}". Using corresponding chatbot module.`),o):(console.error(`[Engine] No chatbot module found for providerId: "${e}"`),null)},t=function(e,o=document){try{const i=o.querySelector(e);if(i)return i;const l=o.querySelectorAll("*");for(const a of l)if(a.shadowRoot){const u=t(e,a.shadowRoot);if(u)return u}}catch{}return null};window.__AI_HYBRID_HUB_INITIALIZED__=!0,window.__processedFootersCount=Nt;const n={currentChatbot:null};window.startAutomation=async function(e,o,i,l){try{const a=JSON.parse(i),u={providerId:e,prompt:o,...a,timeoutModifier:l};console.log("[Engine] >>> Full automation cycle started by Dart. Options:",JSON.stringify(u,null,2)),window.__hasAttemptedRetry=!1,window.__AI_TIMEOUT_MODIFIER__=u.timeoutModifier??1,console.log(`[Engine] Using timeout modifier: ${window.__AI_TIMEOUT_MODIFIER__}x`);const c=r(u.providerId);if(!c){C({type:B,errorCode:"UNSUPPORTED_PROVIDER",payload:`Provider "${u.providerId}" is not supported.`});return}n.currentChatbot=c,await Ot(c,u)}catch(a){throw console.error("[Engine] startAutomation error:",a),a}},window.extractFinalResponse=async function(){console.log("[Engine] extractFinalResponse called");const e=n.currentChatbot;if(!e){const i="No chatbot available for extraction. Automation must be started first.";throw console.error("[Engine] No chatbot found for extraction"),C({type:B,errorCode:"NO_CHATBOT_INSTANCE",payload:i}),new Error(i)}const o=Date.now();console.log(`[Engine] Starting extraction with chatbot: ${e.constructor.name}`);try{console.log("[Engine] [ENHANCED] DOM state before extraction:",{url:window.location.href,readyState:document.readyState,title:document.title,timestamp:new Date().toISOString()});let i;try{i=await e.extractResponse()}catch(a){const u=a instanceof Error?a.message:String(a);throw console.error("[Engine] [ENHANCED] chatbot.extractResponse() threw error:",{error:u,errorType:a instanceof Error?a.constructor.name:typeof a,stack:a instanceof Error?a.stack:void 0}),a}if(i==null){const a=`Extraction returned ${i===void 0?"undefined":"null"}`;throw console.error("[Engine] [ENHANCED]",a),new Error(a)}if(typeof i!="string"){const a=`Extraction returned invalid type: ${typeof i}, value: ${String(i)}`;throw console.error("[Engine] [ENHANCED]",a),new Error(a)}if(!i||i.trim().length===0){const a="Extraction returned empty string";throw console.error("[Engine] [ENHANCED]",a),new Error(a)}const l=Date.now()-o;return console.log(`[Engine] Extraction completed successfully in ${l}ms, extracted ${i.length} chars`),console.log("[Engine] [ENHANCED] Extraction result details:",{success:!0,resultLength:i.length,resultPreview:i.substring(0,100)+(i.length>100?"...":""),elapsedTime:l}),String(i)}catch(i){const l=i instanceof Error?i.message:String(i),a=Date.now()-o;console.error("[Engine] [ENHANCED] Extraction failed with details:",{success:!1,errorMessage:l,errorType:i instanceof Error?i.constructor.name:typeof i,elapsedTime:a,timestamp:new Date().toISOString(),stack:i instanceof Error?i.stack:void 0,domState:{url:window.location.href,readyState:document.readyState,title:document.title,editButtons:document.querySelectorAll('button[aria-label="Edit"]').length,textareas:document.querySelectorAll('textarea, [contenteditable="true"]').length}});const u=`Extraction failed: ${l} (Type: ${i instanceof Error?i.constructor.name:typeof i}, Time: ${a}ms)`;throw console.error(`[Engine] ${u}`),C({type:B,errorCode:"EXTRACTION_FAILED",payload:u}),i}},window.inspectDOMForSelectors=function(){const e={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1,zAiSpecific:{}},o=document.querySelectorAll("*");for(const E of o)if(E.shadowRoot){e.shadowDOMDetected=!0;break}const i={};try{i.responseFooters={".chat-assistant + div":document.querySelectorAll(".chat-assistant + div").length,".chat-assistant ~ div":document.querySelectorAll(".chat-assistant ~ div").length,'[class*="chat"] + div':document.querySelectorAll('[class*="chat"] + div').length,".chat-assistant":document.querySelectorAll(".chat-assistant").length},i.copyButtons={"button.copy-response-button":document.querySelectorAll("button.copy-response-button").length,'button[aria-label*="Copy" i]':document.querySelectorAll('button[aria-label*="Copy" i]').length,'button[title*="Copy" i]':document.querySelectorAll('button[title*="Copy" i]').length};const E=document.querySelectorAll(".chat-assistant");i.chatAssistantDetails=Array.from(E).map((m,_)=>{const b=m.nextElementSibling;return{index:_,hasNextSibling:b!==null,nextSiblingTag:b?.tagName||null,nextSiblingClass:b?.className||null,nextSiblingButtons:b?Array.from(b.querySelectorAll("button")).map(L=>({text:L.textContent?.substring(0,50),ariaLabel:L.getAttribute("aria-label"),className:L.className,id:L.id})):[]}});const g=Array.from(document.querySelectorAll("button")).filter(m=>{const _=m.closest(".chat-assistant"),b=m.closest(".chat-assistant + div, .chat-assistant ~ div");return _!==null||b!==null});i.buttonsNearChat=g.map(m=>({text:m.textContent?.substring(0,50),ariaLabel:m.getAttribute("aria-label"),className:m.className,id:m.id,parentClass:m.parentElement?.className||null}))}catch(E){i.error=String(E)}e.zAiSpecific=i;const l=["textarea[placeholder*='prompt']","input[placeholder*='prompt']","textarea","input[type='text']"],a={};for(const E of l)try{a[E]=document.querySelector(E),a[E]||(a[`${E} (shadow)`]=t(E))}catch{a[E]=null}e.allSelectorsTested.promptInput=a;const u=['button[aria-label*="Run"]','button[aria-label*="Send"]','button[type="submit"]',"button"],c={};for(const E of u)try{c[E]=document.querySelector(E),c[E]||(c[`${E} (shadow)`]=t(E))}catch{c[E]=null}e.allSelectorsTested.sendButton=c;const s=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));e.inputs=s.map(E=>{const g=E;return{tag:E.tagName.toLowerCase(),type:g.getAttribute("type")||"",placeholder:g.getAttribute("placeholder")||"",ariaLabel:g.getAttribute("aria-label")||"",id:E.id||"",className:E.className||"",contentEditable:g.contentEditable,visible:g.offsetParent!==null,inShadowDOM:!1}});const d=Array.from(document.querySelectorAll("button"));return e.buttons=d.map(E=>{const g=E;return{tag:E.tagName.toLowerCase(),ariaLabel:g.getAttribute("aria-label")||"",text:(g.innerText||"").substring(0,Lt),id:E.id||"",className:E.className||"",type:g.getAttribute("type")||"",visible:g.offsetParent!==null,inShadowDOM:!1}}),e},console.log("[Engine] Bridge script injected. Waiting for flutter_inappwebview..."),H()}})();
