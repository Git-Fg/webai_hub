(function(){"use strict";const g=["textarea[placeholder*='Start typing a prompt']","textarea[placeholder*='typing a prompt']","input[placeholder*='Start typing a prompt']","input[placeholder*='typing a prompt']","textarea[placeholder*='prompt']","input[placeholder*='prompt']","input-area","textarea[aria-label*='prompt']","textarea[name*='prompt']","textarea[id*='prompt']",".ql-editor","div[contenteditable='true']","textarea","input[type='text']"],b=['button[aria-label*="Append to prompt and run"]','button[aria-label*="Append to Prompt and run"]','button[aria-label*="run" i]','button[aria-label*="Run"]','send-button[variant="primary"]','button[aria-label*="Send"]','button:contains("Run")',".send-button button",'button[type="submit"]'],w=["response-container",".response-message",".message-response",".markdown",".response-content","[data-testid*='response']",".message-content"],h=['mat-icon[data-mat-icon-name="stop"]',".generating-indicator",".loading-indicator","[data-testid*='generating']",".spinner",".loading-spinner",".thinking-indicator"];function E(e,t,n=!1){try{const a=e.split(":contains")[0],i=document.querySelectorAll(a||"*");for(const s of i){const o=s.textContent||"",r=n?o:o.toLowerCase(),l=n?t:t.toLowerCase();if(r.includes(l))return s}}catch{}return null}function m(e,t=1e4){return new Promise((n,a)=>{let s=0;const o=setInterval(()=>{for(const r of e){let l=null;if(r.includes(":contains(")){const c=r.match(/^(.+):contains\(['"](.+)['"]\)$/);c&&c[1]&&c[2]&&(l=E(c[1],c[2]))}else try{l=document.querySelector(r),!l&&s===0&&console.log(`[waitForElement] Selector "${r}" not found on first attempt`)}catch(c){console.warn(`[waitForElement] Invalid selector "${r}":`,c);continue}if(l){console.log(`[waitForElement] Found element with selector "${r}"`),clearInterval(o),n(l);return}}s+=300,s>=t&&(clearInterval(o),a(new Error(`None of the selectors [${e.join(", ")}] found within ${t}ms`)))},300)})}function u(e){const t=window;t.flutter_inappwebview&&t.flutter_inappwebview.callHandler("automationBridge",e)}function y(){return{documentReadyState:document.readyState,hasFlutterBridge:!!window.flutter_inappwebview,hasStartAutomation:typeof window.startAutomation<"u",hasExtractFinalResponse:typeof window.extractFinalResponse<"u",url:window.location.href,timestamp:new Date().toISOString()}}function A(){const e=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]')),t=Array.from(document.querySelectorAll("button"));console.log("[DEBUG] Found inputs:",e.map(n=>({tag:n.tagName,type:n.getAttribute("type"),placeholder:n.getAttribute("placeholder"),ariaLabel:n.getAttribute("aria-label"),id:n.id,className:n.className,contentEditable:n.contentEditable}))),console.log("[DEBUG] Found buttons:",t.slice(0,10).map(n=>({tag:n.tagName,ariaLabel:n.getAttribute("aria-label"),text:n.innerText?.substring(0,50),id:n.id,className:n.className,type:n.getAttribute("type")})))}async function T(e){try{console.log("[startAutomation] Starting automation with prompt:",e.substring(0,50)),A(),console.log("[startAutomation] Waiting for input area...");const t=await m(g);if(console.log("[startAutomation] Found input area:",t.tagName,t.className),t.tagName==="TEXTAREA"||t.tagName==="INPUT"){const a=t;a.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}else if(t instanceof HTMLElement&&t.contentEditable==="true"){const a=t;a.innerText=e,t.dispatchEvent(new Event("input",{bubbles:!0}))}else{const a=t;a.click(),await new Promise(s=>setTimeout(()=>s(),500));const i=a;i.value!==void 0&&(i.value=e)}console.log("[startAutomation] Waiting for send button...");const n=await m(b);console.log("[startAutomation] Found send button:",n.tagName,n.className,n.getAttribute("aria-label")),n.click(),console.log("[startAutomation] Clicked send button"),await m(h,5e3),await new Promise(a=>{const i=h[0];if(!i){a();return}const s=new MutationObserver((r,l)=>{document.querySelector(i)||(u({type:"GENERATION_COMPLETE"}),l.disconnect(),clearTimeout(o),a())});s.observe(document.body,{childList:!0,subtree:!0});const o=setTimeout(()=>{s.disconnect(),u({type:"GENERATION_COMPLETE"}),a()},45e3)})}catch(t){const n=t instanceof Error?t.message:String(t),a={...y(),promptLength:e.length,promptPreview:e.length>50?e.substring(0,50)+"...":e};throw t instanceof Error&&t.message.includes("not found within")&&(a.errorType="ELEMENT_NOT_FOUND",a.timeoutReached=!0),u({type:"AUTOMATION_FAILED",payload:n,errorCode:"AUTOMATION_EXECUTION_FAILED",location:"startAutomation",diagnostics:a}),t}}async function S(){try{let e=[];for(const a of w){const i=Array.from(document.querySelectorAll(a));e.push(...i)}if(e.length===0&&(e=Array.from(document.querySelectorAll("*")).filter(i=>{const o=(i.innerText?.trim()||"").length>50,r=!i.matches("input, textarea, button, select, option"),l=i.offsetParent!==null;return o&&r&&l})),e.length===0)return(document.body?.innerText||"").trim()||"No response available";const t=e[e.length-1];return t?t.innerText?.trim()||"":"No last response element found, though the array was not empty."}catch(e){const t=e instanceof Error?e.message:String(e),n={...y(),responseContainerSelectors:w.length,foundResponseElements:0};throw u({type:"AUTOMATION_FAILED",payload:t,errorCode:"RESPONSE_EXTRACTION_FAILED",location:"extractFinalResponse",diagnostics:n}),e}}function N(){const e=window;if(e.flutter_inappwebview)try{e.flutter_inappwebview.callHandler("bridgeReady")}catch(t){console.warn("Failed to signal bridge ready:",t)}}function d(e=100,t=300){if(e<=0){console.warn("Bridge ready signal: max retries reached, giving up");return}if(window.flutter_inappwebview)try{N(),console.log("Bridge ready signal sent successfully")}catch(a){console.warn("Error sending bridge ready signal:",a),setTimeout(()=>d(e-1,t),t)}else setTimeout(()=>d(e-1,t),t)}function p(e,t=document){try{const n=t.querySelector(e);if(n)return n;const a=t.querySelectorAll("*");for(const i of a)if(i.shadowRoot){const s=p(e,i.shadowRoot);if(s)return s}}catch{}return null}function O(){const e={inputs:[],buttons:[],allSelectorsTested:{},shadowDOMDetected:!1},t=document.querySelectorAll("*");for(const o of t)if(o.shadowRoot){e.shadowDOMDetected=!0;break}const n={};for(const o of g)try{n[o]=document.querySelector(o),n[o]||(n[`${o} (shadow)`]=p(o))}catch{n[o]=null}e.allSelectorsTested.promptInput=n;const a={};for(const o of b)try{a[o]=document.querySelector(o),a[o]||(a[`${o} (shadow)`]=p(o))}catch{a[o]=null}e.allSelectorsTested.sendButton=a;const i=Array.from(document.querySelectorAll('input, textarea, [contenteditable="true"]'));e.inputs=i.map(o=>{const r=o;return{tag:o.tagName.toLowerCase(),type:r.getAttribute("type")||"",placeholder:r.getAttribute("placeholder")||"",ariaLabel:r.getAttribute("aria-label")||"",id:o.id||"",className:o.className||"",contentEditable:r.contentEditable,visible:r.offsetParent!==null,inShadowDOM:!1}});const s=Array.from(document.querySelectorAll("button"));return e.buttons=s.map(o=>{const r=o;return{tag:o.tagName.toLowerCase(),ariaLabel:r.getAttribute("aria-label")||"",text:(r.innerText||"").substring(0,100),id:o.id||"",className:o.className||"",type:o.getAttribute("type")||"",visible:r.offsetParent!==null,inShadowDOM:!1}}),e}const f=window;f.startAutomation=T,f.extractFinalResponse=S,f.inspectDOMForSelectors=O,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{d()}):d()})();
