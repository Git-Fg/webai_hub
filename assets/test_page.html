<!DOCTYPE html>
<html>
<head>
    <title>High-Fidelity Sandbox</title>
    <style>
        /* Styles basiques pour la visibilit√© */
        body { font-family: sans-serif; padding: 20px; }
        footer { border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-width: 800px; }
        .chat-container { border: 1px solid #eee; padding: 10px; min-height: 200px; max-width: 800px; }
        ms-chat-turn { display: block; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        ms-chat-turn[data-turn-role="User"] { background-color: #e1f5fe; }
        ms-chat-turn[data-turn-role="Model"] { background-color: #f1f8e9; }
        .thinking-progress-icon { display: none; }
        .thinking-progress-icon.in-progress { display: inline-block; animation: rotate 2s linear infinite; }
        mat-icon { display: inline-block; width: 24px; height: 24px; }
        mat-icon[data-mat-icon-name="stop"] { background-color: #f44336; border-radius: 50%; }
        .token-counter { margin-top: 5px; font-size: 12px; color: #666; }
        .turn-footer { margin-top: 10px; border-top: 1px solid #ddd; padding-top: 5px; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>High-Fidelity Sandbox</h1>
    
    <!-- Structure du Chat -->
    <div class="chat-container">
        <ms-chat-turn data-turn-role="User">
            <div class="author-label">User</div>
            <ms-cmark-node><p><span>This is a previous user message.</span></p></ms-cmark-node>
        </ms-chat-turn>
        <ms-chat-turn data-turn-role="Model">
            <div class="author-label">Model</div>
            <ms-cmark-node><p><span>This is an old AI response.</span></p></ms-cmark-node>
        </ms-chat-turn>
        <!-- Les nouvelles r√©ponses seront ajout√©es ici -->
        <div id="new-turns-container"></div>
    </div>
    
    <!-- Structure du Footer (zone de saisie) - Structure exacte d'AI Studio -->
    <footer>
        <ms-prompt-input-wrapper>
            <div class="prompt-input-wrapper-container">
                <div class="text-wrapper">
                    <!-- Structure hi√©rarchique exacte pour ms-chunk-input textarea -->
                    <ms-chunk-input>
                        <ms-text-chunk>
                            <ms-autosize-textarea>
                                <!-- 1. LE CHAMP DE SAISIE - doit √™tre trouvable par 'ms-chunk-input textarea' -->
                                <textarea placeholder="Start typing a prompt" aria-label="Start typing a prompt"></textarea>
                            </ms-autosize-textarea>
                        </ms-text-chunk>
                    </ms-chunk-input>
                </div>
                <div class="button-wrapper">
                    <!-- Structure exacte pour ms-run-button > button[aria-label="Run"] -->
                    <ms-run-button>
                        <!-- 2. LE BOUTON D'ENVOI -->
                        <button type="submit" aria-label="Run" class="run-button">
                            <mat-icon>arrow_upward_alt</mat-icon>
                        </button>
                    </ms-run-button>
                </div>
            </div>
            <!-- Compteur de tokens -->
            <div class="token-counter">
                <span class="v3-token-count-value">0</span> tokens
            </div>
        </ms-prompt-input-wrapper>
    </footer>

    <script>
        // S√©lection des √©l√©ments bas√©e sur la structure exacte d'AI Studio
        const textarea = document.querySelector("ms-chunk-input textarea") || 
                        document.querySelector("textarea[placeholder*='Start typing a prompt']");
        const runButton = document.querySelector("ms-run-button > button[aria-label='Run']") ||
                         document.querySelector("button[aria-label='Run']");
        const newTurnsContainer = document.getElementById('new-turns-container');
        const tokenCounter = document.querySelector('.v3-token-count-value');

        // Observer textarea pour compteur tokens
        textarea.addEventListener('input', () => {
            const tokenCount = Math.ceil(textarea.value.length / 4); // Approximation
            tokenCounter.textContent = tokenCount;
        });

        runButton.addEventListener('click', () => {
            console.log('[SANDBOX] Run button clicked.');
            const promptText = textarea.value;
            textarea.value = ''; // Vider le champ
            
            // 1. Ajouter le tour de l'utilisateur
            const userTurn = document.createElement('ms-chat-turn');
            userTurn.setAttribute('data-turn-role', 'User');
            // S'assurer que le texte est directement accessible via innerText sur ms-cmark-node
            const cmarkNode = document.createElement('ms-cmark-node');
            cmarkNode.innerHTML = `<p><span>${promptText}</span></p>`;
            // Ajouter le textContent pour garantir que innerText fonctionne
            userTurn.innerHTML = `
                <div class="author-label">User</div>
            `;
            userTurn.appendChild(cmarkNode);
            newTurnsContainer.appendChild(userTurn);
            console.log('[SANDBOX] User turn added with prompt:', promptText);
            
            // 2. Simuler la g√©n√©ration de la r√©ponse du mod√®le
            const modelTurn = document.createElement('ms-chat-turn');
            modelTurn.setAttribute('data-turn-role', 'Model');
            
            // Cr√©er l'indicateur de g√©n√©ration avec mat-icon[data-mat-icon-name="stop"]
            // C'est le s√©lecteur prioritaire dans GENERATION_INDICATOR_SELECTORS
            modelTurn.innerHTML = `
                <div class="author-label">Model</div>
                <!-- 3. L'INDICATEUR DE G√âN√âRATION - avec mat-icon pour le s√©lecteur prioritaire -->
                <ms-thought-chunk>
                    <mat-icon data-mat-icon-name="stop"></mat-icon>
                    <span class="thinking-progress-icon in-progress">Thinking...</span>
                </ms-thought-chunk>
            `;
            newTurnsContainer.appendChild(modelTurn);
            
            console.log('[SANDBOX] Generation started. mat-icon[data-mat-icon-name="stop"] visible.');
            
            // Simuler une attente
            setTimeout(() => {
                console.log('[SANDBOX] Generation complete.');
                const thoughtChunk = modelTurn.querySelector('ms-thought-chunk');
                const stopIcon = modelTurn.querySelector('mat-icon[data-mat-icon-name="stop"]');
                
                // Cacher l'indicateur (comme le fait AI Studio r√©el)
                if (stopIcon) {
                    stopIcon.style.display = 'none';
                    console.log('[SANDBOX] mat-icon[data-mat-icon-name="stop"] hidden.');
                }
                if (thoughtChunk) {
                    thoughtChunk.style.display = 'none';
                }
                
                // 4. LE CONTENEUR DE R√âPONSE FINAL - doit √™tre directement accessible via
                // ms-chat-turn[data-turn-role="Model"] ms-cmark-node (s√©lecteur prioritaire)
                const responseNode = document.createElement('ms-cmark-node');
                responseNode.innerHTML = `
                    <p><span>This is the high-fidelity response to: "${promptText}"</span></p>
                `;
                // Ajouter directement dans ms-chat-turn, pas dans un div interm√©diaire
                modelTurn.appendChild(responseNode);
                
                // 5. Ajouter le footer avec bouton pouce lev√©
                const footer = document.createElement('div');
                footer.className = 'turn-footer';
                footer.innerHTML = '<button iconname="thumb_up">üëç</button>';
                modelTurn.appendChild(footer);
                console.log('[SANDBOX] Footer added with button iconname="thumb_up"');
                
                console.log('[SANDBOX] Response added. Accessible via ms-chat-turn[data-turn-role="Model"] ms-cmark-node');
                
                // Notifier Flutter
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('automationBridge', { type: 'GENERATION_COMPLETE' });
                    console.log('[SANDBOX] Sent GENERATION_COMPLETE to Flutter.');
                }
            }, 2000);
        });
        
        // S'assurer que le textarea et le bouton sont disponibles d√®s le chargement
        console.log('[SANDBOX] Page loaded. Textarea found:', !!textarea);
        console.log('[SANDBOX] Run button found:', !!runButton);
    </script>
</body>
</html>
